(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{577:function(s,t,a){"use strict";a.r(t);var n=a(13),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"理论基础"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#理论基础"}},[s._v("#")]),s._v(" 理论基础")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://pic-new-1304161434.cos.ap-guangzhou.myqcloud.com/img/202311271502885.png",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"认证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#认证"}},[s._v("#")]),s._v(" 认证")]),s._v(" "),a("p",[s._v("如上图步骤1所示，建立TLS后，HTTP请求将进入认证（Authentication）步骤。认证模块包含客户端证书、密码、普通令牌、引导令牌等。可以指定多个认证模块，在这种情况下，服务器依次尝试每个验证模块，直到其中一个成功。")]),s._v(" "),a("h3",{attrs:{id:"授权"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#授权"}},[s._v("#")]),s._v(" 授权")]),s._v(" "),a("p",[s._v("如上图的步骤 2所示，将请求验证为来自特定的用户后，请求必须被鉴权。")]),s._v(" "),a("p",[s._v("请求必须包含请求者的用户名、请求的行为以及受该操作影响的对象。 如果现有策略声明用户有权完成请求的操作，那么该请求被鉴权通过。")]),s._v(" "),a("h3",{attrs:{id:"准入控制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准入控制"}},[s._v("#")]),s._v(" 准入控制")]),s._v(" "),a("p",[s._v("如上图的步骤 3所示，准入控制模块是可以修改或拒绝请求的软件模块。 除鉴权模块可用的属性外，准入控制模块还可以访问正在创建或修改的对象的内容。")]),s._v(" "),a("h2",{attrs:{id:"kubernetes中的账户"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes中的账户"}},[s._v("#")]),s._v(" Kubernetes中的账户")]),s._v(" "),a("p",[s._v("Kubernetes的账户类型有两种：User Account和Service Account")]),s._v(" "),a("h3",{attrs:{id:"user-account"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#user-account"}},[s._v("#")]),s._v(" User Account")]),s._v(" "),a("h4",{attrs:{id:"理论基础-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#理论基础-2"}},[s._v("#")]),s._v(" 理论基础")]),s._v(" "),a("p",[s._v("User Account是给使用人员用的，用于与API Server交互进行集群操作与管理。")]),s._v(" "),a("p",[s._v("使用HTTP 请求kubernetes API：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl proxy --port=8080")]),s._v("\nStarting to serve on "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:8080\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl http://localhost:8080/api/v1/namespaces")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kind"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"NamespaceList"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v1"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metadata"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"selfLink"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/api/v1/namespaces"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resourceVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3866057"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("Kubernetes 使用身份认证插件利用客户端证书、持有者令牌（Bearer Token）、身份认证代理（Proxy） 或者 HTTP 基本认证机制来认证 API 请求的身份。")]),s._v(" "),a("h3",{attrs:{id:"x509客户端证书认证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#x509客户端证书认证"}},[s._v("#")]),s._v(" X509客户端证书认证")]),s._v(" "),a("p",[s._v("为了让普通用户能够通过认证并调用 API，需要执行一下几个步骤。")]),s._v(" "),a("p",[s._v("首先，该用户必须拥有 Kubernetes 集群签发的证书， 然后将该证书作为 API 调用的 Certificate 头或通过 kubectl 提供。")]),s._v(" "),a("p",[s._v("1） 创建私钥")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl genrsa -out user1.key 2048")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("2） 创建CSR")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("openssl req -new -key user1.key -out user1.csr -subj "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/CN=user1/O=kubernetes"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("注： 以下步骤为使用CA证书签名，如果无法访问CA证书，也可以替换为步骤3、4直接使用在集群中签名，任选其一")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## SCP user1.csr到master节点")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# scp user1.csr master:/etc/kubernetes/pki/")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 登录到master节点，签名证书")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pwd")]),s._v("\n/etc/kubernetes/pki\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl x509 -req -in user1.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out user1.crt")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 将生成的crt证书 copy 回clientvm")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master pki"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# scp user1.crt clientvm:/root/")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("3） 证书签名")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# cat user1.csr | base64 | tr -d "\\n"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#替换入下文件中的request内容")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat  user1-csr.yaml")]),s._v("\napiVersion: certificates.k8s.io/v1\nkind: CertificateSigningRequest\nmetadata:\n  name: user1\nspec:\n  groups:\n  - system:authenticated\n  request: NEED TO REPLACE\n  signerName: kubernetes.io/kube-apiserver-client\n  usages:\n  - client auth\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("4）签名，获取证书")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f user1-csr.yaml")]),s._v("\ncertificatesigningrequest.certificates.k8s.io/user1 created\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get csr")]),s._v("\nNAME    AGE   SIGNERNAME                            REQUESTOR          CONDITION\nuser1   18s   kubernetes.io/kube-apiserver-client   kubernetes-admin   Pending\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl certificate approve user1")]),s._v("\ncertificatesigningrequest.certificates.k8s.io/user1 approved\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get csr/user1 -o yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 证书的内容使用 base64 编码，存放在字段 status.certificate")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#保存status.certificate内容到一个文件aaa，生成证书 crt")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat aaa |base64 --decode >user1.crt")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("5） 添加user1到kubeconfig")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl config set-credentials user1 --client-key=user1.key --client-certificate=user1.crt --embed-certs=true ")]),s._v("\nUser "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user1"')]),s._v(" set.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("6）添加上下文")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl config get-contexts")]),s._v("\nCURRENT   NAME                         CLUSTER     AUTHINFO           NAMESPACE\n*         kubernetes-admin@mycluster   mycluster   kubernetes-admin\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl config set-context user1@mycluster --cluster=mycluster --user=user1")]),s._v("\nContext "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user1@mycluster"')]),s._v(" created.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("7） 把上下文切换为user1")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl config use-context user1@mycluster")]),s._v("\nSwitched to context "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user1@mycluster"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##此处报权限错误是因为只做了认证，还没有授权")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod")]),s._v("\nError from server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Forbidden"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": pods is forbidden: User "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user1"')]),s._v(" cannot list resource "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pods"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" API group "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" the namespace "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h3",{attrs:{id:"管理配置上下文"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#管理配置上下文"}},[s._v("#")]),s._v(" 管理配置上下文")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://pic-new-1304161434.cos.ap-guangzhou.myqcloud.com/img/202311271546832.png",alt:""}})]),s._v(" "),a("h4",{attrs:{id:"基本步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基本步骤"}},[s._v("#")]),s._v(" 基本步骤")]),s._v(" "),a("h5",{attrs:{id:"添加用户"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加用户"}},[s._v("#")]),s._v(" 添加用户")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("kubectl config set-credentials -h\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#使用token方式配置账户登录：")]),s._v("\nkubectl config set-credentials user --token"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h5",{attrs:{id:"添加-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加-cluster"}},[s._v("#")]),s._v(" 添加 cluster")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("kubectl config set-cluster -h\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h5",{attrs:{id:"添加-context"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加-context"}},[s._v("#")]),s._v(" 添加 context")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("kubectl config set-context\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h5",{attrs:{id:"切换使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#切换使用"}},[s._v("#")]),s._v(" 切换使用")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl config current-context")]),s._v("\nkubernetes-admin@kubernetes\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl config use-context kubernetes-admin@kubernetes")]),s._v("\nSwitched to context "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubernetes-admin@kubernetes"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl config get-contexts")]),s._v("\nCURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE\n*         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin\n          user1@kubernetes              kubernetes   user1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h3",{attrs:{id:"合并多个kubeconfig"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#合并多个kubeconfig"}},[s._v("#")]),s._v(" 合并多个kubeconfig")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("KUBECONFIG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=~")]),s._v("/myk8s.txt:~/kubeconfig-new-version.txt\nkubectl config view --flatten "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(".kube/config\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#结果")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cse-server ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl config get-contexts")]),s._v("\nCURRENT   NAME                            CLUSTER       AUTHINFO            NAMESPACE\n*         myk8s-admin@myk8s               myk8s         myk8s-admin\n          new-version-admin@new-version   new-version   new-version-admin\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h2",{attrs:{id:"service-account"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#service-account"}},[s._v("#")]),s._v(" Service Account")]),s._v(" "),a("p",[s._v("当你（自然人）访问集群时（例如，使用 "),a("code",[s._v("kubectl")]),s._v("），API 服务器将你的身份验证为 特定的用户帐户（当前这通常是 "),a("code",[s._v("admin")]),s._v("，除非你的集群管理员已经定制了你的集群配置）。 Pod 内的容器中的进程也可以与 api 服务器接触。 当它们进行身份验证时，它们被验证为特定的服务帐户（例如，"),a("code",[s._v("default")]),s._v("）")]),s._v(" "),a("p",[s._v("服务账号通常由 API 服务器自动创建并通过 "),a("code",[s._v("ServiceAccount")]),s._v(" "),a("a",{attrs:{href:"https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/",target:"_blank",rel:"noopener noreferrer"}},[s._v("准入控制器"),a("OutboundLink")],1),s._v(" 关联到集群中运行的 Pod 上。 相关Token会挂载到 Pod 中可预知的位置，允许集群内进程与 API 服务器通信。")]),s._v(" "),a("p",[s._v("当你创建 Pod 时，如果没有指定服务账户，Pod 会被指定给命名空间中的 "),a("code",[s._v("default")]),s._v(" 服务账户。 也可以在Pod中添加serviceAccountName明确指定SA。")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod nginx2 -o yaml | grep -i serviceaccount")]),s._v("\n    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount\n  serviceAccount: default\n  serviceAccountName: default\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#创建SA")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create serviceaccount -h")]),s._v("\nCreate a "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" account with the specified name.\n\nAliases:\nserviceaccount, sa\n\nExamples:\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Create a new service account named my-service-account")]),s._v("\n  kubectl create serviceaccount my-service-account\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#1.23版本之前，创建SA后，系统会自动创建一个token； 1.24版本以后，已经不会自动创建。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get sa,secret -n mytest")]),s._v("\nNAME                     SECRETS   AGE\nserviceaccount/default   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         18d\nserviceaccount/my-sa     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         15s\n\nNAME                         TYPE                                  DATA   AGE\nsecret/default-token-64sch   kubernetes.io/service-account-token   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("      18d\nsecret/my-sa-token-w6d7f     kubernetes.io/service-account-token   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("      15s\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get serviceaccounts my-sa -n mytest  -o yaml")]),s._v("\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  creationTimestamp: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2020-12-16T05:24:27Z"')]),s._v("\n  name: my-sa\n  namespace: mytest\n  resourceVersion: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"4060881"')]),s._v("\n  selfLink: /api/v1/namespaces/mytest/serviceaccounts/my-sa\n  uid: 85bd0753-5ebf-4c5f-8046-5dbd4391f739\nsecrets:\n- name: my-sa-token-w6d7f\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#从私有镜像仓库获取镜像")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#在Pod中引入ImagePullSecrets")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pod.yaml")]),s._v("\napiVersion: v1\nkind: Pod\nmetadata:\n  name: foo\n  namespace: awesomeapps\nspec:\n  containers:\n    - name: foo\n      image: janedoe/awesomeapp:v1\n  imagePullSecrets:\n    - name: myregistryke\n    \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#添加 docker-registry 类似的secret到default SA")]),s._v("\nkubectl create secret docker-registry myregistrykey --docker-server"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("DUMMY_SERVER "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n          --docker-username"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("DUMMY_USERNAME --docker-password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("DUMMY_DOCKER_PASSWORD\n\nkubectl patch serviceaccount default -p "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"imagePullSecrets": [{"name": "myregistrykey"}]}\'')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br")])]),a("h3",{attrs:{id:"rbac授权"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rbac授权"}},[s._v("#")]),s._v(" RBAC授权")]),s._v(" "),a("p",[s._v("基于角色（Role）的访问控制（RBAC）是一种基于组织中用户的角色来调节控制对 计算机或网络资源的访问的方法。")]),s._v(" "),a("p",[s._v("RBAC 鉴权机制使用 "),a("code",[s._v("rbac.authorization.k8s.io")]),s._v(" "),a("a",{attrs:{href:"https://kubernetes.io/zh/docs/concepts/overview/kubernetes-api/#api-groups",target:"_blank",rel:"noopener noreferrer"}},[s._v("API 组"),a("OutboundLink")],1),s._v(" 来驱动鉴权决定，允许你通过 Kubernetes API 动态配置策略。")]),s._v(" "),a("p",[s._v("要启用 RBAC，在启动 "),a("a",{attrs:{href:"https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/",target:"_blank",rel:"noopener noreferrer"}},[s._v("API 服务器"),a("OutboundLink")],1),s._v(" 时将 "),a("code",[s._v("--authorization-mode")]),s._v(" 参数设置为一个逗号分隔的列表并确保其中包含 "),a("code",[s._v("RBAC")])]),s._v(" "),a("p",[s._v("RBAC API 声明了四种 Kubernetes 对象："),a("em",[s._v("Role")]),s._v("、"),a("em",[s._v("ClusterRole")]),s._v("、"),a("em",[s._v("RoleBinding")]),s._v(" 和 "),a("em",[s._v("ClusterRoleBinding")]),s._v("。")]),s._v(" "),a("h3",{attrs:{id:"role-和-clusterrole"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#role-和-clusterrole"}},[s._v("#")]),s._v(" Role 和 ClusterRole")]),s._v(" "),a("p",[s._v("RBAC 的 Role 或 ClusterRole 中包含一组代表相关权限的规则。 这些权限是纯粹累加的（不存在拒绝某操作的规则）。")]),s._v(" "),a("p",[s._v("Role 总是用来在某个"),a("a",{attrs:{href:"https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/namespaces/",target:"_blank",rel:"noopener noreferrer"}},[s._v("名字空间"),a("OutboundLink")],1),s._v(" 内设置访问权限；在你创建 Role 时，你必须指定该 Role 所属的名字空间。")]),s._v(" "),a("p",[s._v("与之相对，ClusterRole 则是一个集群作用域的资源。这两种资源的名字不同（Role 和 ClusterRole）是因为 Kubernetes 对象要么是名字空间作用域的，要么是集群作用域的， 不可两者兼具。")]),s._v(" "),a("p",[s._v("如果你希望在名字空间内定义角色，应该使用 Role")]),s._v(" "),a("p",[s._v("如果你希望定义集群范围的角色，应该使用 ClusterRole。")]),s._v(" "),a("div",{staticClass:"language-txt line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-txt"}},[a("code",[s._v('#role可包含的操作有\n"get", "list", "watch", "create", "update", "patch", "delete"\n\n#role常用可操作资源有：Pods, ConfigMaps, Deploments, Nodes, Secrets, Namespaces\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h4",{attrs:{id:"核心组件角色"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心组件角色"}},[s._v("#")]),s._v(" 核心组件角色")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("默认 ClusterRole")]),s._v(" "),a("th",[s._v("默认 ClusterRoleBinding")]),s._v(" "),a("th",[s._v("描述")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[a("strong",[s._v("cluster-admin")])]),s._v(" "),a("td",[a("strong",[s._v("system:masters")]),s._v(" 组")]),s._v(" "),a("td",[s._v("允许超级用户在平台上的任何资源上执行所有操作。 当在 "),a("strong",[s._v("ClusterRoleBinding")]),s._v(" 中使用时，可以授权对集群中以及所有名字空间中的全部资源进行完全控制。 当在 "),a("strong",[s._v("RoleBinding")]),s._v(" 中使用时，可以授权控制 RoleBinding 所在名字空间中的所有资源，包括名字空间本身。")])]),s._v(" "),a("tr",[a("td",[a("strong",[s._v("admin")])]),s._v(" "),a("td",[s._v("无")]),s._v(" "),a("td",[s._v("允许管理员访问权限，旨在使用 "),a("strong",[s._v("RoleBinding")]),s._v(" 在名字空间内执行授权。 如果在 "),a("strong",[s._v("RoleBinding")]),s._v(" 中使用，则可授予对名字空间中的大多数资源的读/写权限， 包括创建角色和角色绑定的能力。 但是它不允许对资源配额或者名字空间本身进行写操作。")])]),s._v(" "),a("tr",[a("td",[a("strong",[s._v("edit")])]),s._v(" "),a("td",[s._v("无")]),s._v(" "),a("td",[s._v("允许对名字空间的大多数对象进行读/写操作。 它不允许查看或者修改角色或者角色绑定。 不过，此角色可以访问 Secret，以名字空间中任何 ServiceAccount 的身份运行 Pods， 所以可以用来了解名字空间内所有服务账号的 API 访问级别。")])])])]),s._v(" "),a("h4",{attrs:{id:"role范例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#role范例"}},[s._v("#")]),s._v(" Role范例")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create role -h")]),s._v("\nUsage:\n  kubectl create role NAME --verb"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("verb --resource"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("resource.group/subresource "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--resource-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("resourcename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--dry-run"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("server"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nExamples:\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# Create a Role named "pod-reader" that allows user to perform "get", "watch" and "list" on pods')]),s._v("\n  kubectl create role pod-reader --verb"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("get --verb"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("list --verb"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("watch --resource"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pods\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# Create a Role named "pod-reader" with ResourceName specified')]),s._v("\n  kubectl create role pod-reader --verb"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("get --resource"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pods --resource-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("readablepod --resource-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("anotherpod\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# Create a Role named "foo" with API Group specified')]),s._v("\n  kubectl create role foo --verb"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("get,list,watch --resource"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("rs.extensions\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# Create a Role named "foo" with SubResource specified')]),s._v("\n  kubectl create role foo --verb"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("get,list,watch --resource"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pods,pods/status\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat role-example.yaml")]),s._v("\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  namespace: mytest\n  name: pod-reader\nrules:\n- apiGroups: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# "" 标明 core API 组')]),s._v("\n  resources: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pods"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  verbs: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"get"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"watch"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"list"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f role-example.yaml")]),s._v("\nrole.rbac.authorization.k8s.io/pod-reader created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])]),a("h4",{attrs:{id:"clusterrole范例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#clusterrole范例"}},[s._v("#")]),s._v(" ClusterRole范例")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create clusterrole -h")]),s._v("\nUsage:\n  kubectl create clusterrole NAME --verb"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("verb --resource"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("resource.group "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--resource-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("resourcename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--dry-run"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("server"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nExamples:\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# Create a ClusterRole named "pod-reader" that allows user to perform "get", "watch" and "list" on pods')]),s._v("\n  kubectl create clusterrole pod-reader --verb"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("get,list,watch --resource"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pods\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# Create a ClusterRole named "pod-reader" with ResourceName specified')]),s._v("\n  kubectl create clusterrole pod-reader --verb"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("get --resource"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pods --resource-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("readablepod\n--resource-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("anotherpod\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# Create a ClusterRole named "foo" with API Group specified')]),s._v("\n  kubectl create clusterrole foo --verb"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("get,list,watch --resource"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("rs.extensions\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# Create a ClusterRole named "foo" with SubResource specified')]),s._v("\n  kubectl create clusterrole foo --verb"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("get,list,watch --resource"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pods,pods/status\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# Create a ClusterRole name "foo" with NonResourceURL specified')]),s._v("\n  kubectl create clusterrole "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"foo"')]),s._v(" --verb"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("get --non-resource-url"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/logs/*\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# Create a ClusterRole name "monitoring" with AggregationRule specified')]),s._v("\n  kubectl create clusterrole monitoring --aggregation-rule"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rbac.example.com/aggregate-to-monitoring=true"')]),s._v("\n  \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat clusterrole-example.yaml")]),s._v("\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: secret-reader\nrules:\n- apiGroups: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 在 HTTP 层面，用来访问 Secret 对象的资源的名称为 "secrets"')]),s._v("\n  resources: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"secrets"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  verbs: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"get"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"watch"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"list"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f clusterrole-example.yaml")]),s._v("\nclusterrole.rbac.authorization.k8s.io/secret-reader created\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get role -n mytest")]),s._v("\nNAME         CREATED AT\npod-reader   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-12-16T04:41:56Z\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get clusterrole | grep secret")]),s._v("\nsecret-reader                                                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-12-16T04:44:26Z\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br")])]),a("h3",{attrs:{id:"rolebinding-和-clusterrolebinding"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rolebinding-和-clusterrolebinding"}},[s._v("#")]),s._v(" RoleBinding 和 ClusterRoleBinding")]),s._v(" "),a("p",[s._v("角色绑定（Role Binding）是将角色中定义的权限赋予一个或者一组用户。RoleBinding 在指定的名字空间中执行授权，而 ClusterRoleBinding 在集群范围执行授权。")]),s._v(" "),a("p",[s._v("一个 RoleBinding 可以引用同一的名字空间中的任何 Role。 或者，一个 RoleBinding 可以引用某 ClusterRole 并将该 ClusterRole 绑定到 RoleBinding 所在的名字空间。 如果你希望将某 ClusterRole 绑定到集群中所有名字空间，你要使用 ClusterRoleBinding。")]),s._v(" "),a("h4",{attrs:{id:"rolebinding-范例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rolebinding-范例"}},[s._v("#")]),s._v(" RoleBinding 范例")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create rolebinding -h")]),s._v("\nUsage:\n  kubectl create rolebinding NAME --clusterrole"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("--role"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NAME "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--group"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("groupname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--serviceaccount"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("namespace:serviceaccountname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--dry-run"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("server"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nExamples:\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Create a RoleBinding for user1, user2, and group1 using the admin ClusterRole")]),s._v("\n  kubectl create rolebinding admin --clusterrole"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("admin --user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("user1 --user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("user2 --group"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("group1\n  \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#将clusterrole admin 绑定到之前创建的user account user1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create rolebinding admin-to-user1 --clusterrole=admin --user=user1")]),s._v("\nrolebinding.rbac.authorization.k8s.io/admin-to-user1 created\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl --context=user1 get pod")]),s._v("\nNAME                     READY   STATUS      RESTARTS   AGE\nnginx-taint              "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          37h\nnginx2                   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4d20h\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("h4",{attrs:{id:"clusterrolebinding-范例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#clusterrolebinding-范例"}},[s._v("#")]),s._v(" ClusterRoleBinding 范例")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create clusterrolebinding -h")]),s._v("\nUsage:\n  kubectl create clusterrolebinding NAME --clusterrole"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NAME "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--group"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("groupname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--serviceaccount"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("namespace:serviceaccountname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--dry-run"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("server"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nExamples:\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Create a ClusterRoleBinding for user1, user2, and group1 using the cluster-admin ClusterRole")]),s._v("\n  kubectl create clusterrolebinding cluster-admin --clusterrole"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cluster-admin --user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("user1 --user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("user2 --group"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("group1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h2",{attrs:{id:"准入控制-admission-controllers"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准入控制-admission-controllers"}},[s._v("#")]),s._v(" 准入控制(Admission Controllers)")]),s._v(" "),a("p",[s._v("英文：")]),s._v(" "),a("p",[s._v("https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-does-each-admission-controller-do")]),s._v(" "),a("p",[s._v("中文：")]),s._v(" "),a("p",[s._v("https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#启用额外的准入控制器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grep admission ./kube-apiserver.yaml")]),s._v("\n    - --enable-admission-plugins"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NodeRestriction\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#关闭准入控制器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#添加如下参数")]),s._v("\n --disable-admission-plugins"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("PodNodeSelector,AlwaysDeny "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#默认启用的控制器")]),s._v("\nNamespaceLifecycle, LimitRanger, ServiceAccount, TaintNodesByCondition, Priority, DefaultTolerationSeconds, DefaultStorageClass, StorageObjectInUseProtection, PersistentVolumeClaimResize, RuntimeClass, CertificateApproval, CertificateSigning, CertificateSubjectRestriction, DefaultIngressClass, MutatingAdmissionWebhook, ValidatingAdmissionWebhook, ResourceQuota\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h2",{attrs:{id:"网络策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网络策略"}},[s._v("#")]),s._v(" 网络策略")]),s._v(" "),a("h3",{attrs:{id:"理论基础-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#理论基础-3"}},[s._v("#")]),s._v(" 理论基础")]),s._v(" "),a("p",[s._v("如果你希望在 IP 地址或端口层面（OSI 第 3 层或第 4 层）控制网络流量， 则你可以考虑为集群中特定应用使用 Kubernetes 网络策略（NetworkPolicy）。 NetworkPolicy 是一种以应用为中心的结构，允许你设置如何允许 "),a("a",{attrs:{href:"https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Pod"),a("OutboundLink")],1),s._v(" 与网络上的各类网络“实体” 通信。")]),s._v(" "),a("p",[s._v("Pod 可以通信的 Pod 是通过如下三个标识符的组合来辩识的：")]),s._v(" "),a("ol",[a("li",[s._v("其他被允许的 Pods（例外：Pod 无法阻塞对自身的访问）")]),s._v(" "),a("li",[s._v("被允许的名字空间")]),s._v(" "),a("li",[s._v("IP 组块（例外：与 Pod 运行所在的节点的通信总是被允许的， 无论 Pod 或节点的 IP 地址）")])]),s._v(" "),a("p",[s._v("在定义基于 Pod 或名字空间的 NetworkPolicy 时，你会使用 "),a("a",{attrs:{href:"https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/labels/",target:"_blank",rel:"noopener noreferrer"}},[s._v("选择算符"),a("OutboundLink")],1),s._v(" 来设定哪些流量 可以进入或离开与该算符匹配的 Pod。 当基于 IP 的 NetworkPolicy 被创建时，我们基于 IP 组块（CIDR 范围） 来定义策略。")]),s._v(" "),a("p",[s._v("网络策略通过"),a("a",{attrs:{href:"https://kubernetes.io/zh/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/",target:"_blank",rel:"noopener noreferrer"}},[s._v("网络插件"),a("OutboundLink")],1),s._v(" 来实现。要使用网络策略，你必须使用支持 NetworkPolicy 的网络解决方案。")]),s._v(" "),a("h3",{attrs:{id:"语法说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#语法说明"}},[s._v("#")]),s._v(" 语法说明")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("network"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" db\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##1）对default NameSpace中包含标签role=db的Pod做控制")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Ingress\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Egress\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##2）控制出入流量，未明确指定都是拒绝")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ipBlock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cidr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.17.0.0/16\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("except")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 172.17.1.0/24\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##3）允许的网段，例外网段 ")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaceSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("project")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" myproject\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##4）允许的NameSpace")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" frontend\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##5）允许的Pod")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##6) 定义被访问的端口")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("egress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("to")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ipBlock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cidr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10.0.0.0/24\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5978")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('##7）允许要控制的Pod访问哪个  "网段：端口" 的流量')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br")])]),a("p",[s._v("注意From和To的行为")]),s._v(" "),a("p",[s._v("表示交集，and 运算")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaceSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" alice\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" client\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("表示并集，or 运算")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaceSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" alice\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" client\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h3",{attrs:{id:"默认策略-拒绝所有进入流量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#默认策略-拒绝所有进入流量"}},[s._v("#")]),s._v(" 默认策略：拒绝所有进入流量")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("deny"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ingress\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Ingress\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h3",{attrs:{id:"默认策略-允许所有进入流量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#默认策略-允许所有进入流量"}},[s._v("#")]),s._v(" 默认策略：允许所有进入流量")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" allow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("all"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ingress\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Ingress\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h3",{attrs:{id:"范例1-允许指定网段的入站流量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#范例1-允许指定网段的入站流量"}},[s._v("#")]),s._v(" 范例1： 允许指定网段的入站流量")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat deny-all-except.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deny"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ingress"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("except\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx1\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Ingress\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ipBlock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cidr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10.244.0.0/16\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("except")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 10.244.102.0/24\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ipBlock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cidr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.241.0/24\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod --show-labels -o wide")]),s._v("\nNAME             READY   STATUS    RESTARTS   AGE     IP               NODE                  NOMINATED NODE   READINESS GATES   LABELS\nbusybox          1/1     Running   0          5m23s   10.244.102.144   worker1.example.com   <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("           <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("            run=busybox\nnginx1           1/1     Running   0          10h     10.244.71.195    worker2.example.com   <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("           <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("            run=nginx1\nnginx2           1/1     Running   0          10h     10.244.71.196    worker2.example.com   <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("           <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("            run=nginx2\nnginx3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("default   1/1     Running   0          8h      10.244.102.133   worker1.example.com   <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("           <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("            run=nginx3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip a | grep 192")]),s._v("\n    inet 192.168.241.129/24 brd 192.168.241.255 scope global eth0\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 10.244.71.195")]),s._v("\nPING 10.244.71.195 (10.244.71.195) 56(84) bytes of data.\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("64 bytes from 10.244.71.195")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" icmp_seq=1 ttl=63 time=0.484 ms\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("64 bytes from 10.244.71.195")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" icmp_seq=2 ttl=63 time=0.276 ms\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("64 bytes from 10.244.71.195")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" icmp_seq=3 ttl=63 time=0.217 ms\n^C\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v(" 10.244.71.195 ping statistics "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl run busybox --image=busybox --image-pull-policy=IfNotPresent -- sleep 10000")]),s._v("\npod/busybox created\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod -o wide")]),s._v("\nNAME             READY   STATUS    RESTARTS   AGE   IP               NODE                  NOMINATED NODE   READINESS GATES\nbusybox          1/1     Running   0          10s   10.244.102.144   worker1.example.com   <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("           <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\nnginx1           1/1     Running   0          10h   10.244.71.195    worker2.example.com   <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("           <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\nnginx2           1/1     Running   0          10h   10.244.71.196    worker2.example.com   <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("           <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\nnginx3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("default   1/1     Running   0          8h    10.244.102.133   worker1.example.com   <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("           <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec busybox -it -- sh")]),s._v("\n/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 10.244.71.195")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("PING 10.244.71.195 (10.244.71.195)")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 56 data bytes\n^C\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v(" 10.244.71.195 ping statistics "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n5 packets transmitted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 0 packets received"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 100% packet loss\n/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 10.244.71.196")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("PING 10.244.71.196 (10.244.71.196)")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 56 data bytes\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("64 bytes from 10.244.71.196")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" seq=0 ttl=62 time=0.547 ms\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("64 bytes from 10.244.71.196")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" seq=1 ttl=62 time=0.341 ms\n^C\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v(" 10.244.71.196 ping statistics "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br")])]),a("h3",{attrs:{id:"范例2-允许到指定端口的出站流量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#范例2-允许到指定端口的出站流量"}},[s._v("#")]),s._v(" 范例2： 允许到指定端口的出站流量")]),s._v(" "),a("p",[s._v("目的：Pod Nginx1可以访问namespace内的Pod的80端口，不允许访问其他")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat allow-egress-to-port.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deny"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ingress"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("except\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx1\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Egress\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("egress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("to")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaceSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" myapp\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod -o wide -n mytest")]),s._v("\nNAME      READY   STATUS    RESTARTS   AGE   IP              NODE                  NOMINATED NODE   READINESS GATES\nnginxaa   1/1     Running   0          10m   10.244.71.200   worker2.example.com   <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("           <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod -o wide")]),s._v("\nNAME             READY   STATUS    RESTARTS   AGE   IP               NODE                  NOMINATED NODE   READINESS GATES\nbusybox          1/1     Running   0          33m   10.244.102.144   worker1.example.com   <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("           <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\nnginx1           1/1     Running   0          10h   10.244.71.195    worker2.example.com   <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("           <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clientvm ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec nginx1 -it -- bash")]),s._v("\nroot@nginx1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\nroot@nginx1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 10.244.71.200")]),s._v("\n^C\nroot@nginx1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 10.244.71.195")]),s._v("\nAAAAAA\nroot@nginx1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# exit")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);