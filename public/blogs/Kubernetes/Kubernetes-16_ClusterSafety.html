<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>K8S-16_集群安全9（ClusterSafety） | Yim&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="blog">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.cdd75a34.css" as="style"><link rel="preload" href="/assets/js/app.3d0db68d.js" as="script"><link rel="preload" href="/assets/js/3.ac09d9ae.js" as="script"><link rel="preload" href="/assets/js/1.13123cf3.js" as="script"><link rel="preload" href="/assets/js/29.8bce1e85.js" as="script"><link rel="prefetch" href="/assets/js/10.71148249.js"><link rel="prefetch" href="/assets/js/11.02962130.js"><link rel="prefetch" href="/assets/js/12.3df1cf0d.js"><link rel="prefetch" href="/assets/js/13.b2de3019.js"><link rel="prefetch" href="/assets/js/14.3b87a9d5.js"><link rel="prefetch" href="/assets/js/15.504d16c3.js"><link rel="prefetch" href="/assets/js/16.ca26a4dc.js"><link rel="prefetch" href="/assets/js/17.d54f08aa.js"><link rel="prefetch" href="/assets/js/18.6b020389.js"><link rel="prefetch" href="/assets/js/19.88392a31.js"><link rel="prefetch" href="/assets/js/20.3125eccb.js"><link rel="prefetch" href="/assets/js/21.dfed3a18.js"><link rel="prefetch" href="/assets/js/22.5a68ef20.js"><link rel="prefetch" href="/assets/js/23.bfad051c.js"><link rel="prefetch" href="/assets/js/24.d8ae4110.js"><link rel="prefetch" href="/assets/js/25.5e2e1ca4.js"><link rel="prefetch" href="/assets/js/26.e52f34f8.js"><link rel="prefetch" href="/assets/js/27.386860c5.js"><link rel="prefetch" href="/assets/js/28.3c3b70ad.js"><link rel="prefetch" href="/assets/js/30.5fb2a9c5.js"><link rel="prefetch" href="/assets/js/31.b121a647.js"><link rel="prefetch" href="/assets/js/32.15dd9c1d.js"><link rel="prefetch" href="/assets/js/33.a05caae8.js"><link rel="prefetch" href="/assets/js/34.19ea07a3.js"><link rel="prefetch" href="/assets/js/35.243fd909.js"><link rel="prefetch" href="/assets/js/36.57fb68d0.js"><link rel="prefetch" href="/assets/js/37.8f55249b.js"><link rel="prefetch" href="/assets/js/38.fa8872b3.js"><link rel="prefetch" href="/assets/js/39.05d8d304.js"><link rel="prefetch" href="/assets/js/4.eeea3666.js"><link rel="prefetch" href="/assets/js/40.47797ab1.js"><link rel="prefetch" href="/assets/js/41.3a97dab1.js"><link rel="prefetch" href="/assets/js/42.f2502f68.js"><link rel="prefetch" href="/assets/js/43.e0eb01a1.js"><link rel="prefetch" href="/assets/js/44.ba3d7370.js"><link rel="prefetch" href="/assets/js/45.4cf6ed95.js"><link rel="prefetch" href="/assets/js/46.00396b53.js"><link rel="prefetch" href="/assets/js/47.9b4019b0.js"><link rel="prefetch" href="/assets/js/48.06490865.js"><link rel="prefetch" href="/assets/js/49.7b7988d8.js"><link rel="prefetch" href="/assets/js/5.3277b780.js"><link rel="prefetch" href="/assets/js/50.398002d7.js"><link rel="prefetch" href="/assets/js/51.7f7ef660.js"><link rel="prefetch" href="/assets/js/52.64d27b2c.js"><link rel="prefetch" href="/assets/js/53.934c3518.js"><link rel="prefetch" href="/assets/js/54.8ce73a1d.js"><link rel="prefetch" href="/assets/js/55.2e3ca8ba.js"><link rel="prefetch" href="/assets/js/56.74ff610b.js"><link rel="prefetch" href="/assets/js/57.235b1d16.js"><link rel="prefetch" href="/assets/js/58.8eff6c8a.js"><link rel="prefetch" href="/assets/js/59.16976c79.js"><link rel="prefetch" href="/assets/js/6.8b37b343.js"><link rel="prefetch" href="/assets/js/60.f11cf3ca.js"><link rel="prefetch" href="/assets/js/61.50ad1212.js"><link rel="prefetch" href="/assets/js/62.e1ebf578.js"><link rel="prefetch" href="/assets/js/63.d951552d.js"><link rel="prefetch" href="/assets/js/64.c80f4ec7.js"><link rel="prefetch" href="/assets/js/65.2e4a5cde.js"><link rel="prefetch" href="/assets/js/66.9f81993f.js"><link rel="prefetch" href="/assets/js/67.fd4b62d2.js"><link rel="prefetch" href="/assets/js/68.32949334.js"><link rel="prefetch" href="/assets/js/69.9bfe82c3.js"><link rel="prefetch" href="/assets/js/7.cacb4248.js"><link rel="prefetch" href="/assets/js/70.9974d044.js"><link rel="prefetch" href="/assets/js/71.699525d0.js"><link rel="prefetch" href="/assets/js/72.53ba0362.js"><link rel="prefetch" href="/assets/js/73.4e5e2f69.js"><link rel="prefetch" href="/assets/js/74.67070a8b.js"><link rel="prefetch" href="/assets/js/8.6174f008.js"><link rel="prefetch" href="/assets/js/9.14cbd4c1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cdd75a34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1aefc0b4><div data-v-1aefc0b4><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1aefc0b4 data-v-1aefc0b4><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>Yim's Blog</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>blog</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>Yim</span>
            
          <span data-v-25ba6db2>2022 - </span>
          2025
        </a></span></div></div> <div class="hide" data-v-1aefc0b4><header class="navbar" data-v-1aefc0b4><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Yim's Blog" class="logo"> <span class="site-name">Yim's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Jenkins/" class="nav-link"><i class="undefined"></i>
  Jenkins
</a></li><li class="dropdown-item"><!----> <a href="/categories/Hello/" class="nav-link"><i class="undefined"></i>
  Hello
</a></li><li class="dropdown-item"><!----> <a href="/categories/Elasticsearch/" class="nav-link"><i class="undefined"></i>
  Elasticsearch
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java基础/" class="nav-link"><i class="undefined"></i>
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/categories/JUC/" class="nav-link"><i class="undefined"></i>
  JUC
</a></li><li class="dropdown-item"><!----> <a href="/categories/Kubernetes/" class="nav-link"><i class="undefined"></i>
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/categories/Linux/" class="nav-link"><i class="undefined"></i>
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/categories/MySQL/" class="nav-link"><i class="undefined"></i>
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/categories/Netty/" class="nav-link"><i class="undefined"></i>
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/categories/MyBatis/" class="nav-link"><i class="undefined"></i>
  MyBatis
</a></li><li class="dropdown-item"><!----> <a href="/categories/Nginx/" class="nav-link"><i class="undefined"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/categories/网络/" class="nav-link"><i class="undefined"></i>
  网络
</a></li><li class="dropdown-item"><!----> <a href="/categories/SpringMVC/" class="nav-link"><i class="undefined"></i>
  SpringMVC
</a></li><li class="dropdown-item"><!----> <a href="/categories/Springcloud/" class="nav-link"><i class="undefined"></i>
  Springcloud
</a></li><li class="dropdown-item"><!----> <a href="/categories/面试/" class="nav-link"><i class="undefined"></i>
  面试
</a></li><li class="dropdown-item"><!----> <a href="/categories/安全/" class="nav-link"><i class="undefined"></i>
  安全
</a></li><li class="dropdown-item"><!----> <a href="/categories/Redis/" class="nav-link"><i class="undefined"></i>
  Redis
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Conca147" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1aefc0b4></div> <aside class="sidebar" data-v-1aefc0b4><div class="personal-info-wrapper" data-v-39576ba9 data-v-1aefc0b4><img src="/DSC06970.jpg" alt="author-avatar" class="personal-img" data-v-39576ba9> <h3 class="name" data-v-39576ba9>
    Yim
  </h3> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>64</h3> <h6 data-v-39576ba9>Articles</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>21</h3> <h6 data-v-39576ba9>Tags</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Jenkins/" class="nav-link"><i class="undefined"></i>
  Jenkins
</a></li><li class="dropdown-item"><!----> <a href="/categories/Hello/" class="nav-link"><i class="undefined"></i>
  Hello
</a></li><li class="dropdown-item"><!----> <a href="/categories/Elasticsearch/" class="nav-link"><i class="undefined"></i>
  Elasticsearch
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java基础/" class="nav-link"><i class="undefined"></i>
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/categories/JUC/" class="nav-link"><i class="undefined"></i>
  JUC
</a></li><li class="dropdown-item"><!----> <a href="/categories/Kubernetes/" class="nav-link"><i class="undefined"></i>
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/categories/Linux/" class="nav-link"><i class="undefined"></i>
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/categories/MySQL/" class="nav-link"><i class="undefined"></i>
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/categories/Netty/" class="nav-link"><i class="undefined"></i>
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/categories/MyBatis/" class="nav-link"><i class="undefined"></i>
  MyBatis
</a></li><li class="dropdown-item"><!----> <a href="/categories/Nginx/" class="nav-link"><i class="undefined"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/categories/网络/" class="nav-link"><i class="undefined"></i>
  网络
</a></li><li class="dropdown-item"><!----> <a href="/categories/SpringMVC/" class="nav-link"><i class="undefined"></i>
  SpringMVC
</a></li><li class="dropdown-item"><!----> <a href="/categories/Springcloud/" class="nav-link"><i class="undefined"></i>
  Springcloud
</a></li><li class="dropdown-item"><!----> <a href="/categories/面试/" class="nav-link"><i class="undefined"></i>
  面试
</a></li><li class="dropdown-item"><!----> <a href="/categories/安全/" class="nav-link"><i class="undefined"></i>
  安全
</a></li><li class="dropdown-item"><!----> <a href="/categories/Redis/" class="nav-link"><i class="undefined"></i>
  Redis
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Conca147" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>K8S-16_集群安全9（ClusterSafety）</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>Yim</span>
            
          <span data-v-25ba6db2>2022 - </span>
          2025
        </a></span></div></div> <div data-v-1aefc0b4><main class="page" style="padding-right:0;"><section><div class="page-title"><h1 class="title">K8S-16_集群安全9（ClusterSafety）</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>Yim</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>11/27/2023</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="理论基础"><a href="#理论基础" class="header-anchor">#</a> 理论基础</h2> <p><img src="https://pic-new-1304161434.cos.ap-guangzhou.myqcloud.com/img/202311271502885.png" alt=""></p> <h3 id="认证"><a href="#认证" class="header-anchor">#</a> 认证</h3> <p>如上图步骤1所示，建立TLS后，HTTP请求将进入认证（Authentication）步骤。认证模块包含客户端证书、密码、普通令牌、引导令牌等。可以指定多个认证模块，在这种情况下，服务器依次尝试每个验证模块，直到其中一个成功。</p> <h3 id="授权"><a href="#授权" class="header-anchor">#</a> 授权</h3> <p>如上图的步骤 2所示，将请求验证为来自特定的用户后，请求必须被鉴权。</p> <p>请求必须包含请求者的用户名、请求的行为以及受该操作影响的对象。 如果现有策略声明用户有权完成请求的操作，那么该请求被鉴权通过。</p> <h3 id="准入控制"><a href="#准入控制" class="header-anchor">#</a> 准入控制</h3> <p>如上图的步骤 3所示，准入控制模块是可以修改或拒绝请求的软件模块。 除鉴权模块可用的属性外，准入控制模块还可以访问正在创建或修改的对象的内容。</p> <h2 id="kubernetes中的账户"><a href="#kubernetes中的账户" class="header-anchor">#</a> Kubernetes中的账户</h2> <p>Kubernetes的账户类型有两种：User Account和Service Account</p> <h3 id="user-account"><a href="#user-account" class="header-anchor">#</a> User Account</h3> <h4 id="理论基础-2"><a href="#理论基础-2" class="header-anchor">#</a> 理论基础</h4> <p>User Account是给使用人员用的，用于与API Server交互进行集群操作与管理。</p> <p>使用HTTP 请求kubernetes API：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl proxy --port=8080</span>
Starting to serve on <span class="token number">127.0</span>.0.1:8080

<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># curl http://localhost:8080/api/v1/namespaces</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;NamespaceList&quot;</span>,
  <span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;v1&quot;</span>,
  <span class="token string">&quot;metadata&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;selfLink&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/api/v1/namespaces&quot;</span>,
    <span class="token string">&quot;resourceVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;3866057&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Kubernetes 使用身份认证插件利用客户端证书、持有者令牌（Bearer Token）、身份认证代理（Proxy） 或者 HTTP 基本认证机制来认证 API 请求的身份。</p> <h3 id="x509客户端证书认证"><a href="#x509客户端证书认证" class="header-anchor">#</a> X509客户端证书认证</h3> <p>为了让普通用户能够通过认证并调用 API，需要执行一下几个步骤。</p> <p>首先，该用户必须拥有 Kubernetes 集群签发的证书， 然后将该证书作为 API 调用的 Certificate 头或通过 kubectl 提供。</p> <p>1） 创建私钥</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># openssl genrsa -out user1.key 2048</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2） 创建CSR</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openssl req -new -key user1.key -out user1.csr -subj <span class="token string">&quot;/CN=user1/O=kubernetes&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注： 以下步骤为使用CA证书签名，如果无法访问CA证书，也可以替换为步骤3、4直接使用在集群中签名，任选其一</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">## SCP user1.csr到master节点</span>
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># scp user1.csr master:/etc/kubernetes/pki/</span>

<span class="token comment">## 登录到master节点，签名证书</span>
<span class="token punctuation">[</span>root@master pki<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/etc/kubernetes/pki
<span class="token punctuation">[</span>root@master pki<span class="token punctuation">]</span><span class="token comment"># openssl x509 -req -in user1.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out user1.crt</span>

<span class="token comment">## 将生成的crt证书 copy 回clientvm</span>
<span class="token punctuation">[</span>root@master pki<span class="token punctuation">]</span><span class="token comment"># scp user1.crt clientvm:/root/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>3） 证书签名</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># cat user1.csr | base64 | tr -d &quot;\n&quot;</span>
<span class="token comment">#替换入下文件中的request内容</span>
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># cat  user1-csr.yaml</span>
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: user1
spec:
  groups:
  - system:authenticated
  request: NEED TO REPLACE
  signerName: kubernetes.io/kube-apiserver-client
  usages:
  - client auth
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>4）签名，获取证书</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f user1-csr.yaml</span>
certificatesigningrequest.certificates.k8s.io/user1 created

<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl get csr</span>
NAME    AGE   SIGNERNAME                            REQUESTOR          CONDITION
user1   18s   kubernetes.io/kube-apiserver-client   kubernetes-admin   Pending

<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl certificate approve user1</span>
certificatesigningrequest.certificates.k8s.io/user1 approved
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl get csr/user1 -o yaml</span>
<span class="token comment">## 证书的内容使用 base64 编码，存放在字段 status.certificate</span>

<span class="token comment">#保存status.certificate内容到一个文件aaa，生成证书 crt</span>
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># cat aaa |base64 --decode &gt;user1.crt</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>5） 添加user1到kubeconfig</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl config set-credentials user1 --client-key=user1.key --client-certificate=user1.crt --embed-certs=true </span>
User <span class="token string">&quot;user1&quot;</span> set.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>6）添加上下文</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl config get-contexts</span>
CURRENT   NAME                         CLUSTER     AUTHINFO           NAMESPACE
*         kubernetes-admin@mycluster   mycluster   kubernetes-admin

<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl config set-context user1@mycluster --cluster=mycluster --user=user1</span>
Context <span class="token string">&quot;user1@mycluster&quot;</span> created.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>7） 把上下文切换为user1</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context user1@mycluster</span>
Switched to context <span class="token string">&quot;user1@mycluster&quot;</span><span class="token builtin class-name">.</span>

<span class="token comment">##此处报权限错误是因为只做了认证，还没有授权</span>
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod</span>
Error from server <span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span>: pods is forbidden: User <span class="token string">&quot;user1&quot;</span> cannot list resource <span class="token string">&quot;pods&quot;</span> <span class="token keyword">in</span> API group <span class="token string">&quot;&quot;</span> <span class="token keyword">in</span> the namespace <span class="token string">&quot;default&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="管理配置上下文"><a href="#管理配置上下文" class="header-anchor">#</a> 管理配置上下文</h3> <p><img src="https://pic-new-1304161434.cos.ap-guangzhou.myqcloud.com/img/202311271546832.png" alt=""></p> <h4 id="基本步骤"><a href="#基本步骤" class="header-anchor">#</a> 基本步骤</h4> <h5 id="添加用户"><a href="#添加用户" class="header-anchor">#</a> 添加用户</h5> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>kubectl config set-credentials -h

<span class="token comment">#使用token方式配置账户登录：</span>
kubectl config set-credentials user --token<span class="token operator">=</span><span class="token punctuation">{</span>token<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="添加-cluster"><a href="#添加-cluster" class="header-anchor">#</a> 添加 cluster</h5> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>kubectl config set-cluster -h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="添加-context"><a href="#添加-context" class="header-anchor">#</a> 添加 context</h5> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>kubectl config set-context
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="切换使用"><a href="#切换使用" class="header-anchor">#</a> 切换使用</h5> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl config current-context</span>
kubernetes-admin@kubernetes

<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context kubernetes-admin@kubernetes</span>
Switched to context <span class="token string">&quot;kubernetes-admin@kubernetes&quot;</span><span class="token builtin class-name">.</span>

<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl config get-contexts</span>
CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE
*         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin
          user1@kubernetes              kubernetes   user1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="合并多个kubeconfig"><a href="#合并多个kubeconfig" class="header-anchor">#</a> 合并多个kubeconfig</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=~</span>/myk8s.txt:~/kubeconfig-new-version.txt
kubectl config view --flatten <span class="token operator">&gt;</span>.kube/config

<span class="token comment">#结果</span>
<span class="token punctuation">[</span>root@cse-server ~<span class="token punctuation">]</span><span class="token comment"># kubectl config get-contexts</span>
CURRENT   NAME                            CLUSTER       AUTHINFO            NAMESPACE
*         myk8s-admin@myk8s               myk8s         myk8s-admin
          new-version-admin@new-version   new-version   new-version-admin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="service-account"><a href="#service-account" class="header-anchor">#</a> Service Account</h2> <p>当你（自然人）访问集群时（例如，使用 <code>kubectl</code>），API 服务器将你的身份验证为 特定的用户帐户（当前这通常是 <code>admin</code>，除非你的集群管理员已经定制了你的集群配置）。 Pod 内的容器中的进程也可以与 api 服务器接触。 当它们进行身份验证时，它们被验证为特定的服务帐户（例如，<code>default</code>）</p> <p>服务账号通常由 API 服务器自动创建并通过 <code>ServiceAccount</code> <a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/" target="_blank" rel="noopener noreferrer">准入控制器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 关联到集群中运行的 Pod 上。 相关Token会挂载到 Pod 中可预知的位置，允许集群内进程与 API 服务器通信。</p> <p>当你创建 Pod 时，如果没有指定服务账户，Pod 会被指定给命名空间中的 <code>default</code> 服务账户。 也可以在Pod中添加serviceAccountName明确指定SA。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod nginx2 -o yaml | grep -i serviceaccount</span>
    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
  serviceAccount: default
  serviceAccountName: default

<span class="token comment">#创建SA</span>
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl create serviceaccount -h</span>
Create a <span class="token function">service</span> account with the specified name.

Aliases:
serviceaccount, sa

Examples:
  <span class="token comment"># Create a new service account named my-service-account</span>
  kubectl create serviceaccount my-service-account

<span class="token comment">#1.23版本之前，创建SA后，系统会自动创建一个token； 1.24版本以后，已经不会自动创建。</span>
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl get sa,secret -n mytest</span>
NAME                     SECRETS   AGE
serviceaccount/default   <span class="token number">1</span>         18d
serviceaccount/my-sa     <span class="token number">1</span>         15s

NAME                         TYPE                                  DATA   AGE
secret/default-token-64sch   kubernetes.io/service-account-token   <span class="token number">3</span>      18d
secret/my-sa-token-w6d7f     kubernetes.io/service-account-token   <span class="token number">3</span>      15s

<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl get serviceaccounts my-sa -n mytest  -o yaml</span>
apiVersion: v1
kind: ServiceAccount
metadata:
  creationTimestamp: <span class="token string">&quot;2020-12-16T05:24:27Z&quot;</span>
  name: my-sa
  namespace: mytest
  resourceVersion: <span class="token string">&quot;4060881&quot;</span>
  selfLink: /api/v1/namespaces/mytest/serviceaccounts/my-sa
  uid: 85bd0753-5ebf-4c5f-8046-5dbd4391f739
secrets:
- name: my-sa-token-w6d7f

<span class="token comment">#从私有镜像仓库获取镜像</span>
<span class="token comment">#在Pod中引入ImagePullSecrets</span>
<span class="token comment"># pod.yaml</span>
apiVersion: v1
kind: Pod
metadata:
  name: foo
  namespace: awesomeapps
spec:
  containers:
    - name: foo
      image: janedoe/awesomeapp:v1
  imagePullSecrets:
    - name: myregistryke
    
<span class="token comment">#添加 docker-registry 类似的secret到default SA</span>
kubectl create secret docker-registry myregistrykey --docker-server<span class="token operator">=</span>DUMMY_SERVER <span class="token punctuation">\</span>
          --docker-username<span class="token operator">=</span>DUMMY_USERNAME --docker-password<span class="token operator">=</span>DUMMY_DOCKER_PASSWORD

kubectl patch serviceaccount default -p <span class="token string">'{&quot;imagePullSecrets&quot;: [{&quot;name&quot;: &quot;myregistrykey&quot;}]}'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h3 id="rbac授权"><a href="#rbac授权" class="header-anchor">#</a> RBAC授权</h3> <p>基于角色（Role）的访问控制（RBAC）是一种基于组织中用户的角色来调节控制对 计算机或网络资源的访问的方法。</p> <p>RBAC 鉴权机制使用 <code>rbac.authorization.k8s.io</code> <a href="https://kubernetes.io/zh/docs/concepts/overview/kubernetes-api/#api-groups" target="_blank" rel="noopener noreferrer">API 组<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来驱动鉴权决定，允许你通过 Kubernetes API 动态配置策略。</p> <p>要启用 RBAC，在启动 <a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/" target="_blank" rel="noopener noreferrer">API 服务器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 时将 <code>--authorization-mode</code> 参数设置为一个逗号分隔的列表并确保其中包含 <code>RBAC</code></p> <p>RBAC API 声明了四种 Kubernetes 对象：<em>Role</em>、<em>ClusterRole</em>、<em>RoleBinding</em> 和 <em>ClusterRoleBinding</em>。</p> <h3 id="role-和-clusterrole"><a href="#role-和-clusterrole" class="header-anchor">#</a> Role 和 ClusterRole</h3> <p>RBAC 的 Role 或 ClusterRole 中包含一组代表相关权限的规则。 这些权限是纯粹累加的（不存在拒绝某操作的规则）。</p> <p>Role 总是用来在某个<a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/namespaces/" target="_blank" rel="noopener noreferrer">名字空间<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 内设置访问权限；在你创建 Role 时，你必须指定该 Role 所属的名字空间。</p> <p>与之相对，ClusterRole 则是一个集群作用域的资源。这两种资源的名字不同（Role 和 ClusterRole）是因为 Kubernetes 对象要么是名字空间作用域的，要么是集群作用域的， 不可两者兼具。</p> <p>如果你希望在名字空间内定义角色，应该使用 Role</p> <p>如果你希望定义集群范围的角色，应该使用 ClusterRole。</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>#role可包含的操作有
&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;

#role常用可操作资源有：Pods, ConfigMaps, Deploments, Nodes, Secrets, Namespaces
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="核心组件角色"><a href="#核心组件角色" class="header-anchor">#</a> 核心组件角色</h4> <table><thead><tr><th>默认 ClusterRole</th> <th>默认 ClusterRoleBinding</th> <th>描述</th></tr></thead> <tbody><tr><td><strong>cluster-admin</strong></td> <td><strong>system:masters</strong> 组</td> <td>允许超级用户在平台上的任何资源上执行所有操作。 当在 <strong>ClusterRoleBinding</strong> 中使用时，可以授权对集群中以及所有名字空间中的全部资源进行完全控制。 当在 <strong>RoleBinding</strong> 中使用时，可以授权控制 RoleBinding 所在名字空间中的所有资源，包括名字空间本身。</td></tr> <tr><td><strong>admin</strong></td> <td>无</td> <td>允许管理员访问权限，旨在使用 <strong>RoleBinding</strong> 在名字空间内执行授权。 如果在 <strong>RoleBinding</strong> 中使用，则可授予对名字空间中的大多数资源的读/写权限， 包括创建角色和角色绑定的能力。 但是它不允许对资源配额或者名字空间本身进行写操作。</td></tr> <tr><td><strong>edit</strong></td> <td>无</td> <td>允许对名字空间的大多数对象进行读/写操作。 它不允许查看或者修改角色或者角色绑定。 不过，此角色可以访问 Secret，以名字空间中任何 ServiceAccount 的身份运行 Pods， 所以可以用来了解名字空间内所有服务账号的 API 访问级别。</td></tr></tbody></table> <h4 id="role范例"><a href="#role范例" class="header-anchor">#</a> Role范例</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl create role -h</span>
Usage:
  kubectl create role NAME --verb<span class="token operator">=</span>verb --resource<span class="token operator">=</span>resource.group/subresource <span class="token punctuation">[</span>--resource-name<span class="token operator">=</span>resourcename<span class="token punctuation">]</span>
<span class="token punctuation">[</span>--dry-run<span class="token operator">=</span>server<span class="token operator">|</span>client<span class="token operator">|</span>none<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

Examples:
  <span class="token comment"># Create a Role named &quot;pod-reader&quot; that allows user to perform &quot;get&quot;, &quot;watch&quot; and &quot;list&quot; on pods</span>
  kubectl create role pod-reader --verb<span class="token operator">=</span>get --verb<span class="token operator">=</span>list --verb<span class="token operator">=</span>watch --resource<span class="token operator">=</span>pods

  <span class="token comment"># Create a Role named &quot;pod-reader&quot; with ResourceName specified</span>
  kubectl create role pod-reader --verb<span class="token operator">=</span>get --resource<span class="token operator">=</span>pods --resource-name<span class="token operator">=</span>readablepod --resource-name<span class="token operator">=</span>anotherpod

  <span class="token comment"># Create a Role named &quot;foo&quot; with API Group specified</span>
  kubectl create role foo --verb<span class="token operator">=</span>get,list,watch --resource<span class="token operator">=</span>rs.extensions

  <span class="token comment"># Create a Role named &quot;foo&quot; with SubResource specified</span>
  kubectl create role foo --verb<span class="token operator">=</span>get,list,watch --resource<span class="token operator">=</span>pods,pods/status

<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># cat role-example.yaml</span>
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: mytest
  name: pod-reader
rules:
- apiGroups: <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span> <span class="token comment"># &quot;&quot; 标明 core API 组</span>
  resources: <span class="token punctuation">[</span><span class="token string">&quot;pods&quot;</span><span class="token punctuation">]</span>
  verbs: <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span>, <span class="token string">&quot;watch&quot;</span>, <span class="token string">&quot;list&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f role-example.yaml</span>
role.rbac.authorization.k8s.io/pod-reader created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h4 id="clusterrole范例"><a href="#clusterrole范例" class="header-anchor">#</a> ClusterRole范例</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl create clusterrole -h</span>
Usage:
  kubectl create clusterrole NAME --verb<span class="token operator">=</span>verb --resource<span class="token operator">=</span>resource.group <span class="token punctuation">[</span>--resource-name<span class="token operator">=</span>resourcename<span class="token punctuation">]</span>
<span class="token punctuation">[</span>--dry-run<span class="token operator">=</span>server<span class="token operator">|</span>client<span class="token operator">|</span>none<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

Examples:
  <span class="token comment"># Create a ClusterRole named &quot;pod-reader&quot; that allows user to perform &quot;get&quot;, &quot;watch&quot; and &quot;list&quot; on pods</span>
  kubectl create clusterrole pod-reader --verb<span class="token operator">=</span>get,list,watch --resource<span class="token operator">=</span>pods

  <span class="token comment"># Create a ClusterRole named &quot;pod-reader&quot; with ResourceName specified</span>
  kubectl create clusterrole pod-reader --verb<span class="token operator">=</span>get --resource<span class="token operator">=</span>pods --resource-name<span class="token operator">=</span>readablepod
--resource-name<span class="token operator">=</span>anotherpod

  <span class="token comment"># Create a ClusterRole named &quot;foo&quot; with API Group specified</span>
  kubectl create clusterrole foo --verb<span class="token operator">=</span>get,list,watch --resource<span class="token operator">=</span>rs.extensions

  <span class="token comment"># Create a ClusterRole named &quot;foo&quot; with SubResource specified</span>
  kubectl create clusterrole foo --verb<span class="token operator">=</span>get,list,watch --resource<span class="token operator">=</span>pods,pods/status

  <span class="token comment"># Create a ClusterRole name &quot;foo&quot; with NonResourceURL specified</span>
  kubectl create clusterrole <span class="token string">&quot;foo&quot;</span> --verb<span class="token operator">=</span>get --non-resource-url<span class="token operator">=</span>/logs/*

  <span class="token comment"># Create a ClusterRole name &quot;monitoring&quot; with AggregationRule specified</span>
  kubectl create clusterrole monitoring --aggregation-rule<span class="token operator">=</span><span class="token string">&quot;rbac.example.com/aggregate-to-monitoring=true&quot;</span>
  
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># cat clusterrole-example.yaml</span>
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: secret-reader
rules:
- apiGroups: <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token comment"># 在 HTTP 层面，用来访问 Secret 对象的资源的名称为 &quot;secrets&quot;</span>
  resources: <span class="token punctuation">[</span><span class="token string">&quot;secrets&quot;</span><span class="token punctuation">]</span>
  verbs: <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span>, <span class="token string">&quot;watch&quot;</span>, <span class="token string">&quot;list&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f clusterrole-example.yaml</span>
clusterrole.rbac.authorization.k8s.io/secret-reader created

<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl get role -n mytest</span>
NAME         CREATED AT
pod-reader   <span class="token number">2020</span>-12-16T04:41:56Z
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl get clusterrole | grep secret</span>
secret-reader                                                          <span class="token number">2020</span>-12-16T04:44:26Z
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h3 id="rolebinding-和-clusterrolebinding"><a href="#rolebinding-和-clusterrolebinding" class="header-anchor">#</a> RoleBinding 和 ClusterRoleBinding</h3> <p>角色绑定（Role Binding）是将角色中定义的权限赋予一个或者一组用户。RoleBinding 在指定的名字空间中执行授权，而 ClusterRoleBinding 在集群范围执行授权。</p> <p>一个 RoleBinding 可以引用同一的名字空间中的任何 Role。 或者，一个 RoleBinding 可以引用某 ClusterRole 并将该 ClusterRole 绑定到 RoleBinding 所在的名字空间。 如果你希望将某 ClusterRole 绑定到集群中所有名字空间，你要使用 ClusterRoleBinding。</p> <h4 id="rolebinding-范例"><a href="#rolebinding-范例" class="header-anchor">#</a> RoleBinding 范例</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl create rolebinding -h</span>
Usage:
  kubectl create rolebinding NAME --clusterrole<span class="token operator">=</span>NAME<span class="token operator">|</span>--role<span class="token operator">=</span>NAME <span class="token punctuation">[</span>--user<span class="token operator">=</span>username<span class="token punctuation">]</span> <span class="token punctuation">[</span>--group<span class="token operator">=</span>groupname<span class="token punctuation">]</span>
<span class="token punctuation">[</span>--serviceaccount<span class="token operator">=</span>namespace:serviceaccountname<span class="token punctuation">]</span> <span class="token punctuation">[</span>--dry-run<span class="token operator">=</span>server<span class="token operator">|</span>client<span class="token operator">|</span>none<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

Examples:
  <span class="token comment"># Create a RoleBinding for user1, user2, and group1 using the admin ClusterRole</span>
  kubectl create rolebinding admin --clusterrole<span class="token operator">=</span>admin --user<span class="token operator">=</span>user1 --user<span class="token operator">=</span>user2 --group<span class="token operator">=</span>group1
  
<span class="token comment">#将clusterrole admin 绑定到之前创建的user account user1</span>
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl create rolebinding admin-to-user1 --clusterrole=admin --user=user1</span>
rolebinding.rbac.authorization.k8s.io/admin-to-user1 created

<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl --context=user1 get pod</span>
NAME                     READY   STATUS      RESTARTS   AGE
nginx-taint              <span class="token number">1</span>/1     Running     <span class="token number">0</span>          37h
nginx2                   <span class="token number">1</span>/1     Running     <span class="token number">0</span>          4d20h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="clusterrolebinding-范例"><a href="#clusterrolebinding-范例" class="header-anchor">#</a> ClusterRoleBinding 范例</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl create clusterrolebinding -h</span>
Usage:
  kubectl create clusterrolebinding NAME --clusterrole<span class="token operator">=</span>NAME <span class="token punctuation">[</span>--user<span class="token operator">=</span>username<span class="token punctuation">]</span> <span class="token punctuation">[</span>--group<span class="token operator">=</span>groupname<span class="token punctuation">]</span>
<span class="token punctuation">[</span>--serviceaccount<span class="token operator">=</span>namespace:serviceaccountname<span class="token punctuation">]</span> <span class="token punctuation">[</span>--dry-run<span class="token operator">=</span>server<span class="token operator">|</span>client<span class="token operator">|</span>none<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

Examples:
  <span class="token comment"># Create a ClusterRoleBinding for user1, user2, and group1 using the cluster-admin ClusterRole</span>
  kubectl create clusterrolebinding cluster-admin --clusterrole<span class="token operator">=</span>cluster-admin --user<span class="token operator">=</span>user1 --user<span class="token operator">=</span>user2 --group<span class="token operator">=</span>group1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="准入控制-admission-controllers"><a href="#准入控制-admission-controllers" class="header-anchor">#</a> 准入控制(Admission Controllers)</h2> <p>英文：</p> <p>https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-does-each-admission-controller-do</p> <p>中文：</p> <p>https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#启用额外的准入控制器</span>
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># grep admission ./kube-apiserver.yaml</span>
    - --enable-admission-plugins<span class="token operator">=</span>NodeRestriction

<span class="token comment">#关闭准入控制器</span>
<span class="token comment">#添加如下参数</span>
 --disable-admission-plugins<span class="token operator">=</span>PodNodeSelector,AlwaysDeny <span class="token punctuation">..</span>.

<span class="token comment">#默认启用的控制器</span>
NamespaceLifecycle, LimitRanger, ServiceAccount, TaintNodesByCondition, Priority, DefaultTolerationSeconds, DefaultStorageClass, StorageObjectInUseProtection, PersistentVolumeClaimResize, RuntimeClass, CertificateApproval, CertificateSigning, CertificateSubjectRestriction, DefaultIngressClass, MutatingAdmissionWebhook, ValidatingAdmissionWebhook, ResourceQuota
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="网络策略"><a href="#网络策略" class="header-anchor">#</a> 网络策略</h2> <h3 id="理论基础-3"><a href="#理论基础-3" class="header-anchor">#</a> 理论基础</h3> <p>如果你希望在 IP 地址或端口层面（OSI 第 3 层或第 4 层）控制网络流量， 则你可以考虑为集群中特定应用使用 Kubernetes 网络策略（NetworkPolicy）。 NetworkPolicy 是一种以应用为中心的结构，允许你设置如何允许 <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/" target="_blank" rel="noopener noreferrer">Pod<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 与网络上的各类网络“实体” 通信。</p> <p>Pod 可以通信的 Pod 是通过如下三个标识符的组合来辩识的：</p> <ol><li>其他被允许的 Pods（例外：Pod 无法阻塞对自身的访问）</li> <li>被允许的名字空间</li> <li>IP 组块（例外：与 Pod 运行所在的节点的通信总是被允许的， 无论 Pod 或节点的 IP 地址）</li></ol> <p>在定义基于 Pod 或名字空间的 NetworkPolicy 时，你会使用 <a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/labels/" target="_blank" rel="noopener noreferrer">选择算符<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来设定哪些流量 可以进入或离开与该算符匹配的 Pod。 当基于 IP 的 NetworkPolicy 被创建时，我们基于 IP 组块（CIDR 范围） 来定义策略。</p> <p>网络策略通过<a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/" target="_blank" rel="noopener noreferrer">网络插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来实现。要使用网络策略，你必须使用支持 NetworkPolicy 的网络解决方案。</p> <h3 id="语法说明"><a href="#语法说明" class="header-anchor">#</a> 语法说明</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>network<span class="token punctuation">-</span>policy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">role</span><span class="token punctuation">:</span> db
<span class="token comment">##1）对default NameSpace中包含标签role=db的Pod做控制</span>
  <span class="token key atrule">policyTypes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Ingress
  <span class="token punctuation">-</span> Egress
<span class="token comment">##2）控制出入流量，未明确指定都是拒绝</span>
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">ipBlock</span><span class="token punctuation">:</span>
        <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 172.17.0.0/16
        <span class="token key atrule">except</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> 172.17.1.0/24
<span class="token comment">##3）允许的网段，例外网段 </span>
    <span class="token punctuation">-</span> <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
          <span class="token key atrule">project</span><span class="token punctuation">:</span> myproject
<span class="token comment">##4）允许的NameSpace</span>
    <span class="token punctuation">-</span> <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
          <span class="token key atrule">role</span><span class="token punctuation">:</span> frontend
<span class="token comment">##5）允许的Pod</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
<span class="token comment">##6) 定义被访问的端口</span>
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">ipBlock</span><span class="token punctuation">:</span>
        <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 10.0.0.0/24
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5978</span>
<span class="token comment">##7）允许要控制的Pod访问哪个  &quot;网段：端口&quot; 的流量</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>注意From和To的行为</p> <p>表示交集，and 运算</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>  <span class="token punctuation">...</span>
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
          <span class="token key atrule">user</span><span class="token punctuation">:</span> alice
      <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
          <span class="token key atrule">role</span><span class="token punctuation">:</span> client
  <span class="token punctuation">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>表示并集，or 运算</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>  <span class="token punctuation">...</span>
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
          <span class="token key atrule">user</span><span class="token punctuation">:</span> alice
    <span class="token punctuation">-</span> <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
          <span class="token key atrule">role</span><span class="token punctuation">:</span> client
  <span class="token punctuation">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="默认策略-拒绝所有进入流量"><a href="#默认策略-拒绝所有进入流量" class="header-anchor">#</a> 默认策略：拒绝所有进入流量</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>deny<span class="token punctuation">-</span>ingress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">policyTypes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Ingress
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="默认策略-允许所有进入流量"><a href="#默认策略-允许所有进入流量" class="header-anchor">#</a> 默认策略：允许所有进入流量</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> allow<span class="token punctuation">-</span>all<span class="token punctuation">-</span>ingress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">policyTypes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Ingress
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="范例1-允许指定网段的入站流量"><a href="#范例1-允许指定网段的入站流量" class="header-anchor">#</a> 范例1： 允许指定网段的入站流量</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># cat deny-all-except.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deny<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>except
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">run</span><span class="token punctuation">:</span> nginx1
  <span class="token key atrule">policyTypes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Ingress
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">ipBlock</span><span class="token punctuation">:</span>
        <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 10.244.0.0/16
        <span class="token key atrule">except</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> 10.244.102.0/24
    <span class="token punctuation">-</span> <span class="token key atrule">ipBlock</span><span class="token punctuation">:</span>
        <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 192.168.241.0/24
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod --show-labels -o wide</span>
NAME             READY   STATUS    RESTARTS   AGE     IP               NODE                  NOMINATED NODE   READINESS GATES   LABELS
busybox          1/1     Running   0          5m23s   10.244.102.144   worker1.example.com   &lt;none<span class="token punctuation">&gt;</span>           &lt;none<span class="token punctuation">&gt;</span>            run=busybox
nginx1           1/1     Running   0          10h     10.244.71.195    worker2.example.com   &lt;none<span class="token punctuation">&gt;</span>           &lt;none<span class="token punctuation">&gt;</span>            run=nginx1
nginx2           1/1     Running   0          10h     10.244.71.196    worker2.example.com   &lt;none<span class="token punctuation">&gt;</span>           &lt;none<span class="token punctuation">&gt;</span>            run=nginx2
nginx3<span class="token punctuation">-</span>default   1/1     Running   0          8h      10.244.102.133   worker1.example.com   &lt;none<span class="token punctuation">&gt;</span>           &lt;none<span class="token punctuation">&gt;</span>            run=nginx3<span class="token punctuation">-</span>


<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># ip a | grep 192</span>
    inet 192.168.241.129/24 brd 192.168.241.255 scope global eth0
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># ping 10.244.71.195</span>
PING 10.244.71.195 (10.244.71.195) 56(84) bytes of data.
<span class="token key atrule">64 bytes from 10.244.71.195</span><span class="token punctuation">:</span> icmp_seq=1 ttl=63 time=0.484 ms
<span class="token key atrule">64 bytes from 10.244.71.195</span><span class="token punctuation">:</span> icmp_seq=2 ttl=63 time=0.276 ms
<span class="token key atrule">64 bytes from 10.244.71.195</span><span class="token punctuation">:</span> icmp_seq=3 ttl=63 time=0.217 ms
^C
<span class="token punctuation">---</span> 10.244.71.195 ping statistics <span class="token punctuation">---</span>

<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl run busybox --image=busybox --image-pull-policy=IfNotPresent -- sleep 10000</span>
pod/busybox created
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -o wide</span>
NAME             READY   STATUS    RESTARTS   AGE   IP               NODE                  NOMINATED NODE   READINESS GATES
busybox          1/1     Running   0          10s   10.244.102.144   worker1.example.com   &lt;none<span class="token punctuation">&gt;</span>           &lt;none<span class="token punctuation">&gt;</span>
nginx1           1/1     Running   0          10h   10.244.71.195    worker2.example.com   &lt;none<span class="token punctuation">&gt;</span>           &lt;none<span class="token punctuation">&gt;</span>
nginx2           1/1     Running   0          10h   10.244.71.196    worker2.example.com   &lt;none<span class="token punctuation">&gt;</span>           &lt;none<span class="token punctuation">&gt;</span>
nginx3<span class="token punctuation">-</span>default   1/1     Running   0          8h    10.244.102.133   worker1.example.com   &lt;none<span class="token punctuation">&gt;</span>           &lt;none<span class="token punctuation">&gt;</span>

<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec busybox -it -- sh</span>
/ <span class="token comment"># ping 10.244.71.195</span>
<span class="token key atrule">PING 10.244.71.195 (10.244.71.195)</span><span class="token punctuation">:</span> 56 data bytes
^C
<span class="token punctuation">---</span> 10.244.71.195 ping statistics <span class="token punctuation">---</span>
5 packets transmitted<span class="token punctuation">,</span> 0 packets received<span class="token punctuation">,</span> 100% packet loss
/ <span class="token comment"># ping 10.244.71.196</span>
<span class="token key atrule">PING 10.244.71.196 (10.244.71.196)</span><span class="token punctuation">:</span> 56 data bytes
<span class="token key atrule">64 bytes from 10.244.71.196</span><span class="token punctuation">:</span> seq=0 ttl=62 time=0.547 ms
<span class="token key atrule">64 bytes from 10.244.71.196</span><span class="token punctuation">:</span> seq=1 ttl=62 time=0.341 ms
^C
<span class="token punctuation">---</span> 10.244.71.196 ping statistics <span class="token punctuation">---</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h3 id="范例2-允许到指定端口的出站流量"><a href="#范例2-允许到指定端口的出站流量" class="header-anchor">#</a> 范例2： 允许到指定端口的出站流量</h3> <p>目的：Pod Nginx1可以访问namespace内的Pod的80端口，不允许访问其他</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># cat allow-egress-to-port.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deny<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>except
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">run</span><span class="token punctuation">:</span> nginx1
  <span class="token key atrule">policyTypes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Egress
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
          <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>

<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -o wide -n mytest</span>
NAME      READY   STATUS    RESTARTS   AGE   IP              NODE                  NOMINATED NODE   READINESS GATES
nginxaa   1/1     Running   0          10m   10.244.71.200   worker2.example.com   &lt;none<span class="token punctuation">&gt;</span>           &lt;none<span class="token punctuation">&gt;</span>
<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -o wide</span>
NAME             READY   STATUS    RESTARTS   AGE   IP               NODE                  NOMINATED NODE   READINESS GATES
busybox          1/1     Running   0          33m   10.244.102.144   worker1.example.com   &lt;none<span class="token punctuation">&gt;</span>           &lt;none<span class="token punctuation">&gt;</span>
nginx1           1/1     Running   0          10h   10.244.71.195    worker2.example.com   &lt;none<span class="token punctuation">&gt;</span>           &lt;none<span class="token punctuation">&gt;</span>

<span class="token punctuation">[</span>root@clientvm ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec nginx1 -it -- bash</span>
root@nginx1<span class="token punctuation">:</span>/<span class="token comment">#</span>
root@nginx1<span class="token punctuation">:</span>/<span class="token comment"># curl 10.244.71.200</span>
^C
root@nginx1<span class="token punctuation">:</span>/<span class="token comment"># curl 10.244.71.195</span>
AAAAAA
root@nginx1<span class="token punctuation">:</span>/<span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">7/21/2025, 10:54:20 PM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:0;" data-v-cb1513f6></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.3d0db68d.js" defer></script><script src="/assets/js/3.ac09d9ae.js" defer></script><script src="/assets/js/1.13123cf3.js" defer></script><script src="/assets/js/29.8bce1e85.js" defer></script>
  </body>
</html>
