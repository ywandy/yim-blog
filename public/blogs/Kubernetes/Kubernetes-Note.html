<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>K8S-Node | blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="blog">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/blog/assets/css/0.styles.ca934e57.css" as="style"><link rel="preload" href="/blog/assets/js/app.b575e7ef.js" as="script"><link rel="preload" href="/blog/assets/js/3.b8613113.js" as="script"><link rel="preload" href="/blog/assets/js/1.d3bdaf35.js" as="script"><link rel="preload" href="/blog/assets/js/41.f6100517.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.d44d0892.js"><link rel="prefetch" href="/blog/assets/js/11.249fc9af.js"><link rel="prefetch" href="/blog/assets/js/12.45749ffc.js"><link rel="prefetch" href="/blog/assets/js/13.25f5a8c4.js"><link rel="prefetch" href="/blog/assets/js/14.c8071e3c.js"><link rel="prefetch" href="/blog/assets/js/15.46286e88.js"><link rel="prefetch" href="/blog/assets/js/16.9e8cd6d1.js"><link rel="prefetch" href="/blog/assets/js/17.686953c3.js"><link rel="prefetch" href="/blog/assets/js/18.822e6c31.js"><link rel="prefetch" href="/blog/assets/js/19.88392a31.js"><link rel="prefetch" href="/blog/assets/js/20.e8802bf7.js"><link rel="prefetch" href="/blog/assets/js/21.dfed3a18.js"><link rel="prefetch" href="/blog/assets/js/22.5a68ef20.js"><link rel="prefetch" href="/blog/assets/js/23.ae91a4ba.js"><link rel="prefetch" href="/blog/assets/js/24.4ee37cd7.js"><link rel="prefetch" href="/blog/assets/js/25.5d2daf1f.js"><link rel="prefetch" href="/blog/assets/js/26.e52f34f8.js"><link rel="prefetch" href="/blog/assets/js/27.386860c5.js"><link rel="prefetch" href="/blog/assets/js/28.4ba6e39b.js"><link rel="prefetch" href="/blog/assets/js/29.a6b10ddd.js"><link rel="prefetch" href="/blog/assets/js/30.6c3872fe.js"><link rel="prefetch" href="/blog/assets/js/31.5c0eff36.js"><link rel="prefetch" href="/blog/assets/js/32.15dd9c1d.js"><link rel="prefetch" href="/blog/assets/js/33.a05caae8.js"><link rel="prefetch" href="/blog/assets/js/34.3a13c506.js"><link rel="prefetch" href="/blog/assets/js/35.cb579c92.js"><link rel="prefetch" href="/blog/assets/js/36.57fb68d0.js"><link rel="prefetch" href="/blog/assets/js/37.9872cc2e.js"><link rel="prefetch" href="/blog/assets/js/38.a983258e.js"><link rel="prefetch" href="/blog/assets/js/39.adae02fb.js"><link rel="prefetch" href="/blog/assets/js/4.740d9160.js"><link rel="prefetch" href="/blog/assets/js/40.a557077b.js"><link rel="prefetch" href="/blog/assets/js/42.d603aa22.js"><link rel="prefetch" href="/blog/assets/js/43.4f633080.js"><link rel="prefetch" href="/blog/assets/js/44.e73d887b.js"><link rel="prefetch" href="/blog/assets/js/45.a3fd05e2.js"><link rel="prefetch" href="/blog/assets/js/46.ea8f7bbe.js"><link rel="prefetch" href="/blog/assets/js/47.e7cb2116.js"><link rel="prefetch" href="/blog/assets/js/48.f9f9b941.js"><link rel="prefetch" href="/blog/assets/js/49.cf4c1d36.js"><link rel="prefetch" href="/blog/assets/js/5.81241c66.js"><link rel="prefetch" href="/blog/assets/js/50.4e86a943.js"><link rel="prefetch" href="/blog/assets/js/51.89ef653a.js"><link rel="prefetch" href="/blog/assets/js/52.64d27b2c.js"><link rel="prefetch" href="/blog/assets/js/53.e8b4f09a.js"><link rel="prefetch" href="/blog/assets/js/54.09933651.js"><link rel="prefetch" href="/blog/assets/js/55.3c6d61b9.js"><link rel="prefetch" href="/blog/assets/js/56.7b33f96c.js"><link rel="prefetch" href="/blog/assets/js/57.009a594e.js"><link rel="prefetch" href="/blog/assets/js/58.8eff6c8a.js"><link rel="prefetch" href="/blog/assets/js/59.c94d9b8c.js"><link rel="prefetch" href="/blog/assets/js/6.8b37b343.js"><link rel="prefetch" href="/blog/assets/js/60.8f41b516.js"><link rel="prefetch" href="/blog/assets/js/61.ee24524f.js"><link rel="prefetch" href="/blog/assets/js/62.2aef63b8.js"><link rel="prefetch" href="/blog/assets/js/63.d7214326.js"><link rel="prefetch" href="/blog/assets/js/64.c80f4ec7.js"><link rel="prefetch" href="/blog/assets/js/65.2e4a5cde.js"><link rel="prefetch" href="/blog/assets/js/66.d6391503.js"><link rel="prefetch" href="/blog/assets/js/67.5c6fb539.js"><link rel="prefetch" href="/blog/assets/js/68.e9a4c8f9.js"><link rel="prefetch" href="/blog/assets/js/69.29bc4327.js"><link rel="prefetch" href="/blog/assets/js/7.cacb4248.js"><link rel="prefetch" href="/blog/assets/js/70.fc1279cc.js"><link rel="prefetch" href="/blog/assets/js/71.95060e90.js"><link rel="prefetch" href="/blog/assets/js/72.ea997597.js"><link rel="prefetch" href="/blog/assets/js/73.ca796356.js"><link rel="prefetch" href="/blog/assets/js/74.a5b81ceb.js"><link rel="prefetch" href="/blog/assets/js/8.6174f008.js"><link rel="prefetch" href="/blog/assets/js/9.14cbd4c1.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.ca934e57.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1aefc0b4><div data-v-1aefc0b4><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1aefc0b4 data-v-1aefc0b4><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>blog</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>blog</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>Yim</span>
            
          <span data-v-25ba6db2>2022 - </span>
          2025
        </a></span></div></div> <div class="hide" data-v-1aefc0b4><header class="navbar" data-v-1aefc0b4><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="blog" class="logo"> <span class="site-name">blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/Elasticsearch/" class="nav-link"><i class="undefined"></i>
  Elasticsearch
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Jenkins/" class="nav-link"><i class="undefined"></i>
  Jenkins
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Hello/" class="nav-link"><i class="undefined"></i>
  Hello
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Java基础/" class="nav-link"><i class="undefined"></i>
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/JUC/" class="nav-link"><i class="undefined"></i>
  JUC
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Kubernetes/" class="nav-link"><i class="undefined"></i>
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Linux/" class="nav-link"><i class="undefined"></i>
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/MySQL/" class="nav-link"><i class="undefined"></i>
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/MyBatis/" class="nav-link"><i class="undefined"></i>
  MyBatis
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Netty/" class="nav-link"><i class="undefined"></i>
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Redis/" class="nav-link"><i class="undefined"></i>
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/SpringMVC/" class="nav-link"><i class="undefined"></i>
  SpringMVC
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Nginx/" class="nav-link"><i class="undefined"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Springcloud/" class="nav-link"><i class="undefined"></i>
  Springcloud
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/面试/" class="nav-link"><i class="undefined"></i>
  面试
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/网络/" class="nav-link"><i class="undefined"></i>
  网络
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/安全/" class="nav-link"><i class="undefined"></i>
  安全
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Conca147" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1aefc0b4></div> <aside class="sidebar" data-v-1aefc0b4><div class="personal-info-wrapper" data-v-39576ba9 data-v-1aefc0b4><img src="/blog/DSC06970.jpg" alt="author-avatar" class="personal-img" data-v-39576ba9> <h3 class="name" data-v-39576ba9>
    Yim
  </h3> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>64</h3> <h6 data-v-39576ba9>Articles</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>21</h3> <h6 data-v-39576ba9>Tags</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/Elasticsearch/" class="nav-link"><i class="undefined"></i>
  Elasticsearch
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Jenkins/" class="nav-link"><i class="undefined"></i>
  Jenkins
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Hello/" class="nav-link"><i class="undefined"></i>
  Hello
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Java基础/" class="nav-link"><i class="undefined"></i>
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/JUC/" class="nav-link"><i class="undefined"></i>
  JUC
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Kubernetes/" class="nav-link"><i class="undefined"></i>
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Linux/" class="nav-link"><i class="undefined"></i>
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/MySQL/" class="nav-link"><i class="undefined"></i>
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/MyBatis/" class="nav-link"><i class="undefined"></i>
  MyBatis
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Netty/" class="nav-link"><i class="undefined"></i>
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Redis/" class="nav-link"><i class="undefined"></i>
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/SpringMVC/" class="nav-link"><i class="undefined"></i>
  SpringMVC
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Nginx/" class="nav-link"><i class="undefined"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Springcloud/" class="nav-link"><i class="undefined"></i>
  Springcloud
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/面试/" class="nav-link"><i class="undefined"></i>
  面试
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/网络/" class="nav-link"><i class="undefined"></i>
  网络
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/安全/" class="nav-link"><i class="undefined"></i>
  安全
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Conca147" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>K8S-Node</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>Yim</span>
            
          <span data-v-25ba6db2>2022 - </span>
          2025
        </a></span></div></div> <div data-v-1aefc0b4><main class="page" style="padding-right:0;"><section><div class="page-title"><h1 class="title">K8S-Node</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>Yim</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>3/22/2024</span></i> <!----> <i class="tags iconfont reco-tag" data-v-f875f3fc><span class="tag-item" data-v-f875f3fc>Kubernetes</span></i></div></div> <div class="theme-reco-content content__default"><p>[TOC]</p> <h1 id="_1-容器技术概述"><a href="#_1-容器技术概述" class="header-anchor">#</a> 1. 容器技术概述</h1> <h2 id="_1-1-容器技术基础"><a href="#_1-1-容器技术基础" class="header-anchor">#</a> 1.1 容器技术基础</h2> <h3 id="lab1-创建虚拟机"><a href="#lab1-创建虚拟机" class="header-anchor">#</a> Lab1. 创建虚拟机</h3> <blockquote><p>https://www.vmware.com/cn.html</p></blockquote> <h3 id="lab2-安装-ubuntu"><a href="#lab2-安装-ubuntu" class="header-anchor">#</a> Lab2. 安装 ubuntu</h3> <blockquote><p>https://mirror.nju.edu.cn/ubuntu-releases/22.04/ubuntu-22.04.1-live-server-amd64.iso</p> <p>https://k8s.ruitong.cn:8080/?dir=K8s</p></blockquote> <h3 id="lab3-安装-docker"><a href="#lab3-安装-docker" class="header-anchor">#</a> Lab3. 安装 docker</h3> <table><thead><tr><th style="text-align:center;"></th> <th>参考URL</th> <th style="text-align:center;"></th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td>https://docs.docker.com/engine/install/ubuntu/</td> <td style="text-align:center;">国外</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">2</td> <td>https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.3e221b11NzQkC4</td> <td style="text-align:center;">国内</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">3</td> <td>https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</td> <td style="text-align:center;">镜像仓库加速</td> <td style="text-align:center;">先注册一个帐号，并登陆</td></tr> <tr><td style="text-align:center;"></td> <td>https://mirror.nju.edu.cn/help/docker-ce</td> <td style="text-align:center;"></td> <td style="text-align:center;">README</td></tr></tbody></table> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>step <span class="token number">1</span>: 安装必要的一些系统工具
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> -y <span class="token function">install</span> apt-transport-https ca-certificates <span class="token function">curl</span> software-properties-common

step <span class="token number">2</span>: 安装GPG证书
$ <span class="token function">curl</span> -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -

Step <span class="token number">3</span>: 写入软件源信息
$ <span class="token function">sudo</span> add-apt-repository <span class="token string">&quot;deb [arch=amd64] https://mirror.nju.edu.cn/docker-ce/linux/ubuntu <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> stable&quot;</span>
<span class="token punctuation">..</span>.
Press <span class="token punctuation">[</span>ENTER<span class="token punctuation">]</span> to <span class="token builtin class-name">continue</span> or Ctrl-c to cancel. <span class="token operator">&lt;</span>Enter<span class="token operator">&gt;</span>

Step <span class="token number">4.1</span>: 更新
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> -y update

查找Docker-CE的版本
$ <span class="token function">apt-cache</span> madison docker-ce

Step <span class="token number">4.2</span>: 安装Docker-CE
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> -y <span class="token function">install</span> docker-ce
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>配置镜像加速器

创建文件夹
$ <span class="token function">sudo</span> <span class="token function">mkdir</span> -p /etc/docker

创建文件
$ <span class="token function">sudo</span> <span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
{
   &quot;registry-mirrors&quot;: [&quot;https://docker.nju.edu.cn&quot;]
}
EOF</span>

重新载入
$ <span class="token function">sudo</span> systemctl daemon-reload

重启服务
$ <span class="token function">sudo</span> systemctl restart <span class="token function">docker</span>

验证服务状态
$ systemctl status <span class="token function">docker</span>

验证镜像加速服务器
$ <span class="token function">sudo</span> <span class="token function">docker</span> info <span class="token operator">|</span> <span class="token function">grep</span> -iA <span class="token number">1</span> registry.*mirror
 Registry Mirrors:
  https://docker.nju.edu.cn/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="_1-2-容器基础操作"><a href="#_1-2-容器基础操作" class="header-anchor">#</a> 1.2 容器基础操作</h2> <div class="language- extra-class"><pre><code>![](https://img-blog.csdnimg.cn/5a295ff5243546ae8c160063b3882fb3.png)		 			 		
</code></pre></div><h3 id="lab4-运行一个容器"><a href="#lab4-运行一个容器" class="header-anchor">#</a> Lab4. 运行一个容器</h3> <blockquote><p>docker run, images, ps</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>切换身份
<span class="token comment"># sudo -i</span>

运行一个容器，会自动拉取镜像
<span class="token comment"># docker run -p 8080:80 -d httpd</span>
Unable to <span class="token function">find</span> image <span class="token string">'httpd:latest'</span> locally
latest: Pulling from library/httpd
a2abf6c4d29d: Pull complete 
dcc4698797c8: Pull complete 
41c22baa66ec: Pull complete 
67283bbdd4a0: Pull complete 
d982c879c57e: Pull complete 
Digest: sha256:0954cc1af252d824860b2c5dc0a10720af2b7a3d3435581ca788dff8480c7b32
Status: Downloaded newer image <span class="token keyword">for</span> httpd:latest
9ccfdb9313de4b7743f3f49cd7f99e8ae2fbaaa77d826af630bf12c449febdcd

查看本地镜像
<span class="token comment"># docker images </span>
REPOSITORY   TAG       IMAGE ID       CREATED        SIZE
<span class="token variable"><span class="token variable">`</span>httpd<span class="token variable">`</span></span>        latest    dabbfbe0c57b   <span class="token number">2</span> months ago   144MB

查看正在运行的容器（容器就是一个进程）
<span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE     COMMAND              CREATED         STATUS         PORTS                  NAMES
9ccfdb9313de   httpd     <span class="token string">&quot;httpd-foreground&quot;</span>   <span class="token number">2</span> minutes ago   <span class="token variable"><span class="token variable">`</span>Up<span class="token variable">`</span></span> <span class="token number">2</span> minutes   <span class="token number">0.0</span>.0.0:8080-<span class="token operator">&gt;</span><span class="token number">80</span>/tcp   <span class="token variable"><span class="token variable">`</span>dazzling_bohr<span class="token variable">`</span></span>

验证容器可以使用端口8080访问
<span class="token comment"># curl localhost:8080</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="lab5-容器生命周期管理"><a href="#lab5-容器生命周期管理" class="header-anchor">#</a> Lab5. 容器生命周期管理</h3> <blockquote><p>docker start, stop</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>停止容器
<span class="token comment"># docker stop dazzling_bohr </span>
dazzling_bohr

查看正在运行的容器
<span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES

查看所有的容器（包括已停止）
<span class="token comment"># docker ps -a</span>
CONTAINER ID   IMAGE     COMMAND              CREATED          STATUS                          PORTS     NAMES
9ccfdb9313de   httpd     <span class="token string">&quot;httpd-foreground&quot;</span>   <span class="token number">10</span> minutes ago   <span class="token variable"><span class="token variable">`</span>Exited<span class="token variable">`</span></span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> About a minute ago             dazzling_bohr

启动容器
<span class="token comment"># docker start dazzling_bohr </span>
dazzling_bohr

查看正在运行的容器
<span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE     COMMAND              CREATED          STATUS         PORTS                  NAMES
9ccfdb9313de   httpd     <span class="token string">&quot;httpd-foreground&quot;</span>   <span class="token number">12</span> minutes ago   <span class="token variable"><span class="token variable">`</span>Up<span class="token variable">`</span></span> <span class="token number">4</span> seconds   <span class="token number">0.0</span>.0.0:8080-<span class="token operator">&gt;</span><span class="token number">80</span>/tcp   dazzling_bohr
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="lab6-进入容器的方法1"><a href="#lab6-进入容器的方法1" class="header-anchor">#</a> Lab6. 进入容器的方法1</h3> <blockquote><p>docker attach</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>A场景，容器运行后直接退出。容器当中没有服务或正在运行的程序
<span class="token comment"># docker run -d centos </span>
<span class="token comment"># docker ps</span>

B场景，容器一直运行不会退。快捷键不可用
<span class="token comment"># docker run --name a1 -d centos \</span>
  /bin/bash -c <span class="token string">&quot;while true; do sleep 1; echo haha; done&quot;</span>
<span class="token comment"># docker ps</span>

<span class="token comment"># docker attach a1 </span>
<span class="token operator">&lt;</span>Ctrl-C<span class="token operator">&gt;</span>						不可用
<span class="token operator">&lt;</span>Ctrl-p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>Ctrl-q<span class="token operator">&gt;</span>		不可用
只能关闭当前终端或结束当前进程

*C场景，-it interactive交互模式，tty终端。可使用快捷键
<span class="token comment"># docker run --name a2 -it -d centos \</span>
	/bin/bash -c <span class="token string">&quot;while true; do sleep 1; echo haha; done&quot;</span>
<span class="token comment"># docker ps</span>
<span class="token comment"># docker attach a2</span>
<span class="token operator">&lt;</span>Ctrl-p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>Ctrl-q<span class="token operator">&gt;</span>		可用。可正常退出容器
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="lab7-进入容器的方法2"><a href="#lab7-进入容器的方法2" class="header-anchor">#</a> Lab7.进入容器的方法2</h3> <blockquote><p>docker exec</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES
903e1389d91d   centos    <span class="token string">&quot;/bin/bash -c 'while…&quot;</span>   <span class="token number">12</span> minutes ago   Up <span class="token number">12</span> minutes             confident_rhodes
<span class="token variable"><span class="token variable">`</span>5783569707c0<span class="token variable">`</span></span>   centos    <span class="token string">&quot;/bin/bash -c 'while…&quot;</span>   <span class="token number">14</span> minutes ago   Up <span class="token number">14</span> minutes             funny_napier

<span class="token comment"># docker exec -it &lt;Tab&gt;&lt;Tab&gt;</span>
confident_rhodes  funny_napier      

进入容器
<span class="token comment"># docker exec -it funny_napier /bin/bash</span>
<span class="token punctuation">[</span>root@5783569707c0 /<span class="token punctuation">]</span><span class="token comment"># ls</span>
bin  etc   lib	  lost+found  mnt  proc  run   srv  tmp  var
dev  home  lib64  media       opt  root  sbin  sys  usr
<span class="token punctuation">[</span>root@5783569707c0 /<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/
<span class="token punctuation">[</span>root@5783569707c0 /<span class="token punctuation">]</span><span class="token comment"># cat /etc/redhat-release </span>
CentOS Linux release <span class="token number">8.4</span>.2105
<span class="token punctuation">[</span>root@5783569707c0 /<span class="token punctuation">]</span><span class="token comment"># exit</span>

<span class="token comment">#</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h1 id="_2-容器镜像"><a href="#_2-容器镜像" class="header-anchor">#</a> 2. 容器镜像</h1> <h2 id="_2-1-容器镜像结构"><a href="#_2-1-容器镜像结构" class="header-anchor">#</a> 2.1 容器镜像结构</h2> <h3 id="lab8-理解镜像结构"><a href="#lab8-理解镜像结构" class="header-anchor">#</a> Lab8. 理解镜像结构</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>查看本地镜像
<span class="token comment"># docker images</span>

从镜像仓库拉取镜像 ubuntu
<span class="token comment"># docker pull ubuntu</span>
<span class="token comment"># docker images</span>

查看镜像相关信息
<span class="token comment"># docker image inspect ubuntu:latest </span>

使用镜像运行容器
<span class="token comment"># docker run -itd ubuntu</span>
<span class="token comment"># docker ps</span>

查看容器根目录
<span class="token comment"># docker exec -it pensive_mcnulty ls /</span>
查看本地根目录
<span class="token comment"># ls /</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="_2-2-构建容器镜像"><a href="#_2-2-构建容器镜像" class="header-anchor">#</a> 2.2 构建容器镜像</h2> <h3 id="lab9-docker-commit-命令"><a href="#lab9-docker-commit-命令" class="header-anchor">#</a> Lab9. docker-commit 命令</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>运行一个容器。<span class="token variable"><span class="token variable">`</span>--privileged<span class="token variable">`</span></span>和<span class="token variable"><span class="token variable">`</span>/sbin/init<span class="token variable">`</span></span>，他们两个的作用是为了给<span class="token variable"><span class="token variable">`</span>systemctl<span class="token variable">`</span></span>使用
<span class="token comment"># docker run --name test1 -itd --privileged centos /sbin/init</span>
b8216e5e3f5a4e4f5ab778d4b2b4dde3b99866d983ad94c0d43454ffd99be9b3
容器状态
<span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES
591952204f83   centos    <span class="token string">&quot;/sbin/init&quot;</span>             <span class="token number">8</span> seconds ago    Up <span class="token number">7</span> seconds              test1

进入你的容器
<span class="token comment"># docker exec -it test1 /bin/bash</span>
安装软件，没成功
<span class="token punctuation">[</span>root@b8216e5e3f5a /<span class="token punctuation">]</span><span class="token comment"># yum -y install httpd</span>
Failed to <span class="token builtin class-name">set</span> locale, defaulting to C.UTF-8
CentOS Linux <span class="token number">8</span> - AppStream                    <span class="token number">39</span>  B/s <span class="token operator">|</span>  <span class="token number">38</span>  B     00:00    
Error: Failed to download metadata <span class="token keyword">for</span> repo <span class="token string">'appstream'</span><span class="token builtin class-name">:</span> Cannot prepare internal mirrorlist: No URLs <span class="token keyword">in</span> mirrorlist

删除已有软件仓库
参考：https://developer.aliyun.com/mirror/centos?spm<span class="token operator">=</span>a2c6h.13651102.0.0.3e221b119puefY
<span class="token punctuation">[</span>root@b8216e5e3f5a /<span class="token punctuation">]</span><span class="token comment"># rm /etc/yum.repos.d/*.repo -f</span>

确认容器中存在哪个命令
<span class="token punctuation">[</span>root@b8216e5e3f5a /<span class="token punctuation">]</span><span class="token comment"># wget</span>
bash: wget: <span class="token builtin class-name">command</span> not found
<span class="token punctuation">[</span>root@b8216e5e3f5a /<span class="token punctuation">]</span><span class="token comment"># whereis curl</span>
curl: <span class="token variable"><span class="token variable">`</span>/usr/bin/curl<span class="token variable">`</span></span>


<span class="token punctuation">[</span>root@b8216e5e3f5a /<span class="token punctuation">]</span><span class="token comment"># curl -s \</span>
	https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo <span class="token punctuation">\</span>
	-o /etc/yum.repos.d/CentOS-Base.repo
 
确认仓库
<span class="token punctuation">[</span>root@b8216e5e3f5a /<span class="token punctuation">]</span><span class="token comment"># yum repolist</span>
Failed to <span class="token builtin class-name">set</span> locale, defaulting to C.UTF-8
repo <span class="token function">id</span>            repo name
AppStream          CentOS-8.5.2111 - AppStream - mirrors.aliyun.com
base               CentOS-8.5.2111 - Base - mirrors.aliyun.com
extras             CentOS-8.5.2111 - Extras - mirrors.aliyun.com

安装软件
<span class="token punctuation">[</span>root@b8216e5e3f5a /<span class="token punctuation">]</span><span class="token comment"># yum -y install httpd</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
Complete<span class="token operator">!</span>

生成索引页
<span class="token punctuation">[</span>root@b8216e5e3f5a /<span class="token punctuation">]</span><span class="token comment"># echo haha &gt; /var/www/html/index.html</span>

设置服务开机自启，立即启动
<span class="token punctuation">[</span>root@b8216e5e3f5a /<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now httpd</span>
Created symlink /etc/systemd/system/multi-user.target.wants/httpd.service → /usr/lib/systemd/system/httpd.service.

测试web站点
<span class="token punctuation">[</span>root@b8216e5e3f5a /<span class="token punctuation">]</span><span class="token comment"># curl localhost</span>
haha

退出容器
<span class="token punctuation">[</span>root@b8216e5e3f5a /<span class="token punctuation">]</span><span class="token comment"># exit</span>

<span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE     COMMAND        CREATED         STATUS         PORTS     NAMES
b8216e5e3f5a   centos    <span class="token string">&quot;/sbin/init&quot;</span>   <span class="token number">6</span> minutes ago   Up <span class="token number">6</span> minutes             <span class="token variable"><span class="token variable">`</span>test1<span class="token variable">`</span></span>
<span class="token comment"># docker images</span>
REPOSITORY   TAG       IMAGE ID       CREATED        SIZE
httpd        latest    dabbfbe0c57b   <span class="token number">2</span> months ago   144MB
ubuntu       latest    ba6acccedd29   <span class="token number">4</span> months ago   <span class="token number">72</span>.8MB
centos       latest    5d0da3dc9764   <span class="token number">5</span> months ago   231MB

将当前运行的容器，保存为新镜像
*<span class="token comment"># docker commit test1 test1</span>
sha256:f46b9612f5beb0a4233ded79399204057f0f54ac44577d74920dc38a794b998d

<span class="token comment"># docker images</span>
REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
<span class="token variable"><span class="token variable">`</span>test1<span class="token variable">`</span></span>      latest    f46b9612f5be   <span class="token number">41</span> seconds ago   280MB
httpd        latest    dabbfbe0c57b   <span class="token number">2</span> months ago     144MB
ubuntu       latest    ba6acccedd29   <span class="token number">4</span> months ago     <span class="token number">72</span>.8MB
centos       latest    5d0da3dc9764   <span class="token number">5</span> months ago     231MB

使用镜像test1，创建新的容器
<span class="token comment"># docker run --name test2 -itd --privileged test1 /sbin/init</span>
5b05167447e2743030f528e0d2dfb16cfc7d0b792a49651b583faf5e69c59561

<span class="token comment"># docker exec -it test2 /bin/bash</span>
<span class="token punctuation">[</span>root@5b05167447e2 /<span class="token punctuation">]</span><span class="token comment"># rpm -q httpd</span>
httpd-2.4.37-43.module_el8.5.0+1022+b541f3b1.x86_64
<span class="token punctuation">[</span>root@5b05167447e2 /<span class="token punctuation">]</span><span class="token comment"># cat /var/www/html/index.html </span>
haha
<span class="token punctuation">[</span>root@5b05167447e2 /<span class="token punctuation">]</span><span class="token comment"># systemctl status httpd</span>
● httpd.service - The Apache HTTP Server
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/httpd.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor pr<span class="token operator">&gt;</span>
   Active: <span class="token variable"><span class="token variable">`</span>active <span class="token punctuation">(</span>running<span class="token punctuation">)</span><span class="token variable">`</span></span> <span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@5b05167447e2 /<span class="token punctuation">]</span><span class="token comment"># curl localhost</span>
haha
<span class="token punctuation">[</span>root@5b05167447e2 /<span class="token punctuation">]</span><span class="token comment"># exit</span>

<span class="token comment"># docker history test1</span>
IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT
<span class="token variable"><span class="token variable">`</span>f46b9612f5be   <span class="token number">12</span> minutes ago   /sbin/init                                      <span class="token number">48</span>.5MB<span class="token variable">`</span></span>   
5d0da3dc9764   <span class="token number">5</span> months ago     /bin/sh -c <span class="token comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B        </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">5</span> months ago     /bin/sh -c <span class="token comment">#(nop)  LABEL org.label-schema.sc…   0B        </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">5</span> months ago     /bin/sh -c <span class="token comment">#(nop) ADD file:805cb5e15fb6e0bb0…   231MB     </span>

<span class="token comment"># docker history centos </span>
IMAGE          CREATED        CREATED BY                                      SIZE      COMMENT
5d0da3dc9764   <span class="token number">5</span> months ago   /bin/sh -c <span class="token comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B        </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">5</span> months ago   /bin/sh -c <span class="token comment">#(nop)  LABEL org.label-schema.sc…   0B        </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">5</span> months ago   /bin/sh -c <span class="token comment">#(nop) ADD file:805cb5e15fb6e0bb0…   231MB</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br></div></div><h3 id="lab10-dockfile-示例"><a href="#lab10-dockfile-示例" class="header-anchor">#</a> Lab10. dockfile 示例</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> -i

创建文件夹
<span class="token comment"># mkdir df</span>

切换目录
<span class="token comment"># cd df</span>
查看当前工作目录
<span class="token comment"># pwd</span>

生成文件 index.html
<span class="token comment"># echo haha &gt; index.html</span>
<span class="token comment"># ls</span>

*<span class="token comment"># vim dockerfile</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> httpd</span>
<span class="token instruction"><span class="token keyword">COPY</span> index.html /</span>
<span class="token instruction"><span class="token keyword">RUN</span> echo haha</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>通过 dockerfile 文件，建立 image
*<span class="token comment"># docker build -t test2 .</span>
Sending build context to Docker daemon  <span class="token number">3</span>.072kB
Step <span class="token number">1</span>/3 <span class="token builtin class-name">:</span> FROM httpd
 ---<span class="token operator">&gt;</span> a8ea074f4566
Step <span class="token number">2</span>/3 <span class="token builtin class-name">:</span> COPY index.html /
 ---<span class="token operator">&gt;</span> Using cache
 ---<span class="token operator">&gt;</span> e7056f1a4768
Step <span class="token number">3</span>/3 <span class="token builtin class-name">:</span> RUN <span class="token builtin class-name">echo</span> haha
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> bc67e25c5eb1
haha
Removing intermediate container bc67e25c5eb1
 ---<span class="token operator">&gt;</span> 55bba83d97fb
Successfully built 55bba83d97fb
Successfully tagged test2:latest

确认
<span class="token comment"># docker images</span>
REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
test2        latest    86965f4efffe   <span class="token number">3</span> minutes ago   144MB
httpd        latest    dabbfbe0c57b   <span class="token number">2</span> months ago    144MB
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="lab11-dockfile-缓存特性"><a href="#lab11-dockfile-缓存特性" class="header-anchor">#</a> Lab11. dockfile 缓存特性</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># vim dockerfile</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> httpd</span>
<span class="token instruction"><span class="token keyword">COPY</span> index.html /</span>
<span class="token instruction"><span class="token keyword">RUN</span> echo haha</span>
<span class="token instruction"><span class="token keyword">MAINTAINER</span> adder99@163.com</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>注意输出，层存在有缓存
<span class="token comment"># docker build -t test3 .</span>
Sending build context to Docker daemon  <span class="token number">3</span>.072kB
Step <span class="token number">1</span>/4 <span class="token builtin class-name">:</span> FROM httpd
 ---<span class="token operator">&gt;</span> a8ea074f4566
Step <span class="token number">2</span>/4 <span class="token builtin class-name">:</span> COPY index.html /
 ---<span class="token operator">&gt;</span> <span class="token variable"><span class="token variable">`</span>Using cache<span class="token variable">`</span></span>
 ---<span class="token operator">&gt;</span> e7056f1a4768
Step <span class="token number">3</span>/4 <span class="token builtin class-name">:</span> RUN <span class="token builtin class-name">echo</span> haha
 ---<span class="token operator">&gt;</span> <span class="token variable"><span class="token variable">`</span>Using cache<span class="token variable">`</span></span>
 ---<span class="token operator">&gt;</span> 55bba83d97fb
Step <span class="token number">4</span>/4 <span class="token builtin class-name">:</span> MAINTAINER alex@163.com
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> f1b964adca56
Removing intermediate container f1b964adca56
 ---<span class="token operator">&gt;</span> f89944ec89c8
Successfully built f89944ec89c8
Successfully tagged test3:latest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>更改指令顺序
<span class="token comment"># vim dockerfile</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> httpd</span>
<span class="token instruction"><span class="token keyword">MAINTAINER</span> adder99@163.com</span>
<span class="token instruction"><span class="token keyword">COPY</span> index.html /</span>
<span class="token instruction"><span class="token keyword">RUN</span> echo haha</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>注意输出，层变了没有缓存
<span class="token comment"># docker build -t test3 .</span>
Sending build context to Docker daemon  <span class="token number">3</span>.072kB
Step <span class="token number">1</span>/4 <span class="token builtin class-name">:</span> FROM httpd
 ---<span class="token operator">&gt;</span> a8ea074f4566
Step <span class="token number">2</span>/4 <span class="token builtin class-name">:</span> MAINTAINER alex@163.com
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 19dbfc6564bb
Removing intermediate container 19dbfc6564bb
 ---<span class="token operator">&gt;</span> f09bc419e24b
Step <span class="token number">3</span>/4 <span class="token builtin class-name">:</span> COPY index.html /
 ---<span class="token operator">&gt;</span> 814027f1d794
Step <span class="token number">4</span>/4 <span class="token builtin class-name">:</span> RUN <span class="token builtin class-name">echo</span> haha
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 50c44db04f7e
haha
Removing intermediate container 50c44db04f7e
 ---<span class="token operator">&gt;</span> 7bffb633acc0
Successfully built 7bffb633acc0
Successfully tagged test3:latest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="lab12-docker-tag"><a href="#lab12-docker-tag" class="header-anchor">#</a> 🚩 Lab12. docker tag</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>查看本地镜像
<span class="token comment"># docker images</span>
REPOSITORY   TAG       IMAGE ID       CREATED        SIZE
<span class="token variable"><span class="token variable">`</span>httpd<span class="token variable">`</span></span>        latest    dabbfbe0c57b   <span class="token number">2</span> months ago   144MB
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.

查看镜像信息
<span class="token comment"># docker image inspect httpd | grep -i version</span>
                <span class="token string">&quot;HTTPD_VERSION=2.4.52&quot;</span>,
        <span class="token string">&quot;DockerVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;20.10.7&quot;</span>,
                <span class="token string">&quot;HTTPD_VERSION=2.4.52&quot;</span>,

给镜像打个新标签
<span class="token comment"># docker tag httpd httpd:v8.6</span>

确认。ID相同，TAG不同，SIZE大小相同。它就是一个镜像
<span class="token comment"># docker images</span>
REPOSITORY    TAG        IMAGE ID         CREATED        SIZE
httpd        <span class="token variable"><span class="token variable">`</span>latest<span class="token variable">`</span></span>    <span class="token variable"><span class="token variable">`</span>dabbfbe0c57b<span class="token variable">`</span></span>   <span class="token number">2</span> months ago   144MB
httpd        <span class="token variable"><span class="token variable">`</span>v8.6<span class="token variable">`</span></span>      <span class="token variable"><span class="token variable">`</span>dabbfbe0c57b<span class="token variable">`</span></span>   <span class="token number">2</span> months ago   144MB
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="lab13-镜像仓库"><a href="#lab13-镜像仓库" class="header-anchor">#</a> Lab13. 镜像仓库</h3> <blockquote><ul><li>公共镜像仓库
<ul><li><a href="https://hub.docker.com" target="_blank" rel="noopener noreferrer">hub.docker.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>catalog.redat.com</li> <li>quay.io</li> <li>gcr.io（谷歌镜像仓库，国内默认无法访问）</li></ul></li> <li>私有镜像仓库
<ul><li><a href="https://quay.io" target="_blank" rel="noopener noreferrer">quay<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，收费</li> <li><a href="https://goharbor.io/" target="_blank" rel="noopener noreferrer">Harbor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，企业免费</li> <li><a href="https://hub.docker.com/_/registry" target="_blank" rel="noopener noreferrer">Registry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，测试</li></ul></li></ul></blockquote> <h3 id="lab13a-搭建私有registry仓库"><a href="#lab13a-搭建私有registry仓库" class="header-anchor">#</a> 🚩 Lab13a. 搭建私有registry仓库</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>创建文件夹
<span class="token comment"># mkdir /root/myregistry</span>

运行容器
*<span class="token comment"># docker run -d -p 1000:5000 \</span>
  -v /root/myregistry:/var/lib/registry registry
49ff98a0632a3526ba3ffcbab96d259375ac5c5c89a62818414ea0f17dd3d087
<span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE      COMMAND                  CREATED          STATUS          PORTS                    NAMES
49ff98a0632a   registry   <span class="token string">&quot;/entrypoint.sh /etc…&quot;</span>   <span class="token number">24</span> seconds ago   Up <span class="token number">23</span> seconds   <span class="token number">0.0</span>.0.0:1000-<span class="token operator">&gt;</span><span class="token number">5000</span>/tcp   dazzling_euclid

检查容器
<span class="token comment"># docker inspect dazzling_euclid</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
        <span class="token string">&quot;HostConfig&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;Binds&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;/root/myregistry:/var/lib/registry&quot;</span>
            <span class="token punctuation">]</span>,
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
            <span class="token string">&quot;PortBindings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;5000/tcp&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span>
                        <span class="token string">&quot;HostIp&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
                        <span class="token string">&quot;HostPort&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1000&quot;</span>
                    <span class="token punctuation">}</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.

确认监听端口
<span class="token comment"># ss -antup | grep 1000</span>
tcp   LISTEN <span class="token number">0</span>       <span class="token number">4096</span>                        *:1000                 *:*      users:<span class="token variable"><span class="token punctuation">((</span>&quot;docker<span class="token operator">-</span>proxy&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">4124</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">))</span></span>

查看本地镜像
<span class="token comment"># docker images</span>
REPOSITORY   TAG       IMAGE ID       CREATED        SIZE
httpd        v8.6      dabbfbe0c57b   <span class="token number">2</span> months ago   144MB
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.

更改标签
<span class="token comment"># docker tag httpd:v8.6 192.168.73.137:1000/httpd:v8.6</span>

上传到私有仓库，不成功
<span class="token comment"># docker push 192.168.73.137:1000/httpd:v8.6</span>
The push refers to repository <span class="token punctuation">[</span><span class="token number">192.168</span>.73.137:1000/httpd<span class="token punctuation">]</span>
Get https://192.168.73.137:1000/v2/: http: server gave HTTP response to HTTPS client

上一条命令的返回值是非0，都是不成功
<span class="token comment"># echo $?</span>
<span class="token number">1</span>

添加<span class="token string">&quot;insecure-registries&quot;</span>,注意第2行结尾的逗号
*<span class="token comment"># vim /etc/docker/daemon.json</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;registry-mirrors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://ktjk1d0g.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;insecure-registries&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;192.168.73.137:1000&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># systemctl daemon-reload</span>
<span class="token comment"># systemctl restart docker</span>

服务重启后，容器默认不会启动
<span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES

查找容器名称
<span class="token comment"># docker ps -a</span>
CONTAINER ID   IMAGE      COMMAND                  CREATED         STATUS                      PORTS     NAMES
49ff98a0632a   registry   <span class="token string">&quot;/entrypoint.sh /etc…&quot;</span>   <span class="token number">6</span> minutes ago   Exited <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">19</span> seconds ago             dazzling_euclid

启动容器
<span class="token comment"># docker start dazzling_euclid</span>
dazzling_euclid

确定端口存在，即容器启动成功
<span class="token comment"># ss -antup | grep 1000</span>
tcp   LISTEN <span class="token number">0</span>       <span class="token number">4096</span>                        *:1000                 *:*      users:<span class="token variable"><span class="token punctuation">((</span>&quot;docker<span class="token operator">-</span>proxy&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">4613</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">))</span></span>

再次推送镜像到私有镜像仓库，成功
*<span class="token comment"># docker push 192.168.73.137:1000/httpd:v8.6</span>
The push refers to repository <span class="token punctuation">[</span><span class="token number">192.168</span>.73.137:1000/httpd<span class="token punctuation">]</span>
deefaa620a71: Pushed
9cff3206f9a6: Pushed
15e4bf5d0804: Pushed
1da636a1aa95: Pushed
2edcec3590a4: Pushed
v8.6: digest: sha256:57c1e4ff150e2782a25c8cebb80b574f81f06b74944caf972f27e21b76074194 size: <span class="token number">1365</span>

确认镜像目录分层
<span class="token comment"># ls -R /root/myregistry/</span>

客户端
<span class="token comment"># curl 192.168.73.137:1000/_catalog</span>
<span class="token comment"># docker-registry-cli</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>PS: https://k8s.ruitong.cn:8443/?dir=k8s/docker-registry-cli</p> <h3 id="lab13b-搭建私有registry仓库-harbor"><a href="#lab13b-搭建私有registry仓库-harbor" class="header-anchor">#</a> 🚩 Lab13b. 搭建私有registry仓库-harbor</h3> <blockquote><p>https://goharbor.io/</p></blockquote> <ol><li><p>Make sure that your target host meets the <a href="https://goharbor.io/docs/2.5.0/install-config/installation-prereqs/" target="_blank" rel="noopener noreferrer">Harbor Installation Prerequisites<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>安裝相應軟件
$ <span class="token function">sudo</span> <span class="token function">apt</span> -y <span class="token function">install</span> <span class="token function">docker-compose</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p><a href="https://goharbor.io/docs/2.5.0/install-config/download-installer/" target="_blank" rel="noopener noreferrer">Download the Harbor Installer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -<span class="token comment"># https://k8s.ruitong.cn:8443/K8s/harbor-offline-installer-v2.6.0.tgz \</span>
  -o harbor-offline-installer-v2.6.0.tgz
  
$ <span class="token function">tar</span> -xf harbor-offline-installer-v2.6.0.tgz

$ <span class="token builtin class-name">cd</span> harbor
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p><a href="https://goharbor.io/docs/2.5.0/install-config/configure-https/" target="_blank" rel="noopener noreferrer">Configure HTTPS Access to Harbor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://goharbor.io/docs/2.5.0/install-config/configure-yml-file/" target="_blank" rel="noopener noreferrer">Configure the Harbor YML File<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">cp</span> harbor.yml.tmpl harbor.yml
$ <span class="token function">vim</span> harbor.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">...</span>省略<span class="token punctuation">...</span>
<span class="token key atrule">hostname</span><span class="token punctuation">:</span> hub.vmcc.xyz

<span class="token comment">#https:</span>
<span class="token comment">#  # https port for harbor, default is 443</span>
<span class="token comment">#  port: 443</span>
<span class="token comment">#  # The path of cert and key files for nginx</span>
<span class="token comment">#  certificate: /your/certificate/path</span>
<span class="token comment">#  private_key: /your/private/key/path</span>

<span class="token key atrule">harbor_admin_password</span><span class="token punctuation">:</span> ubuntu
<span class="token punctuation">...</span>省略<span class="token punctuation">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p><a href="https://goharbor.io/docs/2.5.0/install-config/configure-internal-tls/" target="_blank" rel="noopener noreferrer">Configure Enabling Internal TLS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://goharbor.io/docs/2.5.0/install-config/run-installer-script/" target="_blank" rel="noopener noreferrer">Run the Installer Script<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> ./install.sh
:<span class="token operator">&lt;&lt;</span><span class="token string">EOF
<span class="token variable"><span class="token variable">`</span><span class="token punctuation">[</span>Step <span class="token number">0</span><span class="token punctuation">]</span>: checking <span class="token keyword">if</span> <span class="token function">docker</span> is installed <span class="token punctuation">..</span>.<span class="token variable">`</span></span>

Note: docker version: 20.10.17

<span class="token variable"><span class="token variable">`</span><span class="token punctuation">[</span>Step <span class="token number">1</span><span class="token punctuation">]</span>: checking <span class="token function">docker-compose</span> is installed <span class="token punctuation">..</span>.<span class="token variable">`</span></span>

Note: docker-compose version: 1.29.2

<span class="token variable"><span class="token variable">`</span><span class="token punctuation">[</span>Step <span class="token number">2</span><span class="token punctuation">]</span>: loading Harbor images <span class="token punctuation">..</span>.<span class="token variable">`</span></span>
943e52e64a9c: Loading layer  37.55MB/37.55MB
ec4474eb929a: Loading layer  126.3MB/126.3MB
76a16ac76196: Loading layer  3.584kB/3.584kB
c9a227aab4d3: Loading layer  3.072kB/3.072kB
fed2fe52a194: Loading layer   2.56kB/2.56kB
f2e03a3cec12: Loading layer  3.072kB/3.072kB
8dcae4944d97: Loading layer  3.584kB/3.584kB
f65f790b33e6: Loading layer  20.99kB/20.99kB
Loaded image: goharbor/harbor-log:v2.5.1
04a4fa4755bc: Loading layer  8.682MB/8.682MB
93df81c08563: Loading layer  3.584kB/3.584kB
6746249771e3: Loading layer   2.56kB/2.56kB
39713d62ba42: Loading layer  90.78MB/90.78MB
2c6097e3483e: Loading layer  91.57MB/91.57MB
Loaded image: goharbor/harbor-jobservice:v2.5.1
28faf190784e: Loading layer  119.1MB/119.1MB
4bf648d216c7: Loading layer  3.072kB/3.072kB
8328b2227bc7: Loading layer   59.9kB/59.9kB
b2c84581a687: Loading layer  61.95kB/61.95kB
Loaded image: goharbor/redis-photon:v2.5.1
fcd508c17344: Loading layer  5.535MB/5.535MB
071bc493297d: Loading layer  90.86MB/90.86MB
7d6557033913: Loading layer  3.072kB/3.072kB
363d9d8e3c89: Loading layer  4.096kB/4.096kB
2491c9fa16fc: Loading layer  91.65MB/91.65MB
Loaded image: goharbor/chartmuseum-photon:v2.5.1
1c66a5c87d19: Loading layer    168MB/168MB
3ff2cb7516ba: Loading layer  68.07MB/68.07MB
c96114332979: Loading layer   2.56kB/2.56kB
f25097c8830a: Loading layer  1.536kB/1.536kB
4ca0e58712f2: Loading layer  12.29kB/12.29kB
3609283e5de7: Loading layer  2.621MB/2.621MB
ca6199c4adca: Loading layer  354.8kB/354.8kB
Loaded image: goharbor/prepare:v2.5.1
92e9424f3797: Loading layer  8.682MB/8.682MB
b1655572ade9: Loading layer  3.584kB/3.584kB
de9547e737b9: Loading layer   2.56kB/2.56kB
9a4ed152c42e: Loading layer  78.72MB/78.72MB
0217eee5e2af: Loading layer  5.632kB/5.632kB
4d557d233f65: Loading layer  99.84kB/99.84kB
05bb453495b9: Loading layer  15.87kB/15.87kB
3afd9c3c47dd: Loading layer  79.63MB/79.63MB
1ec26a76ac56: Loading layer   2.56kB/2.56kB
Loaded image: goharbor/harbor-core:v2.5.1
0e39ba51999a: Loading layer  5.531MB/5.531MB
435625ca67ad: Loading layer  8.543MB/8.543MB
a9c8eef7ea6e: Loading layer  15.88MB/15.88MB
e38648deeb1c: Loading layer  29.29MB/29.29MB
f3d1dca68eb7: Loading layer  22.02kB/22.02kB
fe36d72e7580: Loading layer  15.88MB/15.88MB
Loaded image: goharbor/notary-server-photon:v2.5.1
350aa4470b2f: Loading layer  7.449MB/7.449MB
Loaded image: goharbor/nginx-photon:v2.5.1
e2371f04b17f: Loading layer  5.536MB/5.536MB
83f525652b46: Loading layer  4.096kB/4.096kB
442e7fdfcbd3: Loading layer  3.072kB/3.072kB
4a3bede6780d: Loading layer  17.34MB/17.34MB
77c5aed80a3c: Loading layer  18.13MB/18.13MB
Loaded image: goharbor/registry-photon:v2.5.1
e0447020da6f: Loading layer  1.097MB/1.097MB
ae9e1371d564: Loading layer  5.889MB/5.889MB
efbccdfa4022: Loading layer  168.2MB/168.2MB
fecd4ce6ff1f: Loading layer  16.52MB/16.52MB
e37fd2d49a62: Loading layer  4.096kB/4.096kB
45ad00c4b89f: Loading layer  6.144kB/6.144kB
e11809276aac: Loading layer  3.072kB/3.072kB
627dceaf1a71: Loading layer  2.048kB/2.048kB
72eb4d7dc7c9: Loading layer   2.56kB/2.56kB
9108824fb7d5: Loading layer   2.56kB/2.56kB
8529abcd8574: Loading layer   2.56kB/2.56kB
2ee460d3eeea: Loading layer  8.704kB/8.704kB
Loaded image: goharbor/harbor-db:v2.5.1
abec2ee0ba30: Loading layer  5.536MB/5.536MB
5d044d4aa39f: Loading layer  4.096kB/4.096kB
fd7cb12cb81e: Loading layer  17.34MB/17.34MB
481df09d669e: Loading layer  3.072kB/3.072kB
95f5e25d73c1: Loading layer  29.16MB/29.16MB
8e57207b1fb7: Loading layer  47.29MB/47.29MB
Loaded image: goharbor/harbor-registryctl:v2.5.1
35d3f63a45bf: Loading layer  5.531MB/5.531MB
7d948f67c6f4: Loading layer  8.543MB/8.543MB
0a28b06c1cef: Loading layer  14.47MB/14.47MB
6c78054008db: Loading layer  29.29MB/29.29MB
8fb4eaef7a24: Loading layer  22.02kB/22.02kB
e3f995aaa1a6: Loading layer  14.47MB/14.47MB
Loaded image: goharbor/notary-signer-photon:v2.5.1
87089e743ac5: Loading layer  6.063MB/6.063MB
36c316be5ec8: Loading layer  4.096kB/4.096kB
ce490e4c64fc: Loading layer  3.072kB/3.072kB
07cf9a97147f: Loading layer  47.75MB/47.75MB
e64f08012108: Loading layer  12.62MB/12.62MB
e0e70a0ecd53: Loading layer  61.15MB/61.15MB
Loaded image: goharbor/trivy-adapter-photon:v2.5.1
adb7aaa5bd89: Loading layer  7.449MB/7.449MB
8fcf272e40b2: Loading layer  7.362MB/7.362MB
5264dfd1b912: Loading layer      1MB/1MB
Loaded image: goharbor/harbor-portal:v2.5.1
80506c5946f1: Loading layer  8.682MB/8.682MB
726e23d5e1c3: Loading layer  21.03MB/21.03MB
0f1a09a26afb: Loading layer  4.608kB/4.608kB
37e3398b412c: Loading layer  21.83MB/21.83MB
Loaded image: goharbor/harbor-exporter:v2.5.1


<span class="token variable"><span class="token variable">`</span><span class="token punctuation">[</span>Step <span class="token number">3</span><span class="token punctuation">]</span>: preparing environment <span class="token punctuation">..</span>.<span class="token variable">`</span></span>

<span class="token variable"><span class="token variable">`</span><span class="token punctuation">[</span>Step <span class="token number">4</span><span class="token punctuation">]</span>: preparing harbor configs <span class="token punctuation">..</span>.<span class="token variable">`</span></span>
prepare base dir is set to /root/harbor
WARNING:root:WARNING: HTTP protocol is insecure. Harbor will deprecate http protocol in the future. Please make sure to upgrade to https
Generated configuration file: /config/portal/nginx.conf
Generated configuration file: /config/log/logrotate.conf
Generated configuration file: /config/log/rsyslog_docker.conf
Generated configuration file: /config/nginx/nginx.conf
Generated configuration file: /config/core/env
Generated configuration file: /config/core/app.conf
Generated configuration file: /config/registry/config.yml
Generated configuration file: /config/registryctl/env
Generated configuration file: /config/registryctl/config.yml
Generated configuration file: /config/db/env
Generated configuration file: /config/jobservice/env
Generated configuration file: /config/jobservice/config.yml
Generated and saved secret to file: /data/secret/keys/secretkey
Successfully called func: create_root_cert
Generated configuration file: <span class="token variable"><span class="token variable">`</span>/compose_location/docker-compose.yml<span class="token variable">`</span></span>
Clean up the input dir

<span class="token variable"><span class="token variable">`</span><span class="token punctuation">[</span>Step <span class="token number">5</span><span class="token punctuation">]</span>: starting Harbor <span class="token punctuation">..</span>.<span class="token variable">`</span></span>
Creating network &quot;harbor_harbor&quot; with the default driver
Creating harbor-log ... done
Creating harbor-db     ... done
Creating redis         ... done
Creating registryctl   ... done
Creating registry      ... done
Creating harbor-portal ... done
Creating harbor-core   ... done
Creating harbor-jobservice ... done
Creating nginx             ... done
✔ ----Harbor has been installed and started <span class="token variable"><span class="token variable">`</span>successfully<span class="token variable">`</span></span>.----
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br></div></div></li></ol> <p>物理机-GUI</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/hosts <span class="token operator">&lt;&lt;</span><span class="token string">EOF
192.168.147.128	hub.vmcc.xyz
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>客户端-CLI</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">vim</span> /etc/docker/daemon.json
    <span class="token punctuation">{</span>
      <span class="token string">&quot;registry-mirrors&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://docker.nju.edu.cn/&quot;</span><span class="token punctuation">]</span>,
      <span class="token string">&quot;insecure-registries&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;192.168.147.128&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

$ <span class="token function">sudo</span> systemctl daemon-reload
$ <span class="token function">sudo</span> systemctl restart <span class="token function">docker</span>

$ <span class="token function">sudo</span> <span class="token function">docker-compose</span> down
$ <span class="token function">sudo</span> <span class="token function">docker-compose</span> up -d

$ <span class="token function">sudo</span> <span class="token function">docker</span> login <span class="token number">192.168</span>.147.128
admin
ubuntu

$ <span class="token function">sudo</span> <span class="token function">docker</span> tag centos <span class="token number">192.168</span>.147.128/library/centos:latest
$ <span class="token function">sudo</span> <span class="token function">docker</span> images

$ <span class="token function">sudo</span> <span class="token function">docker</span> push <span class="token number">192.168</span>.147.128/library/centos
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><img src="https://img-blog.csdnimg.cn/fe3f9a7c41b84408b605c66d48d0fbf3.png" alt="image-20221114160351740"></p> <h1 id="_3-容器网络"><a href="#_3-容器网络" class="header-anchor">#</a> 3. 容器网络</h1> <h2 id="_3-1-容器网络"><a href="#_3-1-容器网络" class="header-anchor">#</a> 3.1 容器网络</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>列出当前容器网络
<span class="token comment"># docker network ls</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">none</th> <th style="text-align:center;">host</th> <th style="text-align:center;">bridge</th></tr></thead> <tbody><tr><td style="text-align:center;">NIC</td> <td style="text-align:center;">container / <code>lo</code></td> <td style="text-align:center;">container == physical</td> <td style="text-align:center;">container / eth0-net1<br>container / eth1-net2</td></tr> <tr><td style="text-align:center;">IP</td> <td style="text-align:center;">127.0.0.1</td> <td style="text-align:center;">192.168.73.137/物理机</td> <td style="text-align:center;">172.18.0.2<br>172.10.10.3</td></tr></tbody></table> <h3 id="lab14-none-网络"><a href="#lab14-none-网络" class="header-anchor">#</a> Lab14. none 网络</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>查看none网络配置
<span class="token comment"># docker network inspect none</span>

查手册
<span class="token comment"># man docker run</span>
/--network	搜索--network
<span class="token operator">&lt;</span>n<span class="token operator">&gt;</span>					Next下一个
<span class="token operator">&lt;</span>N<span class="token operator">&gt;</span>					Next上一个
<span class="token operator">&lt;</span>q<span class="token operator">&gt;</span>					退出手册

指定网络类型，运行容器
<span class="token comment"># docker run -itd --network none centos</span>
f71cdaf893b0eb88a5010bd3d2acd356f08a33ab855cfd5a25c81acfe0f18374

<span class="token comment"># docker inspect f7</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
            <span class="token string">&quot;Networks&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;none&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                    <span class="token string">&quot;IPAMConfig&quot;</span><span class="token builtin class-name">:</span> null,
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.

进入容器，查看网络配置（只有lo）
<span class="token comment"># docker exec -it f /bin/bash</span>
<span class="token punctuation">[</span>root@f71cdaf893b0 /<span class="token punctuation">]</span><span class="token comment"># ip a</span>
<span class="token number">1</span>: <span class="token variable"><span class="token variable">`</span>lo<span class="token variable">`</span></span><span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
       
<span class="token punctuation">[</span>root@f71cdaf893b0 /<span class="token punctuation">]</span><span class="token comment"># &lt;Ctrl-D&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="lab15-host-网络"><a href="#lab15-host-网络" class="header-anchor">#</a> Lab15. host 网络</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># docker run -itd --network host --name h1 centos</span>
19eca6316c274bf5127145ca6d6ea278e707eaa43c329569c3af01c2ced1971a
<span class="token comment"># docker run -itd --network host --name h2 centos</span>
627e0a8e8e39490dc1df702fe6503de03ad8752dc6371054fa15d48d0447dd5a

<span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE     COMMAND       CREATED         STATUS         PORTS     NAMES
627e0a8e8e39   centos    <span class="token string">&quot;/bin/bash&quot;</span>   <span class="token number">3</span> seconds ago   Up <span class="token number">3</span> seconds             h2
19eca6316c27   centos    <span class="token string">&quot;/bin/bash&quot;</span>   <span class="token number">7</span> seconds ago   Up <span class="token number">7</span> seconds             h1
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.

确认本机网络
<span class="token comment"># ip a</span>
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope <span class="token function">host</span>
       valid_lft forever preferred_lft forever
<span class="token number">2</span>: ens33: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc fq_codel state UP group default qlen <span class="token number">1000</span>
    link/ether 00:0c:29:bf:e4:a0 brd ff:ff:ff:ff:ff:ff
    altname enp2s1
    inet <span class="token number">192.168</span>.73.137/24 brd <span class="token number">192.168</span>.73.255 scope global dynamic noprefixroute ens33
       valid_lft 1180sec preferred_lft 1180sec
    inet6 fe80::ecfb:a225:eb42:6279/64 scope <span class="token function">link</span> noprefixroute
       valid_lft forever preferred_lft forever
<span class="token number">3</span>: docker0: <span class="token operator">&lt;</span>NO-CARRIER,BROADCAST,MULTICAST,UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noqueue state DOWN group default
    link/ether 02:42:17:05:e2:03 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">172.17</span>.0.1/16 brd <span class="token number">172.17</span>.255.255 scope global docker0
       valid_lft forever preferred_lft forever

进入容器h1后，查看网络
<span class="token comment"># docker exec -it h1 /bin/bash</span>
<span class="token punctuation">[</span>root@kiosk-virtual-machine /<span class="token punctuation">]</span><span class="token comment"># ip a</span>
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope <span class="token function">host</span>
       valid_lft forever preferred_lft forever
<span class="token number">2</span>: ens33: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc fq_codel state UP group default qlen <span class="token number">1000</span>
    link/ether 00:0c:29:bf:e4:a0 brd ff:ff:ff:ff:ff:ff
    altname enp2s1
    inet <span class="token number">192.168</span>.73.137/24 brd <span class="token number">192.168</span>.73.255 scope global dynamic noprefixroute ens33
       valid_lft 1154sec preferred_lft 1154sec
    inet6 fe80::ecfb:a225:eb42:6279/64 scope <span class="token function">link</span> noprefixroute
       valid_lft forever preferred_lft forever
<span class="token number">3</span>: docker0: <span class="token operator">&lt;</span>NO-CARRIER,BROADCAST,MULTICAST,UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noqueue state DOWN group default
    link/ether 02:42:17:05:e2:03 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">172.17</span>.0.1/16 brd <span class="token number">172.17</span>.255.255 scope global docker0
       valid_lft forever preferred_lft forever
<span class="token punctuation">[</span>root@kiosk-virtual-machine /<span class="token punctuation">]</span><span class="token comment"># exit</span>

进入容器h2后，查看网络
<span class="token comment"># docker exec -it h2 /bin/bash</span>
<span class="token punctuation">[</span>root@kiosk-virtual-machine /<span class="token punctuation">]</span><span class="token comment"># ip a</span>
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope <span class="token function">host</span>
       valid_lft forever preferred_lft forever
<span class="token number">2</span>: ens33: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc fq_codel state UP group default qlen <span class="token number">1000</span>
    link/ether 00:0c:29:bf:e4:a0 brd ff:ff:ff:ff:ff:ff
    altname enp2s1
    inet <span class="token number">192.168</span>.73.137/24 brd <span class="token number">192.168</span>.73.255 scope global dynamic noprefixroute ens33
       valid_lft 1133sec preferred_lft 1133sec
    inet6 fe80::ecfb:a225:eb42:6279/64 scope <span class="token function">link</span> noprefixroute
       valid_lft forever preferred_lft forever
<span class="token number">3</span>: docker0: <span class="token operator">&lt;</span>NO-CARRIER,BROADCAST,MULTICAST,UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noqueue state DOWN group default
    link/ether 02:42:17:05:e2:03 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">172.17</span>.0.1/16 brd <span class="token number">172.17</span>.255.255 scope global docker0
       valid_lft forever preferred_lft forever
<span class="token punctuation">[</span>root@kiosk-virtual-machine /<span class="token punctuation">]</span><span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><h3 id="lab16-bridge-网络"><a href="#lab16-bridge-网络" class="header-anchor">#</a> Lab16. Bridge 网络</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>查看所有网卡，包含docker0
<span class="token comment"># ip a</span>
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope <span class="token function">host</span>
       valid_lft forever preferred_lft forever
<span class="token number">2</span>: ens33: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc fq_codel state UP group default qlen <span class="token number">1000</span>
    link/ether 00:0c:29:bf:e4:a0 brd ff:ff:ff:ff:ff:ff
    altname enp2s1
    inet <span class="token number">192.168</span>.73.137/24 brd <span class="token number">192.168</span>.73.255 scope global dynamic noprefixroute ens33
       valid_lft 1175sec preferred_lft 1175sec
    inet6 fe80::ecfb:a225:eb42:6279/64 scope <span class="token function">link</span> noprefixroute
       valid_lft forever preferred_lft forever
<span class="token number">3</span>: <span class="token variable"><span class="token variable">`</span>docker0<span class="token variable">`</span></span><span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>NO-CARRIER,BROADCAST,MULTICAST,UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noqueue state DOWN group default
    link/ether 02:42:17:05:e2:03 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">172.17</span>.0.1/16 brd <span class="token number">172.17</span>.255.255 scope global docker0
       valid_lft forever preferred_lft forever

默认未安装
<span class="token comment"># ifconfig</span>

Command <span class="token string">'ifconfig'</span> not found, but can be installed with:

<span class="token function">apt</span> <span class="token function">install</span> net-tools

按提示安装
<span class="token comment"># apt install net-tools</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.

<span class="token comment"># ifconfig</span>
<span class="token variable"><span class="token variable">`</span>docker0<span class="token variable">`</span></span><span class="token builtin class-name">:</span> <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">409</span><span class="token operator"><span class="token file-descriptor important">9</span>&lt;</span>UP,BROADCAST,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1500</span>
        inet <span class="token number">172.17</span>.0.1  netmask <span class="token number">255.255</span>.0.0  broadcast <span class="token number">172.17</span>.255.255
        ether 02:42:17:05:e2:03  txqueuelen <span class="token number">0</span>  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets <span class="token number">0</span>  bytes <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>
        RX errors <span class="token number">0</span>  dropped <span class="token number">0</span>  overruns <span class="token number">0</span>  frame <span class="token number">0</span>
        TX packets <span class="token number">0</span>  bytes <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>
        TX errors <span class="token number">0</span>  dropped <span class="token number">0</span> overruns <span class="token number">0</span>  carrier <span class="token number">0</span>  collisions <span class="token number">0</span>

ens33: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">416</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1500</span>
        inet <span class="token number">192.168</span>.73.137  netmask <span class="token number">255.255</span>.255.0  broadcast <span class="token number">192.168</span>.73.255
        inet6 fe80::ecfb:a225:eb42:6279  prefixlen <span class="token number">64</span>  scopeid 0x2<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>link<span class="token operator">&gt;</span>
        ether 00:0c:29:bf:e4:a0  txqueuelen <span class="token number">1000</span>  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets <span class="token number">3169</span>  bytes <span class="token number">679722</span> <span class="token punctuation">(</span><span class="token number">679.7</span> KB<span class="token punctuation">)</span>
        RX errors <span class="token number">0</span>  dropped <span class="token number">0</span>  overruns <span class="token number">0</span>  frame <span class="token number">0</span>
        TX packets <span class="token number">1985</span>  bytes <span class="token number">242632</span> <span class="token punctuation">(</span><span class="token number">242.6</span> KB<span class="token punctuation">)</span>
        TX errors <span class="token number">0</span>  dropped <span class="token number">0</span> overruns <span class="token number">0</span>  carrier <span class="token number">0</span>  collisions <span class="token number">0</span>

lo: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">7</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class="token operator">&gt;</span>  mtu <span class="token number">65536</span>
        inet <span class="token number">127.0</span>.0.1  netmask <span class="token number">255.0</span>.0.0
        inet6 ::1  prefixlen <span class="token number">128</span>  scopeid 0x1<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>host<span class="token operator">&gt;</span>
        loop  txqueuelen <span class="token number">1000</span>  <span class="token punctuation">(</span>Local Loopback<span class="token punctuation">)</span>
        RX packets <span class="token number">544</span>  bytes <span class="token number">50523</span> <span class="token punctuation">(</span><span class="token number">50.5</span> KB<span class="token punctuation">)</span>
        RX errors <span class="token number">0</span>  dropped <span class="token number">0</span>  overruns <span class="token number">0</span>  frame <span class="token number">0</span>
        TX packets <span class="token number">544</span>  bytes <span class="token number">50523</span> <span class="token punctuation">(</span><span class="token number">50.5</span> KB<span class="token punctuation">)</span>
        TX errors <span class="token number">0</span>  dropped <span class="token number">0</span> overruns <span class="token number">0</span>  carrier <span class="token number">0</span>  collisions <span class="token number">0</span>

<span class="token comment"># ifconfig docker0</span>
docker0: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">409</span><span class="token operator"><span class="token file-descriptor important">9</span>&lt;</span>UP,BROADCAST,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1500</span>
        inet <span class="token number">172.17</span>.0.1  netmask <span class="token number">255.255</span>.0.0  broadcast <span class="token number">172.17</span>.255.255
        ether 02:42:17:05:e2:03  txqueuelen <span class="token number">0</span>  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets <span class="token number">0</span>  bytes <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>
        RX errors <span class="token number">0</span>  dropped <span class="token number">0</span>  overruns <span class="token number">0</span>  frame <span class="token number">0</span>
        TX packets <span class="token number">0</span>  bytes <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>
        TX errors <span class="token number">0</span>  dropped <span class="token number">0</span> overruns <span class="token number">0</span>  carrier <span class="token number">0</span>  collisions <span class="token number">0</span>

<span class="token comment"># docker network inspect bridge</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
        <span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;bridge&quot;</span>,
        <span class="token string">&quot;EnableIPv6&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;IPAM&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;default&quot;</span>,
            <span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span> null,
            <span class="token string">&quot;Config&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token string">&quot;Subnet&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.17.0.0/16&quot;</span>,
                    <span class="token string">&quot;Gateway&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.17.0.1&quot;</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.

启动容器后，<span class="token operator">&lt;</span>Ctrl-C<span class="token operator">&gt;</span>终止
<span class="token comment"># docker run -it --name httpd1 httpd</span>
AH00558: httpd: Could not reliably determine the server<span class="token string">'s fully qualified domain name, using 172.17.0.2. Set the '</span>ServerName<span class="token string">' directive globally to suppress this message
AH00558: httpd: Could not reliably determine the server'</span>s fully qualified domain name, using <span class="token number">172.17</span>.0.2. Set the <span class="token string">'ServerName'</span> directive globally to suppress this message
<span class="token punctuation">[</span>Tue Mar 08 <span class="token number">14</span>:37:18.605673 <span class="token number">2022</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>mpm_event:notice<span class="token punctuation">]</span> <span class="token punctuation">[</span>pid <span class="token number">1</span>:tid <span class="token number">140469840489792</span><span class="token punctuation">]</span> AH00489: Apache/2.4.52 <span class="token punctuation">(</span>Unix<span class="token punctuation">)</span> configured -- resuming normal operations
<span class="token punctuation">[</span>Tue Mar 08 <span class="token number">14</span>:37:18.610004 <span class="token number">2022</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>core:notice<span class="token punctuation">]</span> <span class="token punctuation">[</span>pid <span class="token number">1</span>:tid <span class="token number">140469840489792</span><span class="token punctuation">]</span> AH00094: Command line: <span class="token string">'httpd -D FOREGROUND'</span>
^C
<span class="token punctuation">[</span>Tue Mar 08 <span class="token number">14</span>:37:47.709363 <span class="token number">2022</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>mpm_event:notice<span class="token punctuation">]</span> <span class="token punctuation">[</span>pid <span class="token number">1</span>:tid <span class="token number">140469840489792</span><span class="token punctuation">]</span> AH00491: caught SIGTERM, shutting down


<span class="token comment"># docker start httpd1</span>
httpd1

确认<span class="token string">&quot;NetworkID&quot;</span>和docker0的ID相同，<span class="token string">&quot;IPAddress&quot;</span>同网段
<span class="token comment"># docker inspect httpd1</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
                    <span class="token string">&quot;NetworkID&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;41ff0dd08d0dc2fc3a024dd11220d28a765b9259b4cb3bf30fd472e5d0249de8&quot;</span>,
                    <span class="token string">&quot;EndpointID&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;7081c6af7c0a6804bc0037999c256c8c5b02f5dedeea26e48caa36775afcb667&quot;</span>,
                    <span class="token string">&quot;Gateway&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.17.0.1&quot;</span>,
                    <span class="token string">&quot;IPAddress&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.17.0.2&quot;</span>,
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.

<span class="token comment"># ifconfig docker0</span>
docker0: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">416</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1500</span>
        inet <span class="token variable"><span class="token variable">`</span><span class="token number">172.17</span>.0.1<span class="token variable">`</span></span>  netmask <span class="token number">255.255</span>.0.0  broadcast <span class="token number">172.17</span>.255.255
        inet6 fe80::42:17ff:fe05:e203  prefixlen <span class="token number">64</span>  scopeid 0x2<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>link<span class="token operator">&gt;</span>
        ether 02:42:17:05:e2:03  txqueuelen <span class="token number">0</span>  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets <span class="token number">0</span>  bytes <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>
        RX errors <span class="token number">0</span>  dropped <span class="token number">0</span>  overruns <span class="token number">0</span>  frame <span class="token number">0</span>
        TX packets <span class="token number">28</span>  bytes <span class="token number">4247</span> <span class="token punctuation">(</span><span class="token number">4.2</span> KB<span class="token punctuation">)</span>
        TX errors <span class="token number">0</span>  dropped <span class="token number">0</span> overruns <span class="token number">0</span>  carrier <span class="token number">0</span>  collisions <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># docker network create --driver bridge net1</span>
f420579a43392df4df8a0140252aa1f5ae77487acbed5a0377c3e0fdaafc4a44
<span class="token comment"># docker network ls</span>
NETWORK ID     NAME      DRIVER    SCOPE
41ff0dd08d0d   bridge    bridge    <span class="token builtin class-name">local</span>
ab5baf7233d9   <span class="token function">host</span>      <span class="token function">host</span>      <span class="token builtin class-name">local</span>
f420579a4339   net1      bridge    <span class="token builtin class-name">local</span>
8f6bcfc84d2b   none      null      <span class="token builtin class-name">local</span>

<span class="token comment"># docker network inspect net1</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
        <span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;bridge&quot;</span>,
        <span class="token string">&quot;EnableIPv6&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;IPAM&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;default&quot;</span>,
            <span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,
            <span class="token string">&quot;Config&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token string">&quot;Subnet&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.18.0.0/16&quot;</span>,
                    <span class="token string">&quot;Gateway&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.18.0.1&quot;</span>

<span class="token comment"># docker network create --driver bridge --subnet 172.10.10.0/24 --gateway 172.10.10.1 net2</span>
33ccdc950e0327b18b4e281bd9ac9300223ffdd8a229a2c3a235d79f6524aa12
<span class="token comment"># docker network ls</span>
NETWORK ID     NAME      DRIVER    SCOPE
41ff0dd08d0d   bridge    bridge    <span class="token builtin class-name">local</span>
ab5baf7233d9   <span class="token function">host</span>      <span class="token function">host</span>      <span class="token builtin class-name">local</span>
f420579a4339   net1      bridge    <span class="token builtin class-name">local</span>
33ccdc950e03   <span class="token variable"><span class="token variable">`</span>net2<span class="token variable">`</span></span>      bridge    <span class="token builtin class-name">local</span>
8f6bcfc84d2b   none      null      <span class="token builtin class-name">local</span>

c1 net1
<span class="token comment"># docker run -itd --name c1 --network net1 centos</span>
609835dad8b5ed94f8a534f50cf926b0f07d54bb4069800dd2f097f6435e6718

c2 net2, dynamic
<span class="token comment"># docker run -itd --name c2 --network net2 centos</span>
930630ec62393b25302324f2fa5abb07f0a023fd2b58744849fb5c77445da78c

c3 net2, static
<span class="token comment"># docker run -itd --name c3 --network net2 --ip 172.10.10.10 centos</span>
4cd271c0750b98ea6f035d0341c603018d41526abec29c6ed3d23fe9c96e83d0

<span class="token comment"># docker inspect c1 | grep -i ipaddress</span>
            <span class="token string">&quot;SecondaryIPAddresses&quot;</span><span class="token builtin class-name">:</span> null,
            <span class="token string">&quot;IPAddress&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
                    <span class="token string">&quot;IPAddress&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.18.0.2&quot;</span>,
<span class="token comment"># docker inspect c2 | grep -i ipaddress</span>
            <span class="token string">&quot;SecondaryIPAddresses&quot;</span><span class="token builtin class-name">:</span> null,
            <span class="token string">&quot;IPAddress&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
                    <span class="token string">&quot;IPAddress&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.10.10.2&quot;</span>,
<span class="token comment"># docker inspect c3 | grep -i ipaddress</span>
            <span class="token string">&quot;SecondaryIPAddresses&quot;</span><span class="token builtin class-name">:</span> null,
            <span class="token string">&quot;IPAddress&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
                    <span class="token string">&quot;IPAddress&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.10.10.10&quot;</span>,

网络通
<span class="token comment"># docker exec -it c2 ping -c 4 172.10.10.10</span>
PING <span class="token number">172.10</span>.10.10 <span class="token punctuation">(</span><span class="token number">172.10</span>.10.10<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">172.10</span>.10.10: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.061</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.10</span>.10.10: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.067</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.10</span>.10.10: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.058</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.10</span>.10.10: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.051</span> ms

--- <span class="token number">172.10</span>.10.10 <span class="token function">ping</span> statistics ---
<span class="token number">4</span> packets transmitted, <span class="token number">4</span> received, <span class="token number">0</span>% packet loss, <span class="token function">time</span> 3050ms
rtt min/avg/max/mdev <span class="token operator">=</span> <span class="token number">0.051</span>/0.059/0.067/0.007 ms

网络不通，使用组合键<span class="token operator">&lt;</span>Ctrl-C<span class="token operator">&gt;</span>
<span class="token comment"># docker exec -it c2 ping -c 4 172.18.0.2</span>
PING <span class="token number">172.18</span>.0.2 <span class="token punctuation">(</span><span class="token number">172.18</span>.0.2<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
^C
--- <span class="token number">172.18</span>.0.2 <span class="token function">ping</span> statistics ---
<span class="token number">4</span> packets transmitted, <span class="token number">0</span> received, <span class="token number">100</span>% packet loss, <span class="token function">time</span> 3064ms

将容器c1添加到net2桥接网络
<span class="token comment"># docker network connect net2 c1</span>
<span class="token comment"># docker inspect c1 | grep -i ipaddress</span>
            <span class="token string">&quot;SecondaryIPAddresses&quot;</span><span class="token builtin class-name">:</span> null,
            <span class="token string">&quot;IPAddress&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
                    <span class="token string">&quot;IPAddress&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.18.0.2&quot;</span>,
                    <span class="token string">&quot;IPAddress&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.10.10.3&quot;</span>,

网络全通
<span class="token comment"># docker exec -it c1 ping -c 1 172.10.10.1</span>
PING <span class="token number">172.10</span>.10.1 <span class="token punctuation">(</span><span class="token number">172.10</span>.10.1<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">172.10</span>.10.1: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.083</span> ms

--- <span class="token number">172.10</span>.10.1 <span class="token function">ping</span> statistics ---
<span class="token number">1</span> packets transmitted, <span class="token number">1</span> received, <span class="token number">0</span>% packet loss, <span class="token function">time</span> 0ms
rtt min/avg/max/mdev <span class="token operator">=</span> <span class="token number">0.083</span>/0.083/0.083/0.000 ms
<span class="token comment"># docker exec -it c1 ping -c 1 172.10.10.10</span>
PING <span class="token number">172.10</span>.10.10 <span class="token punctuation">(</span><span class="token number">172.10</span>.10.10<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">172.10</span>.10.10: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.090</span> ms

--- <span class="token number">172.10</span>.10.10 <span class="token function">ping</span> statistics ---
<span class="token number">1</span> packets transmitted, <span class="token number">1</span> received, <span class="token number">0</span>% packet loss, <span class="token function">time</span> 0ms
rtt min/avg/max/mdev <span class="token operator">=</span> <span class="token number">0.090</span>/0.090/0.090/0.000 ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div></div><h1 id="_4-容器存储"><a href="#_4-容器存储" class="header-anchor">#</a> 4. 容器存储</h1> <h2 id="_4-1-容器存储机制"><a href="#_4-1-容器存储机制" class="header-anchor">#</a> 4.1 容器存储机制</h2> <table><thead><tr><th style="text-align:center;">ID</th> <th></th> <th></th> <th></th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td>tmpfs</td> <td></td> <td>默认新建的容器，数据存在内存当中</td></tr> <tr><td style="text-align:center;">2</td> <td>volume</td> <td>-v 容器内的路径</td> <td>宿主机路径不存在，会自动创建==/var/lib/docker/volumes/...==</td></tr> <tr><td style="text-align:center;">3</td> <td>bind mount</td> <td>-v 宿主机路径:容器内路径</td> <td>宿主机路径不存在，会自动创建</td></tr></tbody></table> <h3 id="lab17-持久存储之volume"><a href="#lab17-持久存储之volume" class="header-anchor">#</a> Lab17. 持久存储之volume</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>列出卷
<span class="token comment"># docker volume ls</span>
DRIVER    VOLUME NAME

查看容器web站点主目录
<span class="token comment"># docker run -d httpd</span>
2b969d04cae5d6e1c6963573405679bf9bf7246c7f2624e948bca5922eced61b
<span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE     COMMAND              CREATED         STATUS         PORTS     NAMES
2b969d04cae5   httpd     <span class="token string">&quot;httpd-foreground&quot;</span>   <span class="token number">4</span> seconds ago   Up <span class="token number">3</span> seconds   <span class="token number">80</span>/tcp    strange_tu
<span class="token comment"># docker exec -it strange_tu /bin/bash</span>
root@2b969d04cae5:/usr/local/apache2<span class="token comment"># ls /usr/local/apache2/conf/httpd.conf</span>
root@2b969d04cae5:/usr/local/apache2<span class="token comment"># grep ^DocumentRoot /usr/local/apache2/conf/httpd.conf</span>
DocumentRoot <span class="token string">&quot;/usr/local/apache2/htdocs&quot;</span>
root@2b969d04cae5:/usr/local/apache2<span class="token comment">#</span>
<span class="token builtin class-name">exit</span>

-v只要有这个选项，主是持久存储
<span class="token comment"># docker run -d -p 8080:80 -v /usr/local/apache2/htdocs/ httpd</span>
67b946992c5225bf642be94faf734b84ec4fc280d33bab43f8cd3ec6d6ad6d0a
<span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE     COMMAND              CREATED         STATUS         PORTS                  NAMES
67b946992c52   httpd     <span class="token string">&quot;httpd-foreground&quot;</span>   <span class="token number">2</span> seconds ago   Up <span class="token number">2</span> seconds   <span class="token number">0.0</span>.0.0:8080-<span class="token operator">&gt;</span><span class="token number">80</span>/tcp   <span class="token variable"><span class="token variable">`</span>agitated_chatelet<span class="token variable">`</span></span>
2b969d04cae5   httpd     <span class="token string">&quot;httpd-foreground&quot;</span>   <span class="token number">2</span> minutes ago   Up <span class="token number">2</span> minutes   <span class="token number">80</span>/tcp                 strange_tu

<span class="token comment"># docker volume ls</span>
DRIVER    VOLUME NAME
<span class="token builtin class-name">local</span>     <span class="token variable"><span class="token variable">`</span>1e68643dc6221b2b19e072e03f428ef52c216c6ee9f09d2da50d811fa71b5ab9<span class="token variable">`</span></span>

<span class="token comment"># docker volume inspect 1e68643dc6221b2b19e072e03f428ef52c216c6ee9f09d2da50d811fa71b5ab9</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
        <span class="token string">&quot;Mountpoint&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/var/lib/docker/volumes/1e68643dc6221b2b19e072e03f428ef52c216c6ee9f09d2da50d811fa71b5ab9/_data&quot;</span>,
        <span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1e68643dc6221b2b19e072e03f428ef52c216c6ee9f09d2da50d811fa71b5ab9&quot;</span>,
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.

<span class="token comment"># docker inspect agitated_chatelet</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
        <span class="token string">&quot;Mounts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token string">&quot;Type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;volume&quot;</span>,
                <span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1e68643dc6221b2b19e072e03f428ef52c216c6ee9f09d2da50d811fa71b5ab9&quot;</span>,
                <span class="token string">&quot;Source&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/var/lib/docker/volumes/1e68643dc6221b2b19e072e03f428ef52c216c6ee9f09d2da50d811fa71b5ab9/_data&quot;</span>,
                <span class="token string">&quot;Destination&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/usr/local/apache2/htdocs&quot;</span>,
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.

<span class="token comment"># cat /var/lib/docker/volumes/1e68643dc6221b2b19e072e03f428ef52c216c6ee9f09d2da50d811fa71b5ab9/_data/index.html</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
<span class="token comment"># curl http://localhost:8080</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>修改本地（宿主机）文件，自动 <span class="token function">docker</span> <span class="token function">cp</span>
<span class="token comment"># echo haha &gt; /var/lib/docker/volumes/1e68643dc6221b2b19e072e03f428ef52c216c6ee9f09d2da50d811fa71b5ab9/_data/index.html</span>
<span class="token comment"># curl http://localhost:8080</span>
haha
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>默认运行的容器不可删除
<span class="token comment"># docker rm agitated_chatelet</span>
Error response from daemon: You cannot remove a running container 67b946992c5225bf642be94faf734b84ec4fc280d33bab43f8cd3ec6d6ad6d0a. Stop the container before attempting removal or force remove

--force可强制删除正在运行的容器
<span class="token comment"># docker rm agitated_chatelet --force</span>
agitated_chatelet

容器删除后，卷依然存在
<span class="token comment"># docker volume ls</span>
DRIVER    VOLUME NAME
<span class="token builtin class-name">local</span>     1e68643dc6221b2b19e072e03f428ef52c216c6ee9f09d2da50d811fa71b5ab9

卷存在<span class="token operator">==</span> 文件存在
<span class="token comment"># cat /var/lib/docker/volumes/1e68643dc6221b2b19e072e03f428ef52c216c6ee9f09d2da50d811fa71b5ab9/_data/index.html</span>
haha
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>可以手动删除卷
<span class="token comment"># docker volume rm 1e68643dc6221b2b19e072e03f428ef52c216c6ee9f09d2da50d811fa71b5ab9</span>
1e68643dc6221b2b19e072e03f428ef52c216c6ee9f09d2da50d811fa71b5ab9

确认卷删除
<span class="token comment"># docker volume ls</span>
DRIVER    VOLUME NAME
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="lab18-持久存储之bind-mount"><a href="#lab18-持久存储之bind-mount" class="header-anchor">#</a> Lab18. 持久存储之bind mount</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># ls /root</span>
<span class="token function">df</span>  myregistry  snap
<span class="token comment"># docker run -d -p 8081:80 -v /root/htdocs:/usr/local/apache2/htdocs/ httpd</span>
271527b345fdcfc444948856a456b4d160305b30b3f2b5b1ec1d864c648fc18c

<span class="token comment"># ls -d /root/htdocs/</span>

<span class="token comment"># echo haha &gt; /root/htdocs/index.html</span>
<span class="token comment"># curl http://localhost:8081</span>
haha

<span class="token comment"># docker exec -it 27 /bin/bash</span>
root@271527b345fd:/usr/local/apache2<span class="token comment"># cat /usr/local/apache2/htdocs/index.html</span>
haha
root@271527b345fd:/usr/local/apache2<span class="token comment">#</span>
<span class="token builtin class-name">exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># docker stop 27</span>
<span class="token number">27</span>
<span class="token comment"># docker rm 27</span>
<span class="token number">27</span>
<span class="token comment"># ls /root/htdocs/</span>
index.html
<span class="token comment"># cat /root/htdocs/index.html</span>
haha
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_4-2-数据共享"><a href="#_4-2-数据共享" class="header-anchor">#</a> 4.2 数据共享</h2> <h3 id="lab19-容器间数据共享之bind-mount"><a href="#lab19-容器间数据共享之bind-mount" class="header-anchor">#</a> Lab19. 容器间数据共享之bind mount</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># docker run -d --name h1 -p 1001:80 -v /root/htdocs:/usr/local/apache2/htdocs httpd</span>
f0a55b1b960c81231d764301e0b62c358dc391fcb49f93f4db0aa7fe29188a01
<span class="token comment"># docker run -d --name h2 -p 1002:80 -v /root/htdocs:/usr/local/apache2/htdocs httpd</span>
e8916f0ca1403171799c8ae4c4b3839aaa4f0a62bf1fed0c7fd20ef8dbef29ad

<span class="token comment"># cat /root/htdocs/index.html</span>
haha
<span class="token comment"># curl localhost:1001</span>
haha
<span class="token comment"># curl localhost:1002</span>
haha

<span class="token comment"># echo hehe &gt; /root/htdocs/index.html</span>
<span class="token comment"># cat /root/htdocs/index.html</span>
hehe
<span class="token comment"># curl localhost:1001</span>
hehe
<span class="token comment"># curl localhost:1002</span>
hehe
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="lab20-容器间数据共享之volume-container"><a href="#lab20-容器间数据共享之volume-container" class="header-anchor">#</a> Lab20.容器间数据共享之volume container</h3> <blockquote><p>--volumes-from 容器名</p> <p>新创建的容器，卷类型从上一个容器复制 == 卷类型相同</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>新建容器vc，使用bind mount方式
<span class="token comment"># docker run -d --name vc -v /root/htdocs:/usr/local/apache2/htdocs httpd</span>
075513aeddd3c7c771df60911f69e3b003cbce633650a547343586095bd7c39a

列出容器名称
<span class="token comment"># docker run -d --name h3 -p 1003:80 \</span>
  --volumes-from <span class="token operator">&lt;</span>Tab<span class="token operator">&gt;</span><span class="token operator">&lt;</span>Tab<span class="token operator">&gt;</span>
h1  h2  vc

新建两个容器，使用vc容器的卷
<span class="token comment"># docker run -d --name h3 -p 1003:80 --volumes-from vc httpd</span>
d10673dd799c822c52dd6355e89aa1a55a0cf601412369a30589d8ca71bcdae3
<span class="token comment"># docker run -d --name h4 -p 1004:80 --volumes-from vc httpd</span>
45c905078444e1e47d775fd340d05891878775a99cae05803eb69b17e95f53c1

检查配置信息
<span class="token comment"># docker inspect vc | grep -A 4 Mounts</span>
        <span class="token string">&quot;Mounts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token string">&quot;Type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;bind&quot;</span>,
                <span class="token string">&quot;Source&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/root/htdocs&quot;</span>,
                <span class="token string">&quot;Destination&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/usr/local/apache2/htdocs&quot;</span>,
<span class="token comment"># docker inspect h3 | grep -A 4 Mounts</span>
        <span class="token string">&quot;Mounts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token string">&quot;Type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;bind&quot;</span>,
                <span class="token string">&quot;Source&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/root/htdocs&quot;</span>,
                <span class="token string">&quot;Destination&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/usr/local/apache2/htdocs&quot;</span>,
<span class="token comment"># docker inspect h4 | grep -A 4 Mounts</span>
        <span class="token string">&quot;Mounts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token string">&quot;Type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;bind&quot;</span>,
                <span class="token string">&quot;Source&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/root/htdocs&quot;</span>,
                <span class="token string">&quot;Destination&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/usr/local/apache2/htdocs&quot;</span>,

测试
<span class="token comment"># echo new &gt; /root/htdocs/index.html</span>

<span class="token assign-left variable">1003</span><span class="token operator">==</span>h3容器的内容，1004<span class="token operator">==</span>h4容器的内容
<span class="token comment"># curl localhost:1003</span>
new
<span class="token comment"># curl localhost:1004</span>
new
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h1 id="_5-容器底层实现技术"><a href="#_5-容器底层实现技术" class="header-anchor">#</a> 5. 容器底层实现技术</h1> <h2 id="_5-1-namespace-和-cgroup"><a href="#_5-1-namespace-和-cgroup" class="header-anchor">#</a> 5.1 Namespace 和 Cgroup</h2> <h3 id="lab21-namespace和cgroup"><a href="#lab21-namespace和cgroup" class="header-anchor">#</a> Lab21. Namespace和Cgroup</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># docker run -itd centos /bin/bash</span>
c7ca03f322fa999926bee76c56920c03a2729aa7e5481c4d3388207c78b23ebd
<span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE     COMMAND       CREATED         STATUS         PORTS     NAMES
c7ca03f322fa   centos    <span class="token string">&quot;/bin/bash&quot;</span>   <span class="token number">4</span> seconds ago   Up <span class="token number">3</span> seconds             hardcore_spence

容器中的进程ID为 <span class="token number">1</span>
<span class="token comment"># docker exec -it c ps axf</span>
    PID TTY      STAT   TIME COMMAND
     <span class="token number">14</span> pts/1    Rs+    <span class="token number">0</span>:00 <span class="token function">ps</span> axf
    <span class="token variable"><span class="token variable">`</span><span class="token number">1</span><span class="token variable">`</span></span> pts/0    Ss+    <span class="token number">0</span>:00 /bin/bash

宿主机中的进程ID为 <span class="token number">2621</span>
<span class="token comment"># docker inspect c7ca03f322fa | grep -i pid</span>
            <span class="token string">&quot;Pid&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2621</span>,
            <span class="token string">&quot;PidMode&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
            <span class="token string">&quot;PidsLimit&quot;</span><span class="token builtin class-name">:</span> null,
<span class="token comment"># ps aux | grep 2621</span>
root       <span class="token variable"><span class="token variable">`</span><span class="token number">2621</span><span class="token variable">`</span></span> <span class="token number">0.0</span>  <span class="token number">0.0</span>  <span class="token number">12052</span>  <span class="token number">3048</span> pts/0    Ss+  <span class="token number">16</span>:18   <span class="token number">0</span>:00 /bin/bash
root        <span class="token number">2752</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>  <span class="token number">12116</span>   <span class="token number">720</span> pts/1    S+   <span class="token number">16</span>:20   <span class="token number">0</span>:00 <span class="token function">grep</span> --color<span class="token operator">=</span>auto <span class="token number">2621</span>

<span class="token comment"># ls -l /proc/2621/ns/</span>
total <span class="token number">0</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> <span class="token number">3</span>月  <span class="token number">15</span> <span class="token number">16</span>:22 cgroup -<span class="token operator">&gt;</span> <span class="token string">'cgroup:[4026531835]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> <span class="token number">3</span>月  <span class="token number">15</span> <span class="token number">16</span>:19 ipc -<span class="token operator">&gt;</span> <span class="token string">'ipc:[4026532602]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> <span class="token number">3</span>月  <span class="token number">15</span> <span class="token number">16</span>:19 mnt -<span class="token operator">&gt;</span> <span class="token string">'mnt:[4026532600]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> <span class="token number">3</span>月  <span class="token number">15</span> <span class="token number">16</span>:18 net -<span class="token operator">&gt;</span> <span class="token string">'net:[4026532605]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> <span class="token number">3</span>月  <span class="token number">15</span> <span class="token number">16</span>:19 pid -<span class="token operator">&gt;</span> <span class="token string">'pid:[4026532603]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> <span class="token number">3</span>月  <span class="token number">15</span> <span class="token number">16</span>:22 pid_for_children -<span class="token operator">&gt;</span> <span class="token string">'pid:[4026532603]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> <span class="token number">3</span>月  <span class="token number">15</span> <span class="token number">16</span>:22 <span class="token function">time</span> -<span class="token operator">&gt;</span> <span class="token string">'time:[4026531834]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> <span class="token number">3</span>月  <span class="token number">15</span> <span class="token number">16</span>:22 time_for_children -<span class="token operator">&gt;</span> <span class="token string">'time:[4026531834]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> <span class="token number">3</span>月  <span class="token number">15</span> <span class="token number">16</span>:22 user -<span class="token operator">&gt;</span> <span class="token string">'user:[4026531837]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> <span class="token number">3</span>月  <span class="token number">15</span> <span class="token number">16</span>:19 uts -<span class="token operator">&gt;</span> <span class="token string">'uts:[4026532601]'</span>

<span class="token comment"># docker exec -it hardcore_spence /bin/bash</span>
<span class="token punctuation">[</span>root@c7ca03f322fa /<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@c7ca03f322fa /<span class="token punctuation">]</span><span class="token comment"># ls -l /proc/1/ns/</span>
total <span class="token number">0</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Mar <span class="token number">15</span> 08:23 cgroup -<span class="token operator">&gt;</span> <span class="token string">'cgroup:[4026531835]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Mar <span class="token number">15</span> 08:23 ipc -<span class="token operator">&gt;</span> <span class="token string">'ipc:[4026532602]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Mar <span class="token number">15</span> 08:23 mnt -<span class="token operator">&gt;</span> <span class="token string">'mnt:[4026532600]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Mar <span class="token number">15</span> 08:23 net -<span class="token operator">&gt;</span> <span class="token string">'net:[4026532605]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Mar <span class="token number">15</span> 08:23 pid -<span class="token operator">&gt;</span> <span class="token string">'pid:[4026532603]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Mar <span class="token number">15</span> 08:23 pid_for_children -<span class="token operator">&gt;</span> <span class="token string">'pid:[4026532603]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Mar <span class="token number">15</span> 08:23 <span class="token function">time</span> -<span class="token operator">&gt;</span> <span class="token string">'time:[4026531834]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Mar <span class="token number">15</span> 08:23 time_for_children -<span class="token operator">&gt;</span> <span class="token string">'time:[4026531834]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Mar <span class="token number">15</span> 08:23 user -<span class="token operator">&gt;</span> <span class="token string">'user:[4026531837]'</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Mar <span class="token number">15</span> 08:23 uts -<span class="token operator">&gt;</span> <span class="token string">'uts:[4026532601]'</span>
<span class="token punctuation">[</span>root@c7ca03f322fa /<span class="token punctuation">]</span><span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># mount -t cgroup</span>
cgroup on /sys/fs/cgroup/systemd <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,xattr,name<span class="token operator">=</span>systemd<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/misc <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,misc<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/cpu,cpuacct <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,cpu,cpuacct<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/net_cls,net_prio <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,net_cls,net_prio<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/cpuset <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,cpuset<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/memory <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,memory<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/devices <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,devices<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/blkio <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,blkio<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/hugetlb <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,hugetlb<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/freezer <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,freezer<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/pids <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,pids<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/rdma <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,rdma<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/perf_event <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,perf_event<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="_5-2-容器资源限制"><a href="#_5-2-容器资源限制" class="header-anchor">#</a> 5.2 容器资源限制</h2> <h3 id="lab22-cpu和mem资源限制"><a href="#lab22-cpu和mem资源限制" class="header-anchor">#</a> Lab22. cpu和mem资源限制</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>这组实验需要开启3个终端

终端1，https://hub.docker.com/r/progrium/stress
<span class="token comment"># docker run  --name yl1 -it -c 1024 progrium/stress --cpu 1</span>
终端2,CPU <span class="token number">100</span>%
<span class="token comment"># top</span>
<span class="token operator">&lt;</span>q<span class="token operator">&gt;</span>退出

终端2，https://hub.docker.com/r/polinux/stress-ng
<span class="token comment"># docker run --name yl2 -it -c 1024 polinux/stress-ng --cpu 1</span>
终端3，两个容器各点一半CPU，因为权重值相同
<span class="token comment"># top</span>
<span class="token operator">&lt;</span>q<span class="token operator">&gt;</span>

-f, --filter<span class="token operator">=</span>
<span class="token comment"># docker ps -f name=&quot;yl*&quot;</span>
<span class="token comment"># cat /sys/fs/cgroup/cpu/docker/3a8dfa463c2fd19b4c293d2b71cb3f5601a0743e09902eed8f67161ccbd0d213/cpu.shares</span>
<span class="token comment"># cat /sys/fs/cgroup/cpu/docker/3a8dfa463c2fd19b4c293d2b71cb3f5601a0743e09902eed8f67161ccbd0d213/tasks</span>
<span class="token comment"># ps -aux | grep 3986</span>
<span class="token comment"># ps -aux | grep 4016</span>
<span class="token comment"># cat /proc/3986/cgroup</span>

实验看到现象后，终端1和2分别<span class="token operator">&lt;</span>Ctrl-C<span class="token operator">&gt;</span>中止
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># ls /sys/fs/cgroup/memory/</span>

<span class="token comment"># docker run -it -m 400M --memory-swap=500M progrium/stress --vm 1 --vm-bytes 450M</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h1 id="_6-paas概述"><a href="#_6-paas概述" class="header-anchor">#</a> 6. PaaS概述</h1> <h2 id="_6-1-什么是paas"><a href="#_6-1-什么是paas" class="header-anchor">#</a> 6.1 什么是PaaS</h2> <table><thead><tr><th style="text-align:center;">缩写</th> <th style="text-align:center;">IaaS/架构</th> <th style="text-align:center;">PaaS/平台</th> <th style="text-align:center;">SaaS/软件</th></tr></thead> <tbody><tr><td style="text-align:center;">全拼</td> <td style="text-align:center;"><strong>Infrastructure</strong>-as-a-Service</td> <td style="text-align:center;"><strong>Platform</strong>-as-a-Service</td> <td style="text-align:center;"><strong>Software</strong>-as-a-Service</td></tr> <tr><td style="text-align:center;">中文</td> <td style="text-align:center;">基础设施即服务</td> <td style="text-align:center;">平台即服务</td> <td style="text-align:center;">软件即服务</td></tr> <tr><td style="text-align:center;">示例</td> <td style="text-align:center;">亚马逊，阿里云、华为云、腾讯云等</td> <td style="text-align:center;">Google、Microsoft Azure 等</td> <td style="text-align:center;">阿里的钉钉、苹果的 iCloud 等</td></tr> <tr><td style="text-align:center;">软件</td> <td style="text-align:center;">OpenStack</td> <td style="text-align:center;">OpenShift、K8s</td> <td style="text-align:center;">Office 365</td></tr></tbody></table> <h2 id="_6-2-paas与编排工具概述"><a href="#_6-2-paas与编排工具概述" class="header-anchor">#</a> 6.2 PaaS与编排工具概述</h2> <h1 id="_7-kubernetes架构介绍"><a href="#_7-kubernetes架构介绍" class="header-anchor">#</a> 7. Kubernetes架构介绍</h1> <h2 id="_7-1-kubernetes架构"><a href="#_7-1-kubernetes架构" class="header-anchor">#</a> 7.1 Kubernetes架构</h2> <h3 id="lab23-集群安装"><a href="#lab23-集群安装" class="header-anchor">#</a> Lab23. 集群安装</h3> <div class="language- extra-class"><pre><code>https://vmcc.xyz:8443/?dir=k8s
</code></pre></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n kube-system get pod -owide

$ <span class="token function">ls</span> /etc/kubernetes/manifests/
etcd.yaml
<span class="token variable"><span class="token variable">`</span>kube-apiserver.yaml<span class="token variable">`</span></span>
kube-controller-manager.yaml
kube-scheduler.yaml

$ kubectl -n kube-system get pods --field-selector spec.nodeName<span class="token operator">=</span>k8s-master
NAME                                       READY   STATUS    RESTARTS      AGE
calico-kube-controllers-84c476996d-mg9hd   <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>43m ago<span class="token punctuation">)</span>   76m
calico-node-4js9b                          <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>43m ago<span class="token punctuation">)</span>   76m
coredns-74586cf9b6-2djpg                   <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>43m ago<span class="token punctuation">)</span>   90m
coredns-74586cf9b6-vxg4w                   <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>43m ago<span class="token punctuation">)</span>   90m
etcd-k8s-master                            <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>43m ago<span class="token punctuation">)</span>   90m
kube-apiserver-k8s-master                  <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>43m ago<span class="token punctuation">)</span>   90m
kube-controller-manager-k8s-master         <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>43m ago<span class="token punctuation">)</span>   90m
kube-proxy-bpdh4                           <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>43m ago<span class="token punctuation">)</span>   90m
kube-scheduler-k8s-master                  <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>43m ago<span class="token punctuation">)</span>   90m

$ kubectl -n kube-system get pods --field-selector spec.nodeName<span class="token operator">=</span>k8s-worker1
NAME                READY   STATUS    RESTARTS      AGE
calico-node-vpl5z   <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>44m ago<span class="token punctuation">)</span>   73m
kube-proxy-lhx5l    <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>44m ago<span class="token punctuation">)</span>   73m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><a href="https://kubernetes.io/zh/docs/" target="_blank" rel="noopener noreferrer">Kubernetes 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> / <a href="https://kubernetes.io/zh/docs/concepts/" target="_blank" rel="noopener noreferrer">概念<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> / <a href="https://kubernetes.io/zh/docs/concepts/overview/" target="_blank" rel="noopener noreferrer">概述<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> / <a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/" target="_blank" rel="noopener noreferrer">使用 Kubernetes 对象<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> / <a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/field-selectors/" target="_blank" rel="noopener noreferrer">字段选择器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">nc</span> <span class="token number">127.0</span>.0.1 <span class="token number">6443</span>
<span class="token operator">&lt;</span>Ctrl-C<span class="token operator">&gt;</span>
$ ss -antup <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">6443</span>

服务
<span class="token comment"># systemctl status kubelet</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_7-2-namespace"><a href="#_7-2-namespace" class="header-anchor">#</a> 7.2 namespace</h2> <h3 id="lab24-namespapce"><a href="#lab24-namespapce" class="header-anchor">#</a> Lab24. namespapce</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl api-resources --namespaced<span class="token operator">=</span>true

$ kubectl get namespace

$ kubectl get pod --namespace<span class="token operator">=</span>kube-system
$ kubectl get pod -n kube-system
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h1 id="_8-deployment管理与使用"><a href="#_8-deployment管理与使用" class="header-anchor">#</a> 8. Deployment管理与使用</h1> <h2 id="_8-2-创建-deployment"><a href="#_8-2-创建-deployment" class="header-anchor">#</a> 8.2 创建 Deployment</h2> <h3 id="lab25-deployment-cmd"><a href="#lab25-deployment-cmd" class="header-anchor">#</a> Lab25. Deployment-cmd</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create deployment mydep --image<span class="token operator">=</span>nginx

$ kubectl get deployment

$ kubectl describe deploy mydep

$ kubectl get deployment
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="lab26-deployment-yaml"><a href="#lab26-deployment-yaml" class="header-anchor">#</a> Lab26. Deployment-<a href="https://kubernetes.io/zh/docs/tasks/run-application/run-stateless-application-deployment/" target="_blank" rel="noopener noreferrer">yaml<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <blockquote><p>https://hub.docker.com/_/nginx</p></blockquote> <table><thead><tr><th style="text-align:center;">ID</th> <th style="text-align:center;">NAME</th> <th style="text-align:center;">IMAGE</th> <th style="text-align:center;">REPLICAS</th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td style="text-align:center;">deployment-v1.yaml</td> <td style="text-align:center;">nginx:<code>1.14.2</code></td> <td style="text-align:center;">2</td></tr> <tr><td style="text-align:center;">2</td> <td style="text-align:center;">deployment-v2.yaml</td> <td style="text-align:center;">nginx:<code>1.20.2</code></td> <td style="text-align:center;">3</td></tr> <tr><td style="text-align:center;">3</td> <td style="text-align:center;">deployment-v3.yaml</td> <td style="text-align:center;">nginx:<code>1.21.6</code></td> <td style="text-align:center;">3</td></tr></tbody></table> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">vim</span> deployment-v1.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># tells deployment to run 2 pods matching the template</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.14.2
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create -f deployment-v1.yaml

$ kubectl get deployment
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_8-3-升级和弹性收缩"><a href="#_8-3-升级和弹性收缩" class="header-anchor">#</a> 8.3 升级和弹性收缩</h2> <h3 id="lab27-deployment弹性伸缩"><a href="#lab27-deployment弹性伸缩" class="header-anchor">#</a> Lab27. Deployment弹性伸缩</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">vim</span> deployment-v2.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.20.2
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply -f deployment-v2.yaml

$ kubectl get deployment
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>kubectl <strong>scale</strong></p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl scale deployment nginx-deployment --replicas<span class="token operator">=</span><span class="token number">2</span>

$ kubectl get deployment
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>Kubectl <strong>edit</strong></p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl edit deployment nginx-deployment
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="lab28-deployment升级软件版本"><a href="#lab28-deployment升级软件版本" class="header-anchor">#</a> Lab28. Deployment升级软件版本</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get rs

$ kubectl get pods

$ <span class="token function">vim</span> deployment-v3.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.21.6
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply -f deployment-v3.yaml

$ kubectl get pods

$ kubectl describe deployments.apps nginx-deployment
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>rollout</p> <p>--record</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl rollout <span class="token function">history</span> deployment nginx-deployment

$ kubectl apply -f deployment-v1.yaml --record
$ kubectl apply -f deployment-v2.yaml --record
$ kubectl apply -f deployment-v3.yaml --record

$ kubectl rollout <span class="token function">history</span> deployment nginx-deployment

$ kubectl rollout <span class="token function">history</span> deployment nginx-deployment --revision<span class="token operator">=</span><span class="token number">5</span>

$ kubectl rollout undo deployment nginx-deployment --to-revision<span class="token operator">=</span><span class="token number">5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h1 id="_9-pod管理与使用"><a href="#_9-pod管理与使用" class="header-anchor">#</a> 9. Pod管理与使用</h1> <h2 id="_9-2-使用pod"><a href="#_9-2-使用pod" class="header-anchor">#</a> 9.2 使用pod</h2> <h3 id="lab29-创建一个pod"><a href="#lab29-创建一个pod" class="header-anchor">#</a> Lab29.  创建一个pod</h3> <blockquote><p>-f file</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">vim</span> mypod.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mypod
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
      <span class="token key atrule">args</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /bin/sh
      <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
      <span class="token punctuation">-</span> sleep 3h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create -f mypod.yaml

$ kubectl get pod mypod

$ kubectl get pod mypod -owide

$ <span class="token function">ssh</span> root@k8s-worker2 <span class="token function">docker</span> <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> mypod
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe pod mypod

$ kubectl <span class="token builtin class-name">exec</span> -it mypod -- /bin/sh
/ <span class="token comment"># exit</span>

$ kubectl <span class="token builtin class-name">exec</span> -it mypod --container mypod -- /bin/sh
/ <span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="lab30-创建第二个pod"><a href="#lab30-创建第二个pod" class="header-anchor">#</a> Lab30.  创建第二个pod</h3> <blockquote><p>-f==-== yaml文件的内容</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld
      <span class="token key atrule">image</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>world
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe pod helloworld

$ kubectl get pods
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete pod helloworld

$ kubectl delete pod mypod
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="lab-cmd"><a href="#lab-cmd" class="header-anchor">#</a> Lab. cmd</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ k run nginx2 --image nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ k run nginx3 --image nginx --dry-run<span class="token operator">=</span>client -o yaml <span class="token operator">&gt;</span> b.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ k get pod nginx1 -o yaml <span class="token operator">&gt;</span> nginx1.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h1 id="_10-label与label-selector"><a href="#_10-label与label-selector" class="header-anchor">#</a> 10. Label与Label Selector</h1> <blockquote><ul><li>创建标签
<ul><li>yaml</li> <li>cmd
<ul><li>run --labels ...</li> <li>label ...</li></ul></li></ul></li> <li>查看标签
<ul><li>--show-labels</li></ul></li> <li>使用标签
<ul><li>-l, --selector=''</li> <li>-L, --label-columns=[]</li></ul></li> <li>删除标签
<ul><li>KEY-</li></ul></li></ul></blockquote> <h2 id="_10-1-label"><a href="#_10-1-label" class="header-anchor">#</a> 10.1 Label</h2> <h3 id="lab31-设置标签"><a href="#lab31-设置标签" class="header-anchor">#</a> Lab31. 设置标签</h3> <ul><li>添加标签-创建时</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> labelpod
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">version</span><span class="token punctuation">:</span> new
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> labelpod
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
      <span class="token key atrule">args</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /bin/sh
      <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
      <span class="token punctuation">-</span> sleep 30000
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ k run labelpod1 --image busybox --labels<span class="token operator">=</span><span class="token string">&quot;app=busybox,version=new&quot;</span> -- <span class="token function">sleep</span> 8h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>查看标签（--show-labels）</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pods labelpod --show-labels
NAME       READY   STATUS    RESTARTS   AGE   LABELS
labelpod   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          20s   <span class="token variable"><span class="token variable">`</span><span class="token assign-left variable">app</span><span class="token operator">=</span>busybox<span class="token variable">`</span></span>,<span class="token variable"><span class="token variable">`</span><span class="token assign-left variable">version</span><span class="token operator">=</span>new<span class="token variable">`</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>添加标签-存在时</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl label pods labelpod <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">2022</span>

$ kubectl get pods labelpod --show-labels
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>删除标签</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl label pod labelpod time-
pod/labelpod unlabeled
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_10-2-label-selector"><a href="#_10-2-label-selector" class="header-anchor">#</a> 10.2 Label Selector</h2> <h3 id="lab32-标签选择器"><a href="#lab32-标签选择器" class="header-anchor">#</a> Lab32. 标签选择器</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pods -l <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">2022</span> --show-labels

$ kubectl get pods -l time<span class="token operator">!=</span><span class="token number">2022</span> --show-labels

$ kubectl get pod -L app

$ kubectl get pod -l <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl label nodes k8s-worker1 <span class="token assign-left variable">env</span><span class="token operator">=</span>test

$ kubectl get <span class="token function">node</span> -L <span class="token function">env</span>

$ kubectl get nodes --show-labels
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.7.9
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token comment"># 增加 2 行        </span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span> test
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pods -l <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx -owide
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.7.9
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token comment"># 增加 9 行</span>
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>
         <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
            <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> env
                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                <span class="token key atrule">values</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> test
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pods -l <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx -owide
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h1 id="_11-service服务发现"><a href="#_11-service服务发现" class="header-anchor">#</a> 11. Service服务发现</h1> <h2 id="_11-2-服务发现"><a href="#_11-2-服务发现" class="header-anchor">#</a> 11.2 服务发现</h2> <blockquote><ul><li>Type
<ul><li>ClusterIP（None == headless）</li> <li>NodePort</li></ul></li></ul></blockquote> <h3 id="lab33-创建service"><a href="#lab33-创建service" class="header-anchor">#</a> Lab33. 创建Service</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> httpd
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> httpd
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd
        <span class="token key atrule">image</span><span class="token punctuation">:</span> httpd
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> httpd
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get svc
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
httpd-svc    ClusterIP  <span class="token variable"><span class="token variable">`</span><span class="token number">10.100</span>.247.72<span class="token variable">`</span></span>  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>       <span class="token variable"><span class="token variable">`</span><span class="token number">8080</span><span class="token variable">`</span></span>/TCP   10s
kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP    23d

$ <span class="token function">curl</span> <span class="token number">10.100</span>.247.72:8080
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get endpoints httpd-svc
NAME        ENDPOINTS                                            AGE
httpd-svc   <span class="token number">172.16</span>.126.13:80,172.16.126.14:80,172.16.194.82:80   30m

$ <span class="token function">curl</span> <span class="token number">172.16</span>.126.13
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe svc httpd-svc
Name:              httpd-svc
Namespace:         default
Labels:            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Selector:          <span class="token assign-left variable">app</span><span class="token operator">=</span>httpd
Type:             <span class="token variable"><span class="token variable">`</span>ClusterIP<span class="token variable">`</span></span>
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                <span class="token number">10.100</span>.247.72
IPs:               <span class="token number">10.100</span>.247.72
Port:              <span class="token operator">&lt;</span>unset<span class="token operator">&gt;</span>  <span class="token number">8080</span>/TCP
TargetPort:        <span class="token number">80</span>/TCP
Endpoints:         <span class="token number">172.16</span>.126.13:80,172.16.126.14:80,172.16.194.82:80
Session Affinity:  None
Events:            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="lab34-创建可供外部访问的service"><a href="#lab34-创建可供外部访问的service" class="header-anchor">#</a> Lab34. 创建可供外部访问的Service</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 添加 1 行</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> httpd
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token comment"># 添加 1 行，不指明随机（默认：30000-32767）</span>
    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30144</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get svc httpd-svc
NAME        TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
httpd-svc  <span class="token variable"><span class="token variable">`</span>NodePort<span class="token variable">`</span></span>  <span class="token number">10.100</span>.247.72   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>:<span class="token variable"><span class="token variable">`</span><span class="token number">30144</span><span class="token variable">`</span></span>/TCP 29m

使用物理机测试
$ <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-master k8s-worker1 k8s-worker2<span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token function">curl</span> <span class="token variable">$i</span>:30144
  <span class="token keyword">done</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_11-3-集群中的dns"><a href="#_11-3-集群中的dns" class="header-anchor">#</a> 11.3 集群中的DNS</h2> <h3 id="lab35-集群中的dns"><a href="#lab35-集群中的dns" class="header-anchor">#</a> Lab35. 集群中的DNS</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n kube-system get pods <span class="token operator">|</span> <span class="token function">grep</span> dns
<span class="token variable"><span class="token variable">`</span>coredns<span class="token variable">`</span></span>-6d8c4cb4d-28tj5    <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>23d ago<span class="token punctuation">)</span>   23d
<span class="token variable"><span class="token variable">`</span>coredns<span class="token variable">`</span></span>-6d8c4cb4d-jxxtc    <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>23d ago<span class="token punctuation">)</span>   23d
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get svc httpd-svc
NAME        TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
httpd-svc   NodePort  <span class="token variable"><span class="token variable">`</span><span class="token number">10.100</span>.247.72<span class="token variable">`</span></span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>:30144/TCP   50m

$ kubectl run clientpod --image busybox -- <span class="token function">sleep</span> 3h
$ kubectl <span class="token builtin class-name">exec</span> -it clientpod -- /bin/sh
/ <span class="token comment"># nslookup 10.100.247.72</span>
Server:    <span class="token number">10.96</span>.0.10
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 kube-dns.kube-system.svc.cluster.local

Name:      <span class="token number">10.100</span>.247.72
Address <span class="token number">1</span>: <span class="token number">10.100</span>.247.72 <span class="token variable"><span class="token variable">`</span>httpd-svc.default.svc.cluster.local<span class="token variable">`</span></span>
/ <span class="token comment"># wget httpd-svc:8080</span>
Connecting to httpd-svc:8080 <span class="token punctuation">(</span><span class="token number">10.108</span>.227.185:8080<span class="token punctuation">)</span>
saving to <span class="token string">'index.html'</span>
index.html           <span class="token number">100</span>%    <span class="token number">45</span>  <span class="token number">0</span>:00:00 ETA
<span class="token string">'index.html'</span> saved

/ <span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="_11-4-headless-service"><a href="#_11-4-headless-service" class="header-anchor">#</a> 11.4 Headless service</h2> <h3 id="lab36-headless-service"><a href="#lab36-headless-service" class="header-anchor">#</a> Lab36. Headless Service</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> headless
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> headless
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> headless
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd
        <span class="token key atrule">image</span><span class="token punctuation">:</span> httpd
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> headless<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> headless
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get svc
NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
headless-svc   ClusterIP  <span class="token variable"><span class="token variable">`</span>None<span class="token variable">`</span></span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP           23s
httpd-svc      NodePort    <span class="token number">10.100</span>.247.72   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>:30144/TCP   58m
kubernetes     ClusterIP   <span class="token number">10.96</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP          23d

$ kubectl <span class="token builtin class-name">exec</span> -it clientpod -- /bin/sh
/ <span class="token comment"># nslookup headless-svc</span>
Server:    <span class="token number">10.96</span>.0.10
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 kube-dns.kube-system.svc.cluster.local

Name:      headless-svc
Address <span class="token number">1</span>: <span class="token number">172.16</span>.126.13 <span class="token number">172</span>-16-126-13.httpd-svc.default.svc.cluster.local
Address <span class="token number">2</span>: <span class="token number">172.16</span>.126.14 <span class="token number">172</span>-16-126-14.httpd-svc.default.svc.cluster.local
Address <span class="token number">3</span>: <span class="token number">172.16</span>.194.82 <span class="token number">172</span>-16-194-82.httpd-svc.default.svc.cluster.local

/ <span class="token comment"># wget headless-svc</span>
Connecting to headless-svc <span class="token punctuation">(</span><span class="token number">172.16</span>.126.14:80<span class="token punctuation">)</span>
index.html           <span class="token number">100</span>%    <span class="token number">45</span>   <span class="token number">0</span>:00:00 ETA
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h1 id="_12-daemonset与job"><a href="#_12-daemonset与job" class="header-anchor">#</a> 12. DaemonSet与Job</h1> <h2 id="_12-1-daemonset"><a href="#_12-1-daemonset" class="header-anchor">#</a> 12.1 DaemonSet</h2> <blockquote><p>每个节点，都安装一个服务</p> <ul><li>日志</li> <li>存储</li></ul></blockquote> <blockquote><p>当前环境中 calio, kube-proxy 都是</p></blockquote> <blockquote><p>现象：</p> <ul><li>只在master上布署 calico</li> <li>每个节点上只运行一个pod</li></ul></blockquote> <h3 id="lab37-daemonset-1"><a href="#lab37-daemonset-1" class="header-anchor">#</a> Lab37. DaemonSet-1</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n kube-system get daemonsets
NAME          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
<span class="token variable"><span class="token variable">`</span>calico-node<span class="token variable">`</span></span> <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       <span class="token number">3</span>            <span class="token number">3</span>           kubernetes.io/os<span class="token operator">=</span>linux   29d
<span class="token variable"><span class="token variable">`</span>kube-proxy<span class="token variable">`</span></span>  <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       <span class="token number">3</span>            <span class="token number">3</span>           kubernetes.io/os<span class="token operator">=</span>linux   29d
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n kube-system describe daemonsets kube-proxy <span class="token operator">|</span> <span class="token function">grep</span> -i label
Labels:        <span class="token variable"><span class="token variable">`</span>k8s-app<span class="token operator">=</span>kube-proxy<span class="token variable">`</span></span>
  Labels:          <span class="token variable"><span class="token variable">`</span>k8s-app<span class="token operator">=</span>kube-proxy<span class="token variable">`</span></span>

$ kubectl -n kube-system get pod -l k8s-app<span class="token operator">=</span>kube-proxy -o wide
NAME               READY   STATUS    RESTARTS      AGE   IP                NODE          NOMINATED NODE   READINESS GATES
kube-proxy-8pv56   <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>29d ago<span class="token punctuation">)</span>   29d   <span class="token number">192.168</span>.147.129   <span class="token variable"><span class="token variable">`</span>k8s-worker1<span class="token variable">`</span></span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-proxy-9q8bq   <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>29d ago<span class="token punctuation">)</span>   29d   <span class="token number">192.168</span>.147.128   <span class="token variable"><span class="token variable">`</span>k8s-master<span class="token variable">`</span></span>    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-proxy-tqvrs   <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>29d ago<span class="token punctuation">)</span>   29d   <span class="token number">192.168</span>.147.130   <span class="token variable"><span class="token variable">`</span>k8s-worker2<span class="token variable">`</span></span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n kube-system describe daemonsets calico-node <span class="token operator">|</span> <span class="token function">grep</span> -i label
Labels:        <span class="token variable"><span class="token variable">`</span>k8s-app<span class="token operator">=</span>calico-node<span class="token variable">`</span></span>
  Labels:           <span class="token variable"><span class="token variable">`</span>k8s-app<span class="token operator">=</span>calico-node<span class="token variable">`</span></span>

$ kubectl -n kube-system get pod -l k8s-app<span class="token operator">=</span>calico-node -o wide
NAME                READY   STATUS    RESTARTS      AGE   IP                NODE          NOMINATED NODE   READINESS GATES
calico-node-75k64   <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>29d ago<span class="token punctuation">)</span>   29d   <span class="token number">192.168</span>.147.130   <span class="token variable"><span class="token variable">`</span>k8s-worker2<span class="token variable">`</span></span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-cxqxc   <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>29d ago<span class="token punctuation">)</span>   29d   <span class="token number">192.168</span>.147.128   <span class="token variable"><span class="token variable">`</span>k8s-master<span class="token variable">`</span></span>    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-g5wj7   <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>29d ago<span class="token punctuation">)</span>   29d   <span class="token number">192.168</span>.147.129   <span class="token variable"><span class="token variable">`</span>k8s-worker1<span class="token variable">`</span></span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="lab38-daemonset-2"><a href="#lab38-daemonset-2" class="header-anchor">#</a> Lab38. DaemonSet-2</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>daemonset
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
       <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.7.9
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod -o wide
NAME                    READY   STATUS    RESTARTS   AGE   IP              NODE          NOMINATED NODE   READINESS GATES
nginx-daemonset-vqfpw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          63s   <span class="token number">172.16</span>.126.1    <span class="token variable"><span class="token variable">`</span>k8s-worker2<span class="token variable">`</span></span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-daemonset-z87sj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          63s   <span class="token number">172.16</span>.194.65   <span class="token variable"><span class="token variable">`</span>k8s-worker1<span class="token variable">`</span></span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

$ kubectl delete pod nginx-daemonset-vqfpw
pod <span class="token string">&quot;nginx-daemonset-vqfpw&quot;</span> deleted

$ kubectl get pod -o wide
NAME                    READY   STATUS    RESTARTS   AGE     IP              NODE          NOMINATED NODE   READINESS GATES
<span class="token variable"><span class="token variable">`</span>nginx-daemonset-4r8mj<span class="token variable">`</span></span> <span class="token number">1</span>/1     Running   <span class="token number">0</span>         <span class="token variable"><span class="token variable">`</span>2s<span class="token variable">`</span></span>     <span class="token number">172.16</span>.126.2    k8s-worker2   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-daemonset-z87sj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m15s   <span class="token number">172.16</span>.194.65   k8s-worker1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">ssh</span> root@k8s-worker1 <span class="token function">halt</span> -p

$ kubectl get daemonset
NAME              DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
nginx-daemonset  <span class="token variable"><span class="token variable">`</span><span class="token number">1</span><span class="token variable">`</span></span>        <span class="token number">1</span>         <span class="token number">1</span>       <span class="token number">1</span>            <span class="token number">1</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          7m37s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_12-2-job"><a href="#_12-2-job" class="header-anchor">#</a> 12.2 Job</h2> <h3 id="lab39-job"><a href="#lab39-job" class="header-anchor">#</a> Lab39. job</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pi
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> pi
        <span class="token key atrule">image</span><span class="token punctuation">:</span> perl<span class="token punctuation">:</span>5.34.0
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;perl&quot;</span><span class="token punctuation">,</span>  <span class="token string">&quot;-Mbignum=bpi&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-wle&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print bpi(2000)&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">backoffLimit</span><span class="token punctuation">:</span> <span class="token number">4</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get job
NAME   COMPLETIONS   DURATION   AGE
pi     <span class="token number">1</span>/1           33s        68s

$ kubectl get pods
NAME                    READY   STATUS      RESTARTS   AGE
<span class="token variable"><span class="token variable">`</span>pi-ht7xr<span class="token variable">`</span></span>              <span class="token number">0</span>/1    <span class="token variable"><span class="token variable">`</span>Completed<span class="token variable">`</span></span>  <span class="token number">0</span>          2m13s

$ kubectl logs pi-ht7xr
<span class="token number">3.1415926</span><span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="_12-3-cronjob"><a href="#_12-3-cronjob" class="header-anchor">#</a> 12.3 CronJob</h2> <h3 id="lab40-cronjob"><a href="#lab40-cronjob" class="header-anchor">#</a> Lab40. CronJob</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">&quot;*/1 * * * *&quot;</span>
  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">containers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hello
            <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
            <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> /bin/sh
            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
            <span class="token punctuation">-</span> date; echo Hello from the Kubernetes cluster
          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe cronjobs.batch hello
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
Events:
  Type    Reason            Age   From                Message
  ----    ------            ----  ----
  Normal  SuccessfulCreate  79m   cronjob-controller  Created job hello-27547692
  Normal  SawCompletedJob   79m   cronjob-controller  Saw completed job: hello-27547692, status: Complete
  Normal  SuccessfulCreate  78m   cronjob-controller  Created job hello-27547693
  Normal  SawCompletedJob   78m   cronjob-controller  Saw completed job: hello-27547693, status: Complete
  Normal  SuccessfulCreate  77m   cronjob-controller  Created job hello-27547694
  Normal  SawCompletedJob   77m   cronjob-controller  Saw completed job: hello-27547694, status: Complete
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h1 id="_13-pod健康检查"><a href="#_13-pod健康检查" class="header-anchor">#</a> 13. Pod健康检查</h1> <h2 id="_13-2-使用探针"><a href="#_13-2-使用探针" class="header-anchor">#</a> 13.2 使用探针</h2> <h3 id="lab41-livenessprobe-exec"><a href="#lab41-livenessprobe-exec" class="header-anchor">#</a> Lab41. livenessProbe-exec</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">test</span><span class="token punctuation">:</span> liveness
  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness
    <span class="token key atrule">args</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /bin/sh
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
    <span class="token punctuation">-</span> touch /tmp/healthy; sleep 30; rm <span class="token punctuation">-</span>rf /tmp/healthy; sleep 600
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">exec</span><span class="token punctuation">:</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cat
        <span class="token punctuation">-</span> /tmp/healthy
      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod liveness-exec -w
NAME            READY   STATUS    RESTARTS     AGE
liveness-exec   <span class="token number">1</span>/1     Running  <span class="token variable"><span class="token variable">`</span><span class="token number">1</span><span class="token variable">`</span></span><span class="token punctuation">(</span>5s ago<span class="token punctuation">)</span>   80s

$ kubectl describe pod liveness-exec

$ kubectl describe pod liveness-exec <span class="token operator">|</span> <span class="token function">grep</span> -i liveness:.*exec
    Liveness:       <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>cat /tmp/healthy<span class="token punctuation">]</span> <span class="token assign-left variable">delay</span><span class="token operator">=</span>5s <span class="token assign-left variable">timeout</span><span class="token operator">=</span>1s <span class="token assign-left variable">period</span><span class="token operator">=</span>5s <span class="token comment">#success=1 #failure=3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">test</span><span class="token punctuation">:</span> liveness
<span class="token comment"># name: liveness-exec</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec3
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness
    <span class="token key atrule">args</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /bin/sh
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
    <span class="token punctuation">-</span> touch /tmp/healthy; sleep 30; rm <span class="token punctuation">-</span>rf /tmp/healthy; sleep 600
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">exec</span><span class="token punctuation">:</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cat
        <span class="token punctuation">-</span> /tmp/healthy
      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
      <span class="token comment"># 增加 1 行</span>
      <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe pod liveness-exec3 <span class="token operator">|</span> <span class="token function">grep</span> -i liveness:.*exec
    Liveness:       <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>cat /tmp/healthy<span class="token punctuation">]</span> <span class="token assign-left variable">delay</span><span class="token operator">=</span>5s <span class="token assign-left variable">timeout</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>3s<span class="token variable">`</span></span> <span class="token assign-left variable">period</span><span class="token operator">=</span>5s <span class="token comment">#success=1 #failure=3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="lab42-livenessprobe-http"><a href="#lab42-livenessprobe-http" class="header-anchor">#</a> Lab42. livenessProbe-http</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">test</span><span class="token punctuation">:</span> liveness
  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>http
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mirrorgooglecontainers/liveness
    <span class="token key atrule">args</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /server
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
        <span class="token key atrule">httpHeaders</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> X<span class="token punctuation">-</span>Custom<span class="token punctuation">-</span>Header
          <span class="token key atrule">value</span><span class="token punctuation">:</span> Awesome
      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">3</span>
      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod liveness-http
NAME            READY   STATUS    RESTARTS   AGE
liveness-http   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          41s

$ kubectl describe pod liveness-http <span class="token operator">|</span> <span class="token function">grep</span> -i liveness:.*http
    Liveness:      <span class="token variable"><span class="token variable">`</span>http-get<span class="token variable">`</span></span> http://:8080/healthz <span class="token assign-left variable">delay</span><span class="token operator">=</span>3s <span class="token assign-left variable">timeout</span><span class="token operator">=</span>1s <span class="token assign-left variable">period</span><span class="token operator">=</span>3s <span class="token comment">#success=1 #failure=3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="lab43-livenessprobe-tcp"><a href="#lab43-livenessprobe-tcp" class="header-anchor">#</a> Lab43. livenessProbe-tcp</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ubuntu
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> ubuntu
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ubuntu
    <span class="token key atrule">image</span><span class="token punctuation">:</span> ubuntu
    <span class="token key atrule">args</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /bin/sh
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
    <span class="token punctuation">-</span> apt<span class="token punctuation">-</span>get update <span class="token important">&amp;&amp;</span> apt<span class="token punctuation">-</span>get <span class="token punctuation">-</span>y install openbsd<span class="token punctuation">-</span>inetd telnetd <span class="token important">&amp;&amp;</span> /etc/init.d/openbsd<span class="token punctuation">-</span>inetd start; sleep 30000
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">23</span>
      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">60</span>
      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">20</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod ubuntu
NAME     READY   STATUS    RESTARTS   AGE
ubuntu   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m32s

$ kubectl describe pod ubuntu <span class="token operator">|</span> <span class="token function">grep</span> -i live
    Liveness:      <span class="token variable"><span class="token variable">`</span>tcp-socket<span class="token variable">`</span></span> :23 <span class="token assign-left variable">delay</span><span class="token operator">=</span>60s <span class="token assign-left variable">timeout</span><span class="token operator">=</span>1s <span class="token assign-left variable">period</span><span class="token operator">=</span>20s <span class="token comment">#success=1 #failure=3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_13-3-使用就绪探针"><a href="#_13-3-使用就绪探针" class="header-anchor">#</a> 13.3 使用就绪探针</h2> <h3 id="lab44-readinessprobe-exec"><a href="#lab44-readinessprobe-exec" class="header-anchor">#</a> Lab44. readinessProbe-exec</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> httpd
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> httpd
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd
        <span class="token key atrule">image</span><span class="token punctuation">:</span> httpd
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">exec</span><span class="token punctuation">:</span>
            <span class="token key atrule">command</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> cat
            <span class="token punctuation">-</span> /usr/local/apache2/htdocs/index.html
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> httpd
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get endpoints httpd-svc
NAME        ENDPOINTS                                            AGE
httpd-svc   <span class="token number">172.16</span>.126.57:80,172.16.126.58:80,172.16.126.59:80   97s

$ kubectl get pod -l <span class="token assign-left variable">app</span><span class="token operator">=</span>httpd
NAME                              READY   STATUS    RESTARTS   AGE
httpd-deployment-c459d5dd-6pxl5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          84s
httpd-deployment-c459d5dd-79nvd   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          84s
httpd-deployment-c459d5dd-vmlh2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          84s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> -it httpd-deployment-c459d5dd-6pxl5 -- /bin/sh
<span class="token comment"># rm /usr/local/apache2/htdocs/index.html</span>
<span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get endpoints httpd-svc
NAME        ENDPOINTS                           AGE
httpd-svc   <span class="token number">172.16</span>.126.57:80,172.16.126.58:80   5m12s

$ kubectl get pods -l <span class="token assign-left variable">app</span><span class="token operator">=</span>httpd
NAME                              READY   STATUS    RESTARTS   AGE
httpd-deployment-c459d5dd-6pxl5   <span class="token number">0</span>/1     Running   <span class="token number">0</span>          5m42s
httpd-deployment-c459d5dd-79nvd   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m42s
httpd-deployment-c459d5dd-vmlh2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m42s

$ kubectl describe pod httpd-deployment-c459d5dd-6pxl5
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
  Warning  Unhealthy  58s <span class="token punctuation">(</span>x22 over 2m33s<span class="token punctuation">)</span>  kubelet            Readiness probe failed: cat: /usr/local/apache2/htdocs/index.html: No such <span class="token function">file</span> or directory
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h1 id="_14-kubernetes网络"><a href="#_14-kubernetes网络" class="header-anchor">#</a> 14. Kubernetes网络</h1> <blockquote><ul><li>CNI</li> <li>网络安全
<ul><li>网络策略 networkpolicy - K8s</li> <li>防火墙 firewall - 主机</li> <li>安全组 security group - 云主机</li></ul></li></ul></blockquote> <h2 id="_14-1-kubernetes-网络模型"><a href="#_14-1-kubernetes-网络模型" class="header-anchor">#</a> 14.1 Kubernetes 网络模型</h2> <h3 id="lab45-node与pod之间通信实验"><a href="#lab45-node与pod之间通信实验" class="header-anchor">#</a> Lab45. Node与Pod之间通信实验</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl run nginx --image<span class="token operator">=</span>nginx --port <span class="token number">80</span>

$ kubectl get pod -owide
NAME   READY   STATUS   RESTARTS   AGE     IP             NODE          NOMINATED NODE   READINESS GATES
nginx  <span class="token number">1</span>/1     Running  <span class="token number">0</span>          27s     <span class="token number">172.16</span>.126.3  <span class="token variable"><span class="token variable">`</span>k8s-worker2<span class="token variable">`</span></span>  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

$ <span class="token function">curl</span> <span class="token number">172.16</span>.126.3
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.

$ <span class="token function">ip</span> route
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
<span class="token number">172.16</span>.235.196 dev cali46502c0485c scope <span class="token function">link</span>
<span class="token number">172.16</span>.235.197 dev cali29fae187fa2 scope <span class="token function">link</span>
<span class="token number">172.16</span>.235.198 dev cali2bab3c78e13 scope <span class="token function">link</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="lab46-pod与pod之间通信实验"><a href="#lab46-pod与pod之间通信实验" class="header-anchor">#</a> Lab46. Pod与Pod之间通信实验</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl run busybox --image<span class="token operator">=</span>busybox -- <span class="token function">sleep</span> 3h

$ kubectl get pod -o wide
NAME       READY   STATUS     RESTARTS     AGE    IP                     NODE
busybox    <span class="token number">1</span>/1         Running    <span class="token number">0</span>                 27s       <span class="token number">172.16</span>.194.71   k8s-worker1
<span class="token punctuation">..</span>.输出省略
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> -it busybox -- /bin/sh
/ <span class="token comment"># ping 172.16.126.3</span>
PING <span class="token number">172.16</span>.126.3 <span class="token punctuation">(</span><span class="token number">172.16</span>.126.3<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">64</span> bytes from <span class="token number">172.16</span>.126.3: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">62</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.611</span> ms
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
/ <span class="token comment"># telnet 172.16.126.3 80</span>
Connected to <span class="token number">172.16</span>.126.3
get
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
<span class="token operator">&lt;</span>hr<span class="token operator">&gt;</span><span class="token operator">&lt;</span>center<span class="token operator">&gt;</span>nginx/1.21.<span class="token operator"><span class="token file-descriptor important">5</span>&lt;</span>/center<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
Connection closed by foreign <span class="token function">host</span>
/ <span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="lab46-集群外访问-nodeport"><a href="#lab46-集群外访问-nodeport" class="header-anchor">#</a> Lab46. 集群外访问-NodePort</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod --show-labels
NAME     READY   STATUS  RESTARTS   AGE. LABELS
busybox  <span class="token number">1</span>/1        Running  <span class="token number">0</span>                17m  <span class="token assign-left variable">run</span><span class="token operator">=</span>busybox
nginx    <span class="token number">1</span>/1        Running  <span class="token number">0</span>                42m  <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>access
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30080</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get svc -o wide
NAME          TYPE       CLUSTER-IP     EXTERNAL-IP  PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>           AGE  SELECTOR
kubernetes    ClusterIP  <span class="token number">10.96</span>.0.1      <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>       <span class="token number">443</span>/TCP           30d   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-access  NodePort   <span class="token number">10.110</span>.109.55  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>       <span class="token number">80</span>:<span class="token variable"><span class="token variable">`</span><span class="token number">30080</span><span class="token variable">`</span></span>/TCP    68s   <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx

$ <span class="token function">curl</span> http://k8s-master:30080
<span class="token punctuation">..</span>.
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>
<span class="token punctuation">..</span>.

$ ss -ntlp <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">30080</span>
LISTEN  <span class="token number">0</span>       <span class="token number">4096</span>              <span class="token number">0.0</span>.0.0:30080          <span class="token number">0.0</span>.0.0:*
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h1 id="_15-kubernetes存储"><a href="#_15-kubernetes存储" class="header-anchor">#</a> 15. Kubernetes存储</h1> <h2 id="_15-1-emptydir"><a href="#_15-1-emptydir" class="header-anchor">#</a> 15.1 EmptyDir</h2> <h3 id="lab47-创建一个使用emptydir的pod"><a href="#lab47-创建一个使用emptydir的pod" class="header-anchor">#</a> Lab47. 创建一个使用EmptyDir的Pod</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> em
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> ubuntu
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>container
    <span class="token comment"># 下 3 行</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /cache
      <span class="token key atrule">name</span><span class="token punctuation">:</span> cache<span class="token punctuation">-</span>volume
    <span class="token key atrule">args</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /bin/sh
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
    <span class="token punctuation">-</span> sleep 30000
<span class="token comment"># 下 3 行</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cache<span class="token punctuation">-</span>volume
    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe pod em <span class="token operator">|</span> <span class="token function">grep</span> -A <span class="token number">1</span> Mount
    Mounts:
     <span class="token variable"><span class="token variable">`</span>/cache<span class="token variable">`</span></span>from <span class="token variable"><span class="token variable">`</span>cache-volume<span class="token variable">`</span></span> <span class="token punctuation">(</span>rw<span class="token punctuation">)</span>

$ kubectl describe pod em <span class="token operator">|</span> <span class="token function">grep</span> -A <span class="token number">4</span> ^Volume
Volumes:
  <span class="token variable"><span class="token variable">`</span>cache-volume<span class="token variable">`</span></span><span class="token builtin class-name">:</span>
    Type:       <span class="token variable"><span class="token variable">`</span>EmptyDir<span class="token variable">`</span></span> <span class="token punctuation">(</span>a temporary directory that shares a pod's lifetime<span class="token punctuation">)</span>
    Medium:
    SizeLimit:  <span class="token variable"><span class="token variable">`</span><span class="token operator">&lt;</span>unset<span class="token operator">&gt;</span><span class="token variable">`</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> -it em -- /bin/sh
<span class="token comment"># ls /cache</span>
<span class="token comment"># touch /cache/my.txt</span>
<span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="lab48-emptydir容量限制"><a href="#lab48-emptydir容量限制" class="header-anchor">#</a> Lab48. EmptyDir容量限制</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> em1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> ubuntu
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>container
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /cache
      <span class="token key atrule">name</span><span class="token punctuation">:</span> cache<span class="token punctuation">-</span>volume
    <span class="token key atrule">args</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /bin/sh
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
    <span class="token punctuation">-</span> sleep 30000
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cache<span class="token punctuation">-</span>volume
  <span class="token comment"># 下 2 行区别</span>
    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span>
      <span class="token key atrule">sizeLimit</span><span class="token punctuation">:</span> 1Gi
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe pod em1 <span class="token operator">|</span> <span class="token function">grep</span> -A <span class="token number">4</span> ^Volume
Volumes:
  cache-volume:
    Type:       EmptyDir <span class="token punctuation">(</span>a temporary directory that shares a pod's lifetime<span class="token punctuation">)</span>
    Medium:
    SizeLimit: <span class="token variable"><span class="token variable">`</span>1Gi<span class="token variable">`</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> -it em1 -- /bin/sh
<span class="token comment"># df -h</span>
Filesystem                         Size  Used Avail Use% Mounted on
overlay                             38G  <span class="token number">4</span>.5G   32G  <span class="token number">13</span>% /
/dev/mapper/ubuntu--vg-ubuntu--lv  <span class="token variable"><span class="token variable">`</span>38G<span class="token variable">`</span></span> <span class="token number">4</span>.5G   32G  <span class="token number">13</span>% /cache
shm                                 64M     <span class="token punctuation">..</span>.
<span class="token comment"># dd if=/dev/zero of=/cache/test2g bs=1M count=2048</span>
<span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod em1
NAME   READY   STATUS    RESTARTS   AGE
em1    <span class="token number">0</span>/1    <span class="token variable"><span class="token variable">`</span>Evicted<span class="token variable">`</span></span>  <span class="token number">1</span>          53m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_15-2-hostpath"><a href="#_15-2-hostpath" class="header-anchor">#</a> 15.2 hostPath</h2> <h3 id="lab49-hostpath"><a href="#lab49-hostpath" class="header-anchor">#</a> Lab49. hostPath</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n kube-system get pod kube-proxy-8pv56 -o yaml <span class="token operator">|</span> <span class="token function">grep</span> -A <span class="token number">12</span> volumes:
  volumes:
  <span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
  - hostPath:
      path: /run/xtables.lock
      type: FileOrCreate
    name: xtables-lock
  - hostPath:
      path: /lib/modules
      type: <span class="token string">&quot;&quot;</span>
    name: lib-modules
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hppod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> ubuntu
    <span class="token key atrule">name</span><span class="token punctuation">:</span> hp<span class="token punctuation">-</span>container
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /hp<span class="token punctuation">-</span>dir
      <span class="token key atrule">name</span><span class="token punctuation">:</span> hp<span class="token punctuation">-</span>volume
    <span class="token key atrule">args</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /bin/sh
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
    <span class="token punctuation">-</span> sleep 30000
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hp<span class="token punctuation">-</span>volume
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /mnt/hostpathdir
      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod hppod -o wide
NAME    READY   STATUS    RESTARTS   AGE   IP             NODE          NOMINATED NODE   READINESS GATES
hppod   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          29s   <span class="token number">172.16</span>.126.9  <span class="token variable"><span class="token variable">`</span>k8s-worker2<span class="token variable">`</span></span>  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

$ <span class="token function">ssh</span> root@k8s-worker2 <span class="token function">ls</span> /mnt
hostpathdir
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_15-3-pv和pvc"><a href="#_15-3-pv和pvc" class="header-anchor">#</a> 15.3 PV和PVC</h2> <h3 id="lab50-pv和pvc"><a href="#lab50-pv和pvc" class="header-anchor">#</a> Lab50. PV和PVC</h3> <p><strong>[kiosk@192.168.147.128]$</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">apt</span> -y <span class="token function">install</span> nfs-kernel-server <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">sudo</span> <span class="token function">mkdir</span> /nfs
<span class="token builtin class-name">echo</span> <span class="token string">'/nfs *(rw,no_root_squash)'</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/exports
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> nfs-server
<span class="token function">sudo</span> systemctl restart nfs-server
showmount -e

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypv
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Recycle
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /nfs
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.147.128
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get <span class="token function">pv</span>
NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
mypv   1Gi        RWO            Recycle          Available                                   9s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypvc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">volumeName</span><span class="token punctuation">:</span> mypv
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pvc
NAME    STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
mypvc   Bound    mypv     1Gi        RWO                           7s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete pvc mypvc <span class="token operator">&amp;&amp;</span> kubectl get pod
persistentvolumeclaim <span class="token string">&quot;mypvc&quot;</span> deleted
NAME                               READY   STATUS                   RESTARTS       AGE
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
<span class="token variable"><span class="token variable">`</span>recycler-for-mypv<span class="token variable">`</span></span>                <span class="token number">0</span>/1     ContainerCreating        <span class="token number">0</span>              0s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypv
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
<span class="token comment"># 只修改 1 行</span>
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /nfs
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.147.128
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get <span class="token function">pv</span>
NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
mypv   1Gi        RWO           <span class="token variable"><span class="token variable">`</span>Retain<span class="token variable">`</span></span>          Available
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypvc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">volumeName</span><span class="token punctuation">:</span> mypv
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete pvc mypvc
persistentvolumeclaim <span class="token string">&quot;mypvc&quot;</span> deleted

$ kubectl get <span class="token function">pv</span>
NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM           STORAGECLASS   REASON   AGE
mypv   1Gi        RWO            Retain          <span class="token variable"><span class="token variable">`</span>Released<span class="token variable">`</span></span>  default/mypvc                           5m46s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h1 id="_16-configmap与secret"><a href="#_16-configmap与secret" class="header-anchor">#</a> 16. ConfigMap与Secret</h1> <h2 id="_16-1-configmap介绍"><a href="#_16-1-configmap介绍" class="header-anchor">#</a> 16.1 ConfigMap介绍</h2> <h3 id="lab51-创建configmap"><a href="#lab51-创建configmap" class="header-anchor">#</a> Lab51. 创建ConfigMap</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">mkdir</span> -p /runfile/configmap

<span class="token function">sudo</span> <span class="token function">tee</span> /runfile/configmap/game.properties <span class="token operator">&lt;&lt;</span><span class="token string">EOF
lives=3
enemies.cheat=true
enemies.cheat.level=noGoodRotten
EOF</span>

<span class="token function">sudo</span> <span class="token function">tee</span> /runfile/configmap/ui.properties <span class="token operator">&lt;&lt;</span><span class="token string">EOF
color.good=purple
how.nice.to.look=fairlyNice
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><ul><li>Folder
--from-file</li></ul></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create configmap game-config --from-file<span class="token operator">=</span>/runfile/configmap

$ kubectl get configmap
NAME               DATA   AGE
<span class="token variable"><span class="token variable">`</span>game-config<span class="token variable">`</span></span>      <span class="token number">2</span>      5s
kube-root-ca.crt   <span class="token number">1</span>      31d

$ kubectl describe configmaps game-config 
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
Data
<span class="token operator">==</span><span class="token operator">==</span>
game.properties:
----
<span class="token assign-left variable">lives</span><span class="token operator">=</span><span class="token number">3</span>
enemies.cheat<span class="token operator">=</span>true
enemies.cheat.level<span class="token operator">=</span>noGoodRotten

ui.properties:
----
color.good<span class="token operator">=</span>purple
how.nice.to.look<span class="token operator">=</span>fairlyNice
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><blockquote><ul><li>File: ini
--from-file</li></ul></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create configmap game-config-3 <span class="token punctuation">\</span>
  --from-file<span class="token operator">=</span>/runfile/configmap/game.properties <span class="token punctuation">\</span>
  --from-file<span class="token operator">=</span>/runfile/configmap/ui.properties

$ kubectl get configmap
NAME               DATA   AGE
game-config        <span class="token number">2</span>      112s
<span class="token variable"><span class="token variable">`</span>game-config-3<span class="token variable">`</span></span>    <span class="token number">2</span>      12s
kube-root-ca.crt   <span class="token number">1</span>      31d

$ kubectl describe configmaps game-config-3
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
Data
<span class="token operator">==</span><span class="token operator">==</span>
game.properties:
----
<span class="token assign-left variable">lives</span><span class="token operator">=</span><span class="token number">3</span>
enemies.cheat<span class="token operator">=</span>true
enemies.cheat.level<span class="token operator">=</span>noGoodRotten

ui.properties:
----
color.good<span class="token operator">=</span>purple
how.nice.to.look<span class="token operator">=</span>fairlyNice
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><blockquote><p>--from-literal</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create configmap special-config <span class="token punctuation">\</span>
--from-literal<span class="token operator">=</span>special.how<span class="token operator">=</span>very <span class="token punctuation">\</span>
--from-literal<span class="token operator">=</span>special.type<span class="token operator">=</span>charm

$ kubectl get configmaps
NAME               DATA   AGE
game-config        <span class="token number">2</span>      2m54s
game-config-3      <span class="token number">2</span>      74s
kube-root-ca.crt   <span class="token number">1</span>      31d
<span class="token variable"><span class="token variable">`</span>special-config<span class="token variable">`</span></span>   <span class="token number">2</span>      8s

$ kubectl describe configmaps special-config
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
Data
<span class="token operator">==</span><span class="token operator">==</span>
special.how:
----
very
special.type:
----
charm
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><blockquote><ul><li>File: yaml
--from-file</li></ul></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> specialconfig<span class="token punctuation">-</span><span class="token number">2</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">key1</span><span class="token punctuation">:</span> value1
  <span class="token key atrule">pro.property</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    key2: value2
    key3: value3</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get configmaps
NAME               DATA   AGE
game-config        <span class="token number">2</span>      4m
game-config-3      <span class="token number">2</span>      2m20s
kube-root-ca.crt   <span class="token number">1</span>      31d
special-config     <span class="token number">2</span>      74s
<span class="token variable"><span class="token variable">`</span>specialconfig-2<span class="token variable">`</span></span>  <span class="token number">2</span>      15s

$ kubectl describe configmaps specialconfig-2
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
Data
<span class="token operator">==</span><span class="token operator">==</span>
pro.property:
----
key2: value2
key3: value3

key1:
----
value1
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="lab52-使用configmap"><a href="#lab52-使用configmap" class="header-anchor">#</a> Lab52. 使用ConfigMap</h3> <blockquote><ul><li>envFrom</li></ul></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cm<span class="token punctuation">-</span>test<span class="token punctuation">-</span>pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cm<span class="token punctuation">-</span>container
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
      <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>  <span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sleep 3000&quot;</span> <span class="token punctuation">]</span>
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>env
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> specialconfig<span class="token punctuation">-</span><span class="token number">2</span>
              <span class="token key atrule">key</span><span class="token punctuation">:</span> key1
      <span class="token key atrule">envFrom</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> specialconfig<span class="token punctuation">-</span><span class="token number">2</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pods
NAME          READY   STATUS    RESTARTS   AGE
cm-test-pod   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          26s

$ kubectl <span class="token builtin class-name">exec</span> -it cm-test-pod  -- /bin/sh
/ <span class="token comment"># env</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
<span class="token assign-left variable">key1</span><span class="token operator">=</span>value1
pro.property<span class="token operator">=</span>key2: value2
key3: value3
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
/ <span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><ul><li>volume</li></ul></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cmpod2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cmpod2
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sleep 3000&quot;</span> <span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> db
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/etc/db&quot;</span>
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> db
    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> specialconfig<span class="token punctuation">-</span><span class="token number">2</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pods
NAME          READY   STATUS    RESTARTS   AGE
cm-test-pod   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m2s
cmpod2        <span class="token number">1</span>/1     Running   <span class="token number">0</span>          28s

$ kubectl <span class="token builtin class-name">exec</span> -it cmpod2 -- /bin/sh
/ <span class="token comment"># ls /etc/db</span>
key1          pro.property
/ <span class="token comment"># cat /etc/db/key1</span>
value1/ <span class="token comment"># cat /etc/db/pro.property</span>
key2: value2
key3: value3
<span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> specialconfig<span class="token punctuation">-</span><span class="token number">2</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">key1</span><span class="token punctuation">:</span> value<span class="token punctuation">-</span>new
  <span class="token key atrule">pro.property</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    key2: value2
    key3: value3</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> -it cmpod2 -- /bin/sh
/ <span class="token comment"># cat /etc/db/key1</span>
value-new
<span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_16-2-secret介绍"><a href="#_16-2-secret介绍" class="header-anchor">#</a> 16.2 Secret介绍</h2> <h3 id="lab52-创建secret"><a href="#lab52-创建secret" class="header-anchor">#</a> Lab52. 创建Secret</h3> <blockquote><ul><li>file</li></ul></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> -n <span class="token string">&quot;admin&quot;</span> <span class="token operator">&gt;</span> username.txt
$ <span class="token builtin class-name">echo</span> -n <span class="token string">&quot;mima&quot;</span> <span class="token operator">&gt;</span> password.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create secret generic db-user-pass <span class="token punctuation">\</span>
--from-file<span class="token operator">=</span>./username.txt <span class="token punctuation">\</span>
--from-file<span class="token operator">=</span>./password.txt

$ kubectl get secret
NAME                  TYPE                                  DATA   AGE
<span class="token variable"><span class="token variable">`</span>db-user-pass<span class="token variable">`</span></span>        Opaque                                <span class="token number">2</span>      6s
default-token-7zfdn   kubernetes.io/service-account-token   <span class="token number">3</span>      31d

$ kubectl describe secrets db-user-pass
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
Data
<span class="token operator">==</span><span class="token operator">==</span>
password.txt:  <span class="token number">4</span> bytes
username.txt:  <span class="token number">5</span> bytes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><blockquote><ul><li>file: yaml</li></ul></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> -n <span class="token string">&quot;admin&quot;</span> <span class="token operator">|</span> base64
<span class="token assign-left variable">YWRtaW4</span><span class="token operator">=</span>

$ <span class="token builtin class-name">echo</span> -n <span class="token string">&quot;mima&quot;</span> <span class="token operator">|</span> base64
<span class="token assign-left variable">bWltYQ</span><span class="token operator">==</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysecret
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">username</span><span class="token punctuation">:</span> YWRtaW4=
  <span class="token key atrule">password</span><span class="token punctuation">:</span> bWltYQ==
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get secrets mysecret
NAME       TYPE     DATA   AGE
mysecret   Opaque   <span class="token number">2</span>      13s

$ kubectl describe secrets mysecret
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
Data
<span class="token operator">==</span><span class="token operator">==</span>
password:  <span class="token number">4</span> bytes
username:  <span class="token number">5</span> bytes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="lab53-使用secret"><a href="#lab53-使用secret" class="header-anchor">#</a> Lab53. 使用Secret</h3> <blockquote><p>挂载全部值</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> spod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">name</span><span class="token punctuation">:</span> spod
    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;sleep 3000&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> secrets
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/etc/secret&quot;</span>
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> secrets
    <span class="token key atrule">secret</span><span class="token punctuation">:</span>
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> mysecret
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pods spod
NAME   READY   STATUS    RESTARTS   AGE
spod   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10s

$ kubectl <span class="token builtin class-name">exec</span> -it spod -- /bin/sh
/ <span class="token comment"># ls /etc/secret</span>
password  username
/ <span class="token comment"># cat /etc/secret/username</span>
admin/ <span class="token comment"># cat /etc/secret/password</span>
mima/ <span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>挂载指定值</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> spod2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">name</span><span class="token punctuation">:</span> spod2
    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;sleep 3000&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> secrets
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/etc/secret&quot;</span>
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> secrets
    <span class="token key atrule">secret</span><span class="token punctuation">:</span>
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> mysecret
      <span class="token key atrule">items</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> password
        <span class="token key atrule">path</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>group/my<span class="token punctuation">-</span>passwd
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod spod2
NAME    READY   STATUS    RESTARTS   AGE
spod2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          58s

$ kubectl <span class="token builtin class-name">exec</span> -it spod2 -- /bin/sh
/ <span class="token comment"># ls /etc/secret</span>
my-group
/ <span class="token comment"># ls /etc/secret/my-group/</span>
my-passwd
/ <span class="token comment"># cat /etc/secret/my-group/my-passwd</span>
mima/ <span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h1 id="_17-statefulset管理与使用"><a href="#_17-statefulset管理与使用" class="header-anchor">#</a> 17. StatefulSet管理与使用</h1> <blockquote><ul><li>pvc</li> <li>statefulset</li> <li>service(headless - clusterIP: None)</li></ul></blockquote> <h2 id="_17-1-使用statefulset"><a href="#_17-1-使用statefulset" class="header-anchor">#</a> 17.1 使用StatefulSet</h2> <h3 id="lab54-statefulset"><a href="#lab54-statefulset" class="header-anchor">#</a> Lab54. StatefulSet</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">mkdir</span> /etc/exports.d /nfs<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">3</span><span class="token punctuation">}</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">sudo</span> <span class="token function">tee</span> /etc/exports.d/s.exports <span class="token operator">&lt;&lt;</span><span class="token string">EOF
/nfs1 *(rw,no_root_squash)
/nfs2 *(rw,no_root_squash)
/nfs3 *(rw,no_root_squash)
EOF</span>
<span class="token function">sudo</span> <span class="token function">apt</span> -y <span class="token function">install</span> nfs-kernel-server <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> nfs-server <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">sudo</span> systemctl restart nfs-server <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
showmount -e

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypv1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>sc
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Recycle
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /nfs1
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.147.128
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypv2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>sc
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Recycle
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /nfs2
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.147.128
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypv3
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>sc
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Recycle
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /nfs3
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.147.128
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get <span class="token function">pv</span>
NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
mypv1   1Gi        RWO            Recycle          Available           my-sc                   41s
mypv2   1Gi        RWO            Recycle          Available           my-sc                   41s
mypv3   1Gi        RWO            Recycle          Available           my-sc                   10s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> web
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> stor
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html
  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> stor
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;ReadWriteOnce&quot;</span> <span class="token punctuation">]</span>
      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token string">&quot;my-sc&quot;</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span>
        <span class="token key atrule">requests</span><span class="token punctuation">:</span>
          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">watch</span> -n <span class="token number">1</span> kubectl get pod
NAME    READY   STATUS    RESTARTS   AGE
<span class="token variable"><span class="token variable">`</span>web-0<span class="token variable">`</span></span> <span class="token number">1</span>/1     Running   <span class="token number">0</span>          79s
<span class="token variable"><span class="token variable">`</span>web-1<span class="token variable">`</span></span> <span class="token number">1</span>/1     Running   <span class="token number">0</span>          55s
<span class="token variable"><span class="token variable">`</span>web-2<span class="token variable">`</span></span> <span class="token number">1</span>/1     Running   <span class="token number">0</span>          30s
<span class="token operator">&lt;</span>Ctrl-C<span class="token operator">&gt;</span>

$ kubectl get pvc
NAME         STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
stor-web-0   Bound    mypv1    1Gi        RWO            my-sc          112s
stor-web-1   Bound    mypv2    1Gi        RWO            my-sc          88s
stor-web-2   Bound    mypv3    1Gi        RWO            my-sc          63s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> web
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get svc nginx
NAME    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
nginx   ClusterIP   None         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    15s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> clientpod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> clientpod
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>1.28.3
      <span class="token key atrule">args</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /bin/sh
      <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
      <span class="token punctuation">-</span> sleep 3h
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> -it clientpod -- /bin/sh
/ <span class="token comment"># nslookup nginx</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
Name:      nginx
Address <span class="token number">1</span>: <span class="token number">172.16</span>.194.66 web-2.nginx.default.svc.cluster.local
Address <span class="token number">2</span>: <span class="token number">172.16</span>.126.1 web-0.nginx.default.svc.cluster.local
Address <span class="token number">3</span>: <span class="token number">172.16</span>.194.65 web-1.nginx.default.svc.cluster.local
/ <span class="token comment"># nslookup web-0.nginx</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
Name:      web-0.nginx
Address <span class="token number">1</span>: <span class="token number">172.16</span>.126.1 web-0.nginx.default.svc.cluster.local

/<span class="token comment"># exit</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="lab55-statefulset的故障处理"><a href="#lab55-statefulset的故障处理" class="header-anchor">#</a> Lab55. StatefulSet的故障处理</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">touch</span> /nfs1/newfile

$ kubectl <span class="token builtin class-name">exec</span> -it web-1 -- <span class="token function">ls</span> /usr/share/nginx/html
newfile

$ kubectl <span class="token builtin class-name">exec</span> -it clientpod -- <span class="token function">nslookup</span> web-1.nginx
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
Address <span class="token number">3</span>: <span class="token number">172.16</span>.194.<span class="token variable"><span class="token variable">`</span><span class="token number">65</span><span class="token variable">`</span></span> web-1.nginx.default.svc.cluster.local

$ kubectl delete pod web-1
pod <span class="token string">&quot;web-1&quot;</span> deleted

$ kubectl <span class="token builtin class-name">exec</span> -it clientpod -- <span class="token function">nslookup</span> web-1.nginx
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
Name:      web-1.nginx
Address <span class="token number">1</span>: <span class="token number">172.16</span>.194.<span class="token variable"><span class="token variable">`</span><span class="token number">67</span><span class="token variable">`</span></span> web-1.nginx.default.svc.cluster.local

$ k <span class="token builtin class-name">exec</span> -it web-1 -- <span class="token function">ls</span> /usr/share/nginx/html
newfile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="lab56-扩缩容和升级"><a href="#lab56-扩缩容和升级" class="header-anchor">#</a> Lab56. 扩缩容和升级</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">watch</span> -n <span class="token number">1</span> kubectl get pod
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>新开个终端</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl scale statefulset web --replicas<span class="token operator">=</span><span class="token number">1</span>

$ kubectl scale statefulset web --replicas<span class="token operator">=</span><span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="lab57-pod管理策略"><a href="#lab57-pod管理策略" class="header-anchor">#</a> Lab57. Pod管理策略</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl delete statefulsets web
kubectl delete pvc stor-web-0 stor-web-1 stor-web-2

$ kubectl get svc

$ kubectl get <span class="token function">pv</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx
  <span class="token comment"># 增加 1 行</span>
  <span class="token key atrule">podManagementPolicy</span><span class="token punctuation">:</span> <span class="token string">&quot;Parallel&quot;</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> web
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> stor
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html
  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> stor
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;ReadWriteOnce&quot;</span> <span class="token punctuation">]</span>
      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token string">&quot;my-sc&quot;</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span>
        <span class="token key atrule">requests</span><span class="token punctuation">:</span>
          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">watch</span> -n <span class="token number">1</span> kubectl get pod
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>新开个终端</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl scale statefulset web --replicas<span class="token operator">=</span><span class="token number">1</span>

$ kubectl scale statefulset web --replicas<span class="token operator">=</span><span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h1 id="_18-kubernetes服务质量"><a href="#_18-kubernetes服务质量" class="header-anchor">#</a> 18. Kubernetes服务质量</h1> <h2 id="_18-1-qos原理与使用"><a href="#_18-1-qos原理与使用" class="header-anchor">#</a> 18.1 QoS原理与使用</h2> <h3 id="lab58-qos"><a href="#lab58-qos" class="header-anchor">#</a> Lab58. Qos</h3> <blockquote><p>节点资源</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get <span class="token function">node</span> k8s-worker1 -o yaml <span class="token operator">|</span> <span class="token function">grep</span> -A <span class="token number">13</span> allo
 <span class="token variable"><span class="token variable">`</span>allocatable<span class="token variable">`</span></span><span class="token builtin class-name">:</span>
    cpu: <span class="token string">&quot;2&quot;</span>
    ephemeral-storage: <span class="token string">&quot;36496716535&quot;</span>
    hugepages-1Gi: <span class="token string">&quot;0&quot;</span>
    hugepages-2Mi: <span class="token string">&quot;0&quot;</span>
    memory: 3892256Ki
    pods: <span class="token string">&quot;110&quot;</span>
 <span class="token variable"><span class="token variable">`</span>capacity<span class="token variable">`</span></span><span class="token builtin class-name">:</span>
    cpu: <span class="token string">&quot;2&quot;</span>
    ephemeral-storage: 39601472Ki
    hugepages-1Gi: <span class="token string">&quot;0&quot;</span>
    hugepages-2Mi: <span class="token string">&quot;0&quot;</span>
    memory: 3994656Ki
    pods: <span class="token string">&quot;110&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><blockquote><p>Guaranteed</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> qos<span class="token punctuation">-</span>demo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> qos<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>ctr
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;200Mi&quot;</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;700m&quot;</span>
      <span class="token key atrule">requests</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;200Mi&quot;</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;700m&quot;</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod qos-demo -o yaml <span class="token operator">|</span> <span class="token function">grep</span> qosC
  qosClass: <span class="token variable"><span class="token variable">`</span>Guaranteed<span class="token variable">`</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>Burstable</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> qos<span class="token punctuation">-</span>demo<span class="token punctuation">-</span><span class="token number">2</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> qos<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>2<span class="token punctuation">-</span>ctr
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;200Mi&quot;</span>
      <span class="token key atrule">requests</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;100Mi&quot;</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod qos-demo-2 -o yaml <span class="token operator">|</span> <span class="token function">grep</span> qosC
  qosClass: <span class="token variable"><span class="token variable">`</span>Burstable<span class="token variable">`</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>BestEffort</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> qos<span class="token punctuation">-</span>demo<span class="token punctuation">-</span><span class="token number">3</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> qos<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>3<span class="token punctuation">-</span>ctr
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod qos-demo-3 -o yaml <span class="token operator">|</span> <span class="token function">grep</span> qosC
  qosClass: <span class="token variable"><span class="token variable">`</span>BestEffort<span class="token variable">`</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>超出容器的内存限制</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> memory<span class="token punctuation">-</span>demo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> memory<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>ctr
    <span class="token key atrule">image</span><span class="token punctuation">:</span> polinux/stress
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;100Mi&quot;</span>
      <span class="token key atrule">requests</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;50Mi&quot;</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;stress&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;--vm&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--vm-bytes&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;150M&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--vm-hang&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">]</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod memory-demo
NAME          READY   STATUS      RESTARTS   AGE
memory-demo   <span class="token number">0</span>/1    <span class="token variable"><span class="token variable">`</span>OOMKilled<span class="token variable">`</span></span>  <span class="token number">0</span>          20s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe pod memory-demo <span class="token operator">|</span> <span class="token function">grep</span> -A <span class="token number">2</span> Last
    Last State:     Terminated
      Reason:       OOMKilled
      Exit Code:    <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>超出节点可用资源</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> memory<span class="token punctuation">-</span>demo2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> memory<span class="token punctuation">-</span>demo2<span class="token punctuation">-</span>ctr
    <span class="token key atrule">image</span><span class="token punctuation">:</span> polinux/stress
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;1000Gi&quot;</span>
      <span class="token key atrule">requests</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;1000Gi&quot;</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;stress&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;--vm&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--vm-bytes&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;150M&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--vm-hang&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">]</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod memory-demo2
NAME           READY   STATUS    RESTARTS   AGE
memory-demo2   <span class="token number">0</span>/1    <span class="token variable"><span class="token variable">`</span>Pending<span class="token variable">`</span></span>  <span class="token number">0</span>          22s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe pod memory-demo2 <span class="token operator">|</span> <span class="token function">tail</span> -n <span class="token number">1</span>
  Warning  FailedScheduling  10s <span class="token punctuation">(</span>x2 over 72s<span class="token punctuation">)</span>  default-scheduler  <span class="token number">0</span>/3 nodes are available: <span class="token number">1</span> node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> had taint <span class="token punctuation">{</span>node-role.kubernetes.io/master: <span class="token punctuation">}</span>, that the pod didn't tolerate, <span class="token number">2</span> Insufficient memory.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h1 id="_19-kubernetes资源调度"><a href="#_19-kubernetes资源调度" class="header-anchor">#</a> 19. Kubernetes资源调度</h1> <h2 id="_19-1-k8s资源管理"><a href="#_19-1-k8s资源管理" class="header-anchor">#</a> 19.1 k8s资源管理</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get <span class="token function">node</span> k8s-worker1 -o yaml <span class="token operator">|</span> <span class="token function">grep</span> -A <span class="token number">19</span> ^status
status:
  addresses:
  - address: <span class="token number">192.168</span>.147.129
    type: InternalIP
  - address: k8s-worker1
    type: Hostname
  allocatable:
    cpu: <span class="token string">&quot;2&quot;</span>
    ephemeral-storage: <span class="token string">&quot;36496716535&quot;</span>
    hugepages-1Gi: <span class="token string">&quot;0&quot;</span>
    hugepages-2Mi: <span class="token string">&quot;0&quot;</span>
    memory: 3892256Ki
    pods: <span class="token string">&quot;110&quot;</span>
  capacity:
    cpu: <span class="token string">&quot;2&quot;</span>
    ephemeral-storage: 39601472Ki
    hugepages-1Gi: <span class="token string">&quot;0&quot;</span>
    hugepages-2Mi: <span class="token string">&quot;0&quot;</span>
    memory: 3994656Ki
    pods: <span class="token string">&quot;110&quot;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubelet -h <span class="token operator">|</span> <span class="token function">grep</span> eviction-hard.*map
      --eviction-hard mapStringString                            A <span class="token builtin class-name">set</span> of eviction thresholds <span class="token punctuation">(</span>e.g. memory.available<span class="token operator">&lt;</span>1Gi<span class="token punctuation">)</span> that <span class="token keyword">if</span> met would trigger a pod eviction. <span class="token punctuation">(</span>default imagefs.available<span class="token operator">&lt;</span><span class="token number">15</span>%,memory.available<span class="token operator">&lt;</span>100Mi,nodefs.available<span class="token operator">&lt;</span><span class="token number">10</span>%,nodefs.inodesFree<span class="token operator">&lt;</span><span class="token number">5</span>%<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_19-2-k8s调度器"><a href="#_19-2-k8s调度器" class="header-anchor">#</a> 19.2 k8s调度器</h2> <h2 id="_19-3-k8s高度策略"><a href="#_19-3-k8s高度策略" class="header-anchor">#</a> 19.3 k8s高度策略</h2> <h2 id="_19-4-k8s调度优先级和抢占机制"><a href="#_19-4-k8s调度优先级和抢占机制" class="header-anchor">#</a> 19.4 k8s调度优先级和抢占机制</h2> <h3 id="lab59-priorityclass"><a href="#lab59-priorityclass" class="header-anchor">#</a> Lab59. Priorityclass</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get priorityclasses
NAME                      VALUE        GLOBAL-DEFAULT   AGE
system-cluster-critical   <span class="token number">2000000000</span>   <span class="token boolean">false</span>            34d
system-node-critical      <span class="token number">2000001000</span>   <span class="token boolean">false</span>            34d

$ kubectl describe priorityclasses system-cluster-critical
Name:           system-cluster-critical
Value:          <span class="token number">2000000000</span>
GlobalDefault:  <span class="token boolean">false</span>
Description:    Used <span class="token keyword">for</span> system critical pods that must run <span class="token keyword">in</span> the cluster, but can be moved to another <span class="token function">node</span> <span class="token keyword">if</span> necessary.
Annotations:    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Events:         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

$ kubectl describe priorityclasses system-node-critical
Name:           system-node-critical
Value:          <span class="token number">2000001000</span>
GlobalDefault:  <span class="token boolean">false</span>
Description:    Used <span class="token keyword">for</span> system critical pods that must not be moved from their current node.
Annotations:    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Events:         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> scheduling.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PriorityClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  
  <span class="token key atrule">name</span><span class="token punctuation">:</span> high<span class="token punctuation">-</span>priority
<span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">1000000</span>
<span class="token key atrule">globalDefault</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
  <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> high<span class="token punctuation">-</span>priority
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe pod nginx <span class="token operator">|</span> <span class="token function">grep</span> Priority
Priority:            <span class="token variable"><span class="token variable">`</span><span class="token number">1000000</span><span class="token variable">`</span></span>
Priority Class Name:  high-priority
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span><span class="token number">1</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
<span class="token comment"># priorityClassName: high-priority</span>
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe pod nginx-1 <span class="token operator">|</span> <span class="token function">grep</span> Pri
Priority:    <span class="token variable"><span class="token variable">`</span><span class="token number">0</span><span class="token variable">`</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h1 id="_20-kubernetes-dashboard"><a href="#_20-kubernetes-dashboard" class="header-anchor">#</a> 20. Kubernetes Dashboard</h1> <h2 id="_20-1-dashboard介绍"><a href="#_20-1-dashboard介绍" class="header-anchor">#</a> 20.1 Dashboard介绍</h2> <h3 id="lab60-部署-dashboard-ui"><a href="#lab60-部署-dashboard-ui" class="header-anchor">#</a> Lab60. <a href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/web-ui-dashboard/#%E9%83%A8%E7%BD%B2-dashboard-ui" target="_blank" rel="noopener noreferrer">部署 Dashboard UI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <div style="background:#dbfaf4;padding:12px;line-height:24px;margin-bottom:24px;"><dt style="background:#1abc9c;padding:6px 12px;font-weight:bold;display:block;color:#fff;margin:-12px;margin-bottom:12px;">Hint - 提示</dt> <li> 国内默认无法访问 https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
</li></div> <blockquote><ol><li>安装</li></ol></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>*$ kubectl apply -f https://rt.vmcc.xyz:8080/K8s/dashboard/v2.7.0/aio/deploy/recommended.yaml
:<span class="token operator">&lt;&lt;</span><span class="token string">EOF
namespace/<span class="token variable"><span class="token variable">`</span>kubernetes-dashboard<span class="token variable">`</span></span> created
serviceaccount/kubernetes-dashboard created
service/kubernetes-dashboard created
secret/kubernetes-dashboard-certs created
secret/kubernetes-dashboard-csrf created
secret/kubernetes-dashboard-key-holder created
configmap/kubernetes-dashboard-settings created
role.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created
rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
deployment.apps/kubernetes-dashboard created
service/dashboard-metrics-scraper created
deployment.apps/dashboard-metrics-scraper created
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n kubernetes-dashboard get pods -owide
NAME                                         READY   STATUS    RESTARTS   AGE    IP              NODE          NOMINATED NODE   READINESS GATES
dashboard-metrics-scraper-799d786dbf-r7dp9   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          115s   <span class="token number">172.16</span>.194.65   k8s-worker2   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kubernetes-<span class="token variable"><span class="token variable">`</span>dashboard<span class="token variable">`</span></span>-546cbc58cd-2lvxt      <span class="token number">1</span>/1     <span class="token variable"><span class="token variable">`</span>Running<span class="token variable">`</span></span>   <span class="token number">0</span>          115s   <span class="token number">172.16</span>.126.1   k8s-worker2  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><ol start="2"><li><p>通过物理机使用==chrome==访问==thisisunsafe==</p> <p>https://192.168.147.128:30291</p></li></ol></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>*$ kubectl -n kubernetes-dashboard <span class="token punctuation">\</span>
     patch svc kubernetes-dashboard -p <span class="token string">'{&quot;spec&quot;:{&quot;type&quot;:&quot;NodePort&quot;}}'</span> 

$ kubectl -n kubernetes-dashboard get svc
NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>         AGE
dashboard-metrics-scraper   ClusterIP   <span class="token number">10.103</span>.222.187   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8000</span>/TCP        6m2s
kubernetes-dashboard       <span class="token variable"><span class="token variable">`</span>NodePort<span class="token variable">`</span></span>   <span class="token number">10.97</span>.233.31     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>:<span class="token variable"><span class="token variable">`</span><span class="token number">30291</span><span class="token variable">`</span></span>/TCP   6m3s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><ol start="3"><li>查看服务帐号kubernetes-dashboard的登陆 token</li></ol></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>针对最新版本 <span class="token number">2.7</span>，默认未创建token
$ kubectl -n kubernetes-dashboard create token kubernetes-dashboard
:<span class="token operator">&lt;&lt;</span><span class="token string">EOF
<span class="token variable"><span class="token variable">`</span>eyJhbGciOiJSUzI1NiIsImtpZCI6ImgzVlpPT1l6RXJaVlJhTVZjbU4tVWt1anRUSmxncnM2WFhrSUw0dGVVUUkifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNjcxOTM4Nzc3LCJpYXQiOjE2NzE5MzUxNzcsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInVpZCI6IjdjZDRlNTVjLWRiZmEtNDg2OS1iMjA0LWNjZGE5NzVhYTExZCJ9fSwibmJmIjoxNjcxOTM1MTc3LCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQifQ.d3hMeEsbBjxAPy70bfUno2EkAinl_2VbTOtoL1rJ9vp_dIWatZcR5m-L0yuB0-WaVK2elA_OZk-_w9HoWcmei9x_0hNHMjvYMKbuH1VneqsB1z_NzBsNzEL9lMm7UeHE5DkFPPRUF4oISBhpr5KVC8nOHSPqW5wGCmD02l0k0uVX3vYzXv0yQyl_D7FPyiuFnO4G5i4jzS54FcREK5PX36xVgLp5TaPJcF4bHPong3vqFyx67nlP9PgYDJBylkpKFDfnhO30EoRcRlKMOnIId654y8Zk_dy7e7oRhVjKs7v_jev4N3U9WyNP_ZMUQ_EupjNCnMiMxqRuYYGwwCX0bQ<span class="token variable">`</span></span>
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><ol start="4"><li>提权</li></ol></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n kubernetes-dashboard <span class="token punctuation">\</span>
  describe clusterrole cluster-admin
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
PolicyRule:
  Resources  Non-Resource URLs  Resource Names  Verbs
  ---------  -----------------  --------------  -----
  *.*        <span class="token punctuation">[</span><span class="token punctuation">]</span>                 <span class="token punctuation">[</span><span class="token punctuation">]</span>              <span class="token punctuation">[</span>*<span class="token punctuation">]</span>
             <span class="token punctuation">[</span>*<span class="token punctuation">]</span>                <span class="token punctuation">[</span><span class="token punctuation">]</span>              <span class="token punctuation">[</span>*<span class="token punctuation">]</span>

$ kubectl -n kubernetes-dashboard <span class="token punctuation">\</span>
  describe clusterrole kubernetes-dashboard
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
PolicyRule:
  Resources             Non-Resource URLs  Resource Names  Verbs
  ---------             -----------------  --------------  -----
  nodes.metrics.k8s.io  <span class="token punctuation">[</span><span class="token punctuation">]</span>                 <span class="token punctuation">[</span><span class="token punctuation">]</span>              <span class="token punctuation">[</span>get list watch<span class="token punctuation">]</span>
  pods.metrics.k8s.io   <span class="token punctuation">[</span><span class="token punctuation">]</span>                 <span class="token punctuation">[</span><span class="token punctuation">]</span>              <span class="token punctuation">[</span>get list watch<span class="token punctuation">]</span>

*$ kubectl create clusterrolebinding <span class="token punctuation">\</span>
      kubernetes-dashboard-cluster-admin <span class="token punctuation">\</span>
      --clusterrole<span class="token operator">=</span>cluster-admin <span class="token punctuation">\</span>
      --serviceaccount<span class="token operator">=</span>kubernetes-dashboard:kubernetes-dashboard

$ kubectl get clusterrolebindings -owide <span class="token operator">|</span> <span class="token function">grep</span> dash
kubernetes-dashboard-cluster-admin  ClusterRole/cluster-admin  6m34s  kubernetes-dashboard/kubernetes-dashboard
kubernetes-dashboard  ClusterRole/kubernetes-dashboard  88m  kubernetes-dashboard/kubernetes-dashboard
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><blockquote><ol start="5"><li><p>登陆</p> <p>https://k8s-master:30291</p></li></ol></blockquote> <h3 id="lab61-kubeconfig-方式认证"><a href="#lab61-kubeconfig-方式认证" class="header-anchor">#</a> Lab61. kubeconfig 方式认证</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n kube-system create sa dashboard-admin

$ kubectl create clusterrolebinding dashboard-admin <span class="token punctuation">\</span>
  --clusterrole<span class="token operator">=</span>cluster-admin <span class="token punctuation">\</span>
  --serviceaccount<span class="token operator">=</span>kube-system:dashboard-admin

$ <span class="token assign-left variable">DASH_TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl -n kube-system create token dashboard-admin<span class="token variable">)</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>创建 dashboard-admin.kubeconfig</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token assign-left variable">SIP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ip</span> a <span class="token operator">|</span> <span class="token function">grep</span> -w inet.*brd <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $2}'</span><span class="token variable">)</span></span>

<span class="token number">1</span>/4 生成文件，设置集群
*$ kubectl config set-cluster ck8s <span class="token punctuation">\</span>
  --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.crt <span class="token punctuation">\</span>
	--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
	--server<span class="token operator">=</span>https://<span class="token variable">${SIP<span class="token operator">%</span><span class="token operator">/</span>*}</span>:6443 <span class="token punctuation">\</span>
	--kubeconfig<span class="token operator">=</span>dashboard-admin.kubeconfig

<span class="token number">2</span>/4 修改文件，设置上下文关系
*$ kubectl config set-context dashboard-admin@ck8s <span class="token punctuation">\</span>
	--cluster<span class="token operator">=</span>ck8s <span class="token punctuation">\</span>
	--user<span class="token operator">=</span>dashboard-admin <span class="token punctuation">\</span>
	--kubeconfig<span class="token operator">=</span>dashboard-admin.kubeconfig

<span class="token number">3</span>/4 修改文件，设置令牌
*$ kubectl config set-credentials dashboard-admin <span class="token punctuation">\</span>
  --token<span class="token operator">=</span><span class="token variable">${DASH_TOKEN}</span> <span class="token punctuation">\</span>
  --kubeconfig<span class="token operator">=</span>dashboard-admin.kubeconfig

<span class="token number">4</span>/4 修改文件，切换集群
*$ kubectl config use-context dashboard-admin@ck8s <span class="token punctuation">\</span>
	--kubeconfig<span class="token operator">=</span>dashboard-admin.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ vimdiff ~/.kube/config dashboard-admin.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>物理机[ chrome | firefox ]</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">scp</span> kiosk@k8s-master:~/.kube/config <span class="token builtin class-name">.</span>
$ <span class="token function">scp</span> kiosk@k8s-master:~/dashboard-admin.kubeconfig <span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_20-2-dashboard功能"><a href="#_20-2-dashboard功能" class="header-anchor">#</a> 20.2 Dashboard功能</h2> <h2 id="_20-3-dashboard部署应用"><a href="#_20-3-dashboard部署应用" class="header-anchor">#</a> 20.3 Dashboard部署应用</h2> <h1 id="_21-helm包管理工具"><a href="#_21-helm包管理工具" class="header-anchor">#</a> 21. Helm包管理工具</h1> <h2 id="_21-1-helm简介"><a href="#_21-1-helm简介" class="header-anchor">#</a> 21.1 Helm简介</h2> <blockquote><ul><li>apt/ubuntu, yum/centos</li> <li>docker compose -=&gt; harbor</li> <li>helm -=&gt; harbor</li></ul></blockquote> <h2 id="_21-2-使用helm"><a href="#_21-2-使用helm" class="header-anchor">#</a> 21.2 使用Helm</h2> <h3 id="lab62-安装、使用helm"><a href="#lab62-安装、使用helm" class="header-anchor">#</a> Lab62. 安装、使用Helm</h3> <blockquote><p><a href="https://helm.sh/docs/intro/install/" target="_blank" rel="noopener noreferrer">install helm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language- extra-class"><pre><code>  https://get.helm.sh/helm-v3.10.3-linux-amd64.tar.gz
</code></pre></div></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> https://rt.vmcc.xyz:8080/K8s/helm/helm-v3.10.3-linux-amd64.tar.gz <span class="token punctuation">\</span>
  -<span class="token comment"># \</span>
  -o helm-v3.10.3-linux-amd64.tar.gz
<span class="token function">sudo</span> <span class="token function">tar</span> xf helm-v3.10.3-linux-amd64.tar.gz
<span class="token function">sudo</span> <span class="token function">mv</span> linux-amd64/helm /usr/local/bin/

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>使用 Helm</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>立即生效
$ <span class="token builtin class-name">source</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>helm completion <span class="token function">bash</span><span class="token punctuation">)</span>

永久生效
$ helm completion <span class="token function">bash</span> <span class="token operator">&gt;&gt;</span> ~/.bashrc <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">source</span> ~/.bashrc

$ helm version

$ helm search hub wordpress
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ helm repo <span class="token function">add</span> harbor https://helm.goharbor.io
$ helm repo update
Hang tight <span class="token keyword">while</span> we grab the latest from your chart repositories<span class="token punctuation">..</span>.
<span class="token punctuation">..</span>.Successfully got an update from the <span class="token string">&quot;harbor&quot;</span> chart repository
Update Complete. ⎈Happy Helming<span class="token operator">!</span>⎈

$ helm repo list
NAME   	URL
harbor	https://helm.goharbor.io

$ helm search repo harbor
NAME         	CHART VERSION	APP VERSION	DESCRIPTION
<span class="token variable"><span class="token variable">`</span>harbor/harbor<span class="token variable">`</span></span>	<span class="token number">1.11</span>.0       	<span class="token number">2.7</span>.0      	An <span class="token function">open</span> <span class="token builtin class-name">source</span> trusted cloud native registry th<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ helm <span class="token function">install</span> harbor/harbor --generate-name
NAME: harbor-1671940119
LAST DEPLOYED: Sun Dec <span class="token number">25</span> 03:48:40 <span class="token number">2022</span>
NAMESPACE: default
STATUS: deployed
REVISION: <span class="token number">1</span>
TEST SUITE: None
NOTES:
Please <span class="token function">wait</span> <span class="token keyword">for</span> several minutes <span class="token keyword">for</span> Harbor deployment to complete.
Then you should be able to visit the Harbor portal at https://core.harbor.domain
For <span class="token function">more</span> details, please visit https://github.com/goharbor/harbor
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ helm list
NAME             	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART        	APP VERSION
<span class="token variable"><span class="token variable">`</span>harbor-1671940119<span class="token variable">`</span></span>	default  	<span class="token number">1</span>       	<span class="token number">2022</span>-12-25 03:48:40.543797179 +0000 UTC	deployed	harbor-1.11.0	<span class="token number">2.7</span>.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ helm uninstall harbor-1671940119
These resources were kept due to the resource policy:
<span class="token punctuation">[</span>PersistentVolumeClaim<span class="token punctuation">]</span> harbor-1671940119-chartmuseum
<span class="token punctuation">[</span>PersistentVolumeClaim<span class="token punctuation">]</span> harbor-1671940119-jobservice-scandata
<span class="token punctuation">[</span>PersistentVolumeClaim<span class="token punctuation">]</span> harbor-1671940119-jobservice
<span class="token punctuation">[</span>PersistentVolumeClaim<span class="token punctuation">]</span> harbor-1671940119-registry

release <span class="token string">&quot;harbor-1671940119&quot;</span> uninstalled
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_21-3-chart简介"><a href="#_21-3-chart简介" class="header-anchor">#</a> 21.3 Chart简介</h2> <h3 id="lab63-chart"><a href="#lab63-chart" class="header-anchor">#</a> Lab63. Chart</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">ls</span> ~/.cache/helm/repository
harbor-1.11.0.tgz  harbor-charts.txt  harbor-index.yaml

$ <span class="token function">tar</span> xf ~/.cache/helm/repository/harbor-1.11.0.tgz

$ <span class="token function">sudo</span> <span class="token function">apt</span> -y <span class="token function">install</span> tree

$ tree harbor/
harbor/
├── Chart.yaml
├── LICENSE
├── README.md
├── cert
│   ├── tls.crt
│   └── tls.key
├── conf
│   ├── notary-server.json
│   └── notary-signer.json
├── templates
│   ├── NOTES.txt
│   ├── _helpers.tpl
│   ├── chartmuseum
│   │   ├── chartmuseum-cm.yaml
│   │   ├── chartmuseum-dpl.yaml
│   │   ├── chartmuseum-pvc.yaml
│   │   ├── chartmuseum-secret.yaml
│   │   ├── chartmuseum-svc.yaml
│   │   └── chartmuseum-tls.yaml
│   ├── core
│   │   ├── core-cm.yaml
│   │   ├── core-dpl.yaml
│   │   ├── core-pre-upgrade-job.yaml
│   │   ├── core-secret.yaml
│   │   ├── core-svc.yaml
│   │   └── core-tls.yaml
│   ├── database
│   │   ├── database-secret.yaml
│   │   ├── database-ss.yaml
│   │   └── database-svc.yaml
│   ├── exporter
│   │   ├── exporter-cm-env.yaml
│   │   ├── exporter-dpl.yaml
│   │   ├── exporter-secret.yaml
│   │   └── exporter-svc.yaml
│   ├── ingress
│   │   ├── ingress.yaml
│   │   └── secret.yaml
│   ├── internal
│   │   └── auto-tls.yaml
│   ├── jobservice
│   │   ├── jobservice-cm-env.yaml
│   │   ├── jobservice-cm.yaml
│   │   ├── jobservice-dpl.yaml
│   │   ├── jobservice-pvc-scandata.yaml
│   │   ├── jobservice-pvc.yaml
│   │   ├── jobservice-secrets.yaml
│   │   ├── jobservice-svc.yaml
│   │   └── jobservice-tls.yaml
│   ├── metrics
│   │   └── metrics-svcmon.yaml
│   ├── nginx
│   │   ├── configmap-http.yaml
│   │   ├── configmap-https.yaml
│   │   ├── deployment.yaml
│   │   ├── secret.yaml
│   │   └── service.yaml
│   ├── notary
│   │   ├── notary-secret.yaml
│   │   ├── notary-server.yaml
│   │   ├── notary-signer.yaml
│   │   └── notary-svc.yaml
│   ├── portal
│   │   ├── configmap.yaml
│   │   ├── deployment.yaml
│   │   ├── service.yaml
│   │   └── tls.yaml
│   ├── redis
│   │   ├── service.yaml
│   │   └── statefulset.yaml
│   ├── registry
│   │   ├── registry-cm.yaml
│   │   ├── registry-dpl.yaml
│   │   ├── registry-pvc.yaml
│   │   ├── registry-secret.yaml
│   │   ├── registry-svc.yaml
│   │   ├── registry-tls.yaml
│   │   ├── registryctl-cm.yaml
│   │   └── registryctl-secret.yaml
│   └── trivy
│       ├── trivy-secret.yaml
│       ├── trivy-sts.yaml
│       ├── trivy-svc.yaml
│       └── trivy-tls.yaml
└── <span class="token variable"><span class="token variable">`</span>values.yaml<span class="token variable">`</span></span>

<span class="token number">17</span> directories, <span class="token number">68</span> files
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br></div></div><h2 id="_21-4-chart模板的使用"><a href="#_21-4-chart模板的使用" class="header-anchor">#</a> 21.4 Chart模板的使用</h2> <h3 id="lab64-helm-部署-harbor"><a href="#lab64-helm-部署-harbor" class="header-anchor">#</a> Lab64. Helm 部署 harbor</h3> <blockquote><ol><li><a href="https://goharbor.io/docs/2.7.0/install-config/harbor-ha-helm/" target="_blank" rel="noopener noreferrer">Download Chart<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
默认需要使用 storageClass</li></ol></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ helm repo <span class="token function">add</span> harbor https://helm.goharbor.io

$ helm fetch harbor/harbor --untar

$ <span class="token function">vim</span> harbor/values.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><ol start="2"><li>创建 storageClass</li></ol></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">## nfs-server</span>
<span class="token assign-left variable">HARBOR_FOLDER</span><span class="token operator">=</span>/harbor_data
<span class="token keyword">while</span> <span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token function">grep</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token function">apt</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">sleep</span> 1s<span class="token punctuation">;</span> <span class="token keyword">done</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y nfs-kernel-server
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$HARBOR_FOLDER</span> *(rw,no_root_squash)&quot;</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/exports
<span class="token function">sudo</span> <span class="token function">mkdir</span> -m <span class="token number">777</span> <span class="token variable">$HARBOR_FOLDER</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> nfs-server
<span class="token function">sudo</span> systemctl restart nfs-server

<span class="token comment">## nfs-common</span>
<span class="token assign-left variable">USER_PASSWORD</span><span class="token operator">=</span>ubuntu
<span class="token assign-left variable">NODES</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get nodes -o custom-columns<span class="token operator">=</span>master:.metadata.name <span class="token operator">|</span> <span class="token function">grep</span> -v master<span class="token variable">)</span></span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable">$NODES</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
	sshpass -p <span class="token variable">${USER_PASSWORD}</span> <span class="token function">ssh</span> -o <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no <span class="token environment constant">$USER</span>@<span class="token variable">${i}</span> <span class="token string">&quot;
		if sudo apt list nfs-common | grep -wq installed; then
			echo nfs-common is already the newest version
		else
			while ps aux | grep -v grep | grep apt; do sleep 1s; done
			sudo apt install nfs-common -y
		fi&quot;</span>
<span class="token keyword">done</span>

<span class="token comment">## NFS subdir 外部驱动</span>
<span class="token comment">### k8s.gcr.io/sig-storage/nfs-subdir-external-provisioner</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">URL1</span><span class="token operator">=</span>registry.cn-hangzhou.aliyuncs.com/k-cka
<span class="token builtin class-name">export</span> <span class="token assign-left variable">URL2</span><span class="token operator">=</span>k8s.gcr.io/sig-storage
<span class="token builtin class-name">export</span> <span class="token assign-left variable">IMGN</span><span class="token operator">=</span>nfs-subdir-external-provisioner
<span class="token builtin class-name">export</span> <span class="token assign-left variable">IMGV</span><span class="token operator">=</span>v4.0.2
<span class="token assign-left variable">NODE2</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get nodes -o custom-columns<span class="token operator">=</span>:.metadata.name <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">2</span><span class="token variable">)</span></span>
<span class="token assign-left variable">GIT_URL</span><span class="token operator">=</span>https://vmcc.xyz:8443/k8s/storageClass
sshpass -p <span class="token variable">${USER_PASSWORD}</span> <span class="token function">ssh</span> -o <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no kiosk@<span class="token variable">$NODE2</span> <span class="token string">&quot;
	sudo ctr -n k8s.io image pull <span class="token variable">$URL1</span>/<span class="token variable">$IMGN</span>:<span class="token variable">$IMGV</span>
	sudo ctr -n k8s.io image tag <span class="token variable">$URL1</span>/<span class="token variable">$IMGN</span>:<span class="token variable">$IMGV</span> <span class="token variable">$URL2</span>/<span class="token variable">$IMGN</span>:<span class="token variable">$IMGV</span>&quot;</span>
<span class="token comment">### https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner</span>
<span class="token comment">#### 1/3 rbac.yaml</span>
kubectl apply -f <span class="token variable">$GIT_URL</span>/rbac.yaml
<span class="token comment">#### 2/3 deployment.yaml</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">SIP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ip</span> a <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'/brd.*ens/ {print $2}'</span><span class="token variable">)</span></span>
<span class="token function">curl</span> <span class="token variable">$GIT_URL</span>/deployment.yaml -<span class="token comment"># -o /tmp/deployment.yaml</span>
<span class="token function">sed</span> -e <span class="token string">&quot;/NFS_SERVER/{N; s?value:.*?value: <span class="token variable">${SIP<span class="token operator">%</span><span class="token operator">/</span>*}</span>?}&quot;</span> <span class="token punctuation">\</span>
	-e <span class="token string">&quot;/NFS_PATH/{N; s?value:.*?value: <span class="token variable">$HARBOR_FOLDER</span>?}&quot;</span> <span class="token punctuation">\</span>
	-e <span class="token string">&quot;/server/s?:.*?: <span class="token variable">${SIP<span class="token operator">%</span><span class="token operator">/</span>*}</span>?&quot;</span> <span class="token punctuation">\</span>
	-e <span class="token string">&quot;/path/s?:.*?: <span class="token variable">$HARBOR_FOLDER</span>?&quot;</span> <span class="token punctuation">\</span>
	-e <span class="token string">'/containers/i\      nodeSelector:'</span> <span class="token punctuation">\</span>
	-e <span class="token string">&quot;/containers/i\        kubernetes.io/hostname: <span class="token variable">$NODE2</span>&quot;</span> /tmp/deployment.yaml <span class="token operator">|</span> kubectl apply -f-
<span class="token comment">#### 3/3 class.yaml</span>
<span class="token function">curl</span> <span class="token variable">$GIT_URL</span>/class.yaml -<span class="token comment"># -o /tmp/class.yaml</span>
<span class="token function">sed</span> <span class="token string">'/name:/s?:.*?: csi-hostpath-sc?'</span> /tmp/class.yaml <span class="token operator">|</span> kubectl apply -f-

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><blockquote><ol start="3"><li>安装</li></ol></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ helm <span class="token function">install</span> harbor-27 harbor/ <span class="token punctuation">\</span>
  --set expose.tls.enabled<span class="token operator">=</span>false <span class="token punctuation">\</span>
  --set expose.type<span class="token operator">=</span>nodePort <span class="token punctuation">\</span>
  --set persistence.persistentVolumeClaim.registry.storageClass<span class="token operator">=</span>csi-hostpath-sc <span class="token punctuation">\</span>
  --set persistence.persistentVolumeClaim.registry.existingClaim<span class="token operator">=</span>null <span class="token punctuation">\</span>
  --set persistence.persistentVolumeClaim.chartmuseum.storageClass<span class="token operator">=</span>csi-hostpath-sc <span class="token punctuation">\</span>
  --set persistence.persistentVolumeClaim.chartmuseum.existingClaim<span class="token operator">=</span>null <span class="token punctuation">\</span>
  --set persistence.persistentVolumeClaim.jobservice.jobLog.storageClass<span class="token operator">=</span>csi-hostpath-sc <span class="token punctuation">\</span>
  --set persistence.persistentVolumeClaim.jobservice.jobLog.existingClaim<span class="token operator">=</span>null <span class="token punctuation">\</span>
  --set persistence.persistentVolumeClaim.jobservice.scanDataExports.storageClass<span class="token operator">=</span>csi-hostpath-sc <span class="token punctuation">\</span>
  --set persistence.persistentVolumeClaim.jobservice.scanDataExports.existingClaim<span class="token operator">=</span>null <span class="token punctuation">\</span>
  --set persistence.persistentVolumeClaim.database.storageClass<span class="token operator">=</span>csi-hostpath-sc <span class="token punctuation">\</span>
  --set persistence.persistentVolumeClaim.database.existingClaim<span class="token operator">=</span>null <span class="token punctuation">\</span>
  --set persistence.persistentVolumeClaim.redis.storageClass<span class="token operator">=</span>csi-hostpath-sc <span class="token punctuation">\</span>
  --set persistence.persistentVolumeClaim.redis.existingClaim<span class="token operator">=</span>null <span class="token punctuation">\</span>
  --set persistence.persistentVolumeClaim.trivy.storageClass<span class="token operator">=</span>csi-hostpath-sc <span class="token punctuation">\</span>
  --set persistence.persistentVolumeClaim.trivy.existingClaim<span class="token operator">=</span>null

$ helm list
NAME	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART      	APP VERSION
HART        	APP VERSION
<span class="token variable"><span class="token variable">`</span>harbor-27<span class="token variable">`</span></span>	default  	<span class="token number">1</span>       	YYYY-MM-DD 09:38:24.809567068 +0000 UTC	deployed	harbor-1.11.0	<span class="token number">2.7</span>.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><blockquote><ol start="4"><li><p>测试</p> <p>http://k8s-master:30002/
PS：http明文时，提示帐号密码错误</p></li></ol></blockquote> <h1 id="_22-rbac权限控制"><a href="#_22-rbac权限控制" class="header-anchor">#</a> 22. RBAC权限控制</h1> <h2 id="_22-1-k8s授权概述"><a href="#_22-1-k8s授权概述" class="header-anchor">#</a> 22.1 k8s授权概述</h2> <h3 id="lab65-account"><a href="#lab65-account" class="header-anchor">#</a> Lab65. Account</h3> <blockquote><p>创建UserAccount</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> /etc/kubernetes/pki
$ <span class="token function">sudo</span> openssl genrsa -out tom.key
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> openssl rand -writerand /root/.rnd

$ <span class="token function">sudo</span> openssl req <span class="token punctuation">\</span>
-new <span class="token punctuation">\</span>
-key tom.key <span class="token punctuation">\</span>
-out tom.csr <span class="token punctuation">\</span>
-subj <span class="token string">&quot;/CN=tom/O=kubeusers&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> openssl x509 <span class="token punctuation">\</span>
-req <span class="token punctuation">\</span>
-in tom.csr <span class="token punctuation">\</span>
-CA ca.crt <span class="token punctuation">\</span>
-CAkey ca.key <span class="token punctuation">\</span>
-CAcreateserial <span class="token punctuation">\</span>
-out tom.crt <span class="token punctuation">\</span>
-days <span class="token number">365</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl config set-credentials tom <span class="token punctuation">\</span>
  --client-certificate<span class="token operator">=</span>tom.crt <span class="token punctuation">\</span>
  --client-key<span class="token operator">=</span>tom.key
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl config set-context tom@ck8s --cluster<span class="token operator">=</span>ck8s --user<span class="token operator">=</span>tom
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>切换身份</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">chmod</span> a+r tom.key

$ kubectl config use-context tom@ck8s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>测试</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pods
error: unable to <span class="token builtin class-name">read</span> client-key /etc/kubernetes/pki/tom.key <span class="token keyword">for</span> tom due to <span class="token function">open</span> /etc/kubernetes/pki/tom.key: permission denied

$ kubectl config use-context kubernetes-admin@ck8s
$ <span class="token builtin class-name">cd</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>创建ServiceAccount</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create namespace mynamespace

$ kubectl create serviceaccount example-sa -n mynamespace
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create deployment d1 --image<span class="token operator">=</span>nginx --replicas<span class="token operator">=</span><span class="token number">3</span>

$ kubectl get pods
NAME                  READY   STATUS              RESTARTS   AGE
d1-68d57c4c7f-lbxp8   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          6s
d1-68d57c4c7f-lphcz   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          6s
d1-68d57c4c7f-m4699   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          6s

$ kubectl get pods d1-68d57c4c7f-lbxp8 -o yaml <span class="token operator">|</span> <span class="token function">grep</span> serviceAccountName
  serviceAccountName: <span class="token variable"><span class="token variable">`</span>default<span class="token variable">`</span></span>
  
$ kubectl describe pods d1-68d57c4c7f-lbxp8
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n mynamespace get sa
NAME         SECRETS   AGE
<span class="token variable"><span class="token variable">`</span>default<span class="token variable">`</span></span>    <span class="token number">1</span>         11m
example-sa   <span class="token number">1</span>         10m

$ kubectl -n mynamespace describe sa default <span class="token operator">|</span> <span class="token function">grep</span> Tokens
Tokens:             <span class="token variable"><span class="token variable">`</span>default-token-djfrr<span class="token variable">`</span></span>

$ kubectl -n mynamespace get secrets
NAME                     TYPE                                  DATA   AGE
<span class="token variable"><span class="token variable">`</span>default-token-djfrr<span class="token variable">`</span></span>    kubernetes.io/service-account-token   <span class="token number">3</span>      12m
example-sa-token-qcdvj   kubernetes.io/service-account-token   <span class="token number">3</span>      12m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="_22-2-rbac插件简介"><a href="#_22-2-rbac插件简介" class="header-anchor">#</a> 22.2 RBAC插件简介</h2> <h3 id="lab66-rbac插件"><a href="#lab66-rbac插件" class="header-anchor">#</a> Lab66. RBAC插件</h3> <blockquote><p>RBAC中的对象-role</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create role example-role <span class="token punctuation">\</span>
  --verb<span class="token operator">=</span><span class="token string">&quot;get,watch,list&quot;</span> <span class="token punctuation">\</span>
  --resource<span class="token operator">=</span><span class="token string">&quot;pods&quot;</span> <span class="token punctuation">\</span>
  -n mynamespace
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>RBAC中的对象-ClusterRole</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create clusterrole example-clusterrole <span class="token punctuation">\</span>
  --verb<span class="token operator">=</span><span class="token string">&quot;get,watch,list&quot;</span> <span class="token punctuation">\</span>
  --resource<span class="token operator">=</span><span class="token string">&quot;pods&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>RBAC中的对象- RoleBinding</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create rolebinding example-rolebinding <span class="token punctuation">\</span>
  --role<span class="token operator">=</span>example-role <span class="token punctuation">\</span>
  --user<span class="token operator">=</span>user1
  -n mynamespace
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>RBAC中的对象- ClusterRoleBinding</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl create clusterrolebinding example-clusterrolebinding <span class="token punctuation">\</span>
  --clusterrole<span class="token operator">=</span>example-clusterrole <span class="token punctuation">\</span>
  --user<span class="token operator">=</span>user1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>内置ClusterRole和ClusterRolebinding</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get clusterroles
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl describe clusterrole cluster-admin
Name:         cluster-admin
Labels:       kubernetes.io/bootstrapping<span class="token operator">=</span>rbac-defaults
Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="token boolean">true</span>
PolicyRule:
  Resources  Non-Resource URLs  Resource Names  Verbs
  ---------  -----------------  --------------  -----
  *.*        <span class="token punctuation">[</span><span class="token punctuation">]</span>                 <span class="token punctuation">[</span><span class="token punctuation">]</span>              <span class="token punctuation">[</span>*<span class="token punctuation">]</span>
             <span class="token punctuation">[</span>*<span class="token punctuation">]</span>                <span class="token punctuation">[</span><span class="token punctuation">]</span>              <span class="token punctuation">[</span>*<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h1 id="_23-kubernetes日志管理方案"><a href="#_23-kubernetes日志管理方案" class="header-anchor">#</a> 23. Kubernetes日志管理方案</h1> <h2 id="_23-1-k8s日志管理"><a href="#_23-1-k8s日志管理" class="header-anchor">#</a> 23.1 k8s日志管理</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">cat</span> /var/log/pods/kube-system_kube-apiserver-k8s-master_cc2b4b37dd11e738628e66eb6e8039d6/kube-apiserver/0.log


$ <span class="token function">sudo</span> <span class="token function">apt</span> -y <span class="token function">install</span> jq

$ <span class="token function">sudo</span> <span class="token function">cat</span> /var/log/pods/kube-system_kube-apiserver-k8s-master_cc2b4b37dd11e738628e66eb6e8039d6/kube-apiserver/0.log <span class="token operator">|</span> jq
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_23-2-efk日志管理"><a href="#_23-2-efk日志管理" class="header-anchor">#</a> 23.2 EFK日志管理</h2> <h3 id="lab67-开始使用elastic-stack"><a href="#lab67-开始使用elastic-stack" class="header-anchor">#</a> Lab67. <a href="https://www.elastic.co/guide/en/elastic-stack-get-started/current/get-started-elastic-stack.html#get-started-elastic-stack" target="_blank" rel="noopener noreferrer">开始使用Elastic Stack<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <blockquote><p>0a. 安装 helm</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> https://baltocdn.com/helm/signing.asc <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> - <span class="token punctuation">\</span>
<span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> apt-transport-https --yes <span class="token punctuation">\</span>
<span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;deb https://baltocdn.com/helm/stable/debian/ all main&quot;</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/helm-stable-debian.list <span class="token punctuation">\</span>
<span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token punctuation">\</span>
<span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> helm

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>0b. 配置 elastic 仓库</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ helm repo <span class="token function">add</span> elastic https://helm.elastic.co <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> helm repo <span class="token function">add</span> fluent https://fluent.github.io/helm-charts <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> helm search repo
NAME                     	CHART VERSION	APP VERSION	DESCRIPTION
elastic/<span class="token variable"><span class="token variable">`</span>elasticsearch<span class="token variable">`</span></span>   <span class="token number">7.17</span>.3       	<span class="token number">7.17</span>.3     	Official Elastic helm chart <span class="token keyword">for</span> Elasticsearch
elastic/<span class="token variable"><span class="token variable">`</span>kibana<span class="token variable">`</span></span>          <span class="token number">7.17</span>.3       	<span class="token number">7.17</span>.3     	Official Elastic helm chart <span class="token keyword">for</span> Kibana
fluent/<span class="token variable"><span class="token variable">`</span>fluent-bit<span class="token variable">`</span></span>      	<span class="token number">0.20</span>.1       	<span class="token number">1.9</span>.3      	Fast and lightweight log processor and forwarde<span class="token punctuation">..</span>.
fluent/fluentd           	<span class="token number">0.3</span>.7        	v1.12.4    	A Helm chart <span class="token keyword">for</span> Kubernetes
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><ol><li>安装 Elasticsearch
分布式 RESTful 搜索和分析引擎</li></ol></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ helm inspect values elastic/elasticsearch <span class="token operator">|</span> <span class="token function">less</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
replicas: <span class="token variable"><span class="token variable">`</span><span class="token number">3</span><span class="token variable">`</span></span>
minimumMasterNodes: <span class="token variable"><span class="token variable">`</span><span class="token number">2</span><span class="token variable">`</span></span>
<span class="token punctuation">..</span>.
resources:
  requests:
    cpu: <span class="token string">&quot;1000m&quot;</span>
    memory: <span class="token string">&quot;2Gi&quot;</span>
  limits:
    cpu: <span class="token string">&quot;1000m&quot;</span>
    memory: <span class="token string">&quot;2Gi&quot;</span>
<span class="token punctuation">..</span>.
volumeClaimTemplate:
  accessModes: <span class="token variable"><span class="token variable">`</span><span class="token punctuation">[</span><span class="token string">&quot;ReadWriteOnce&quot;</span><span class="token punctuation">]</span><span class="token variable">`</span></span>
  resources:
    requests:
      storage: <span class="token variable"><span class="token variable">`</span>30Gi<span class="token variable">`</span></span>
<span class="token punctuation">..</span>.
persistence:
  enabled: <span class="token variable"><span class="token variable">`</span><span class="token boolean">true</span><span class="token variable">`</span></span>
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>[root@192.168.147.128]</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">apt</span> -y <span class="token function">install</span> nfs-kernel-server <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">sudo</span> <span class="token function">mkdir</span> -m <span class="token number">777</span> /nfs_log<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1</span><span class="token punctuation">}</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">sudo</span> <span class="token function">tee</span> /etc/exports <span class="token operator">&lt;&lt;</span><span class="token string">EOF
/nfs_log0 *(rw,no_root_squash)
/nfs_log1 *(rw,no_root_squash)
EOF</span>

<span class="token function">sudo</span> systemctl restart nfs-server <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
showmount -e

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f<span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv<span class="token punctuation">-</span>log0
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 30Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Recycle
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /nfs_log0
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.147.128
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv<span class="token punctuation">-</span>log1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 30Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Recycle
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /nfs_log1
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.147.128
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ helm <span class="token function">install</span> elasticsearch elastic/elasticsearch <span class="token punctuation">\</span>
  --set <span class="token assign-left variable">replicas</span><span class="token operator">=</span><span class="token number">2</span>,minimumMasterNodes<span class="token operator">=</span><span class="token number">1</span>,image<span class="token operator">=</span><span class="token string">&quot;registry.cn-hangzhou.aliyuncs.com/k-cka/elasticsearch&quot;</span>
:<span class="token operator">&lt;&lt;</span><span class="token string">EOF
...此处省略...
NOTES:
1. Watch all cluster members come up.
  $ kubectl get pods --namespace=default -l app=elasticsearch-master -w
2. Test cluster health using Helm test.
  $ helm --namespace=default test elasticsearch
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pods --namespace<span class="token operator">=</span>default -l <span class="token assign-left variable">app</span><span class="token operator">=</span>elasticsearch-master -w
NAME                     READY   STATUS     RESTARTS   AGE
<span class="token punctuation">..</span>.
elasticsearch-master-1  <span class="token variable"><span class="token variable">`</span><span class="token number">1</span>/1<span class="token variable">`</span></span>    Running           <span class="token number">0</span>          5m33s
elasticsearch-master-0  <span class="token variable"><span class="token variable">`</span><span class="token number">1</span>/1<span class="token variable">`</span></span>    Running           <span class="token number">0</span>          5m33s
<span class="token operator">&lt;</span>Ctrl-C<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ helm --namespace<span class="token operator">=</span>default <span class="token builtin class-name">test</span> elasticsearch
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
Phase:         <span class="token variable"><span class="token variable">`</span>Succeeded<span class="token variable">`</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><ol start="2"><li>fluent-bit
快速轻量级日志处理器和转发器</li></ol></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ helm <span class="token function">install</span> fluent-bit fluent/fluent-bit
:<span class="token operator">&lt;&lt;</span><span class="token string">EOF
...输出省略...
export POD_NAME=<span class="token variable"><span class="token variable">$(</span>kubectl get pods --namespace default -l <span class="token string">&quot;app.kubernetes.io/name=fluent-bit,app.kubernetes.io/instance=fluent-bit&quot;</span> -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&quot;{.items[0].metadata.name}&quot;</span><span class="token variable">)</span></span>
kubectl --namespace default port-forward <span class="token variable">$POD_NAME</span> 2020:2020
curl http://127.0.0.1:2020
EOF</span>


$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">POD_NAME</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pods --namespace default -l <span class="token string">&quot;app.kubernetes.io/name=fluent-bit,app.kubernetes.io/instance=fluent-bit&quot;</span> -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&quot;{.items[0].metadata.name}&quot;</span><span class="token variable">)</span></span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token builtin class-name">echo</span> <span class="token variable">$POD_NAME</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
kubectl get pods <span class="token variable">$POD_NAME</span> -w
NAME               READY   STATUS              RESTARTS   AGE
<span class="token punctuation">..</span>.
fluent-bit-4dg4h  <span class="token variable"><span class="token variable">`</span><span class="token number">1</span>/1<span class="token variable">`</span></span>    Running             <span class="token number">0</span>          2m26s
<span class="token operator">&lt;</span>Ctrl-C<span class="token operator">&gt;</span>

$ kubectl --namespace default port-forward <span class="token variable">$POD_NAME</span> <span class="token number">2020</span>:2020

$ <span class="token function">curl</span> http://127.0.0.1:2020 <span class="token operator">|</span> jq

$ kubectl edit configmap fluent-bit
Edit cancelled, no changes made.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><blockquote><ol start="3"><li>安装 Kibana
用于 Elasticsearch 的基于浏览器的分析和搜索仪表板</li></ol></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ helm inspect values elastic/kibana <span class="token operator">|</span> <span class="token function">less</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
resources:
  requests:
    cpu: <span class="token string">&quot;1000m&quot;</span>
    memory: <span class="token string">&quot;2Gi&quot;</span>
  limits:
    cpu: <span class="token string">&quot;1000m&quot;</span>
    memory: <span class="token string">&quot;2Gi&quot;</span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.  
service:
  type: <span class="token variable"><span class="token variable">`</span>ClusterIP<span class="token variable">`</span></span>
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.  
image: <span class="token string">&quot;docker.elastic.co/kibana/kibana&quot;</span>

* master 节点参与 POD 负载,默认不参与
$ kubectl taint nodes k8s-master node-role.kubernetes.io/master-
node/k8s-master untainted

$ helm <span class="token function">install</span> kibana elastic/kibana <span class="token punctuation">\</span>
  --set service.type<span class="token operator">=</span>NodePort,image<span class="token operator">=</span><span class="token string">&quot;registry.cn-hangzhou.aliyuncs.com/k-cka/kibana&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod -l <span class="token assign-left variable">app</span><span class="token operator">=</span>kibana -w
NAME                             READY   STATUS    RESTARTS   AGE
<span class="token punctuation">..</span>.
kibana-kibana-85d5f98b79-z24p5  <span class="token variable"><span class="token variable">`</span><span class="token number">1</span>/1<span class="token variable">`</span></span>    Running             <span class="token number">0</span>          10m
<span class="token operator">&lt;</span>Ctrl-C<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><ol start="4"><li>配置Kibana</li></ol></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl get svc kibana-kibana
NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
kibana-kibana   NodePort   <span class="token number">10.99</span>.144.226   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">5601</span>:<span class="token variable"><span class="token variable">`</span><span class="token number">31702</span><span class="token variable">`</span></span>/TCP   7m50s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>物理机浏览器 http://k8s-master:31702</p> <ul><li><p>点击<kbd>Exlore on my own</kbd></p></li> <li><p>点击<kbd>Stack Management</kbd></p></li></ul> <p>==Open side navigation== / <strong>Kibana</strong> / <kbd>Index Patterns</kbd></p> <ul><li><p>点击<kbd>Create index pattern</kbd></p></li> <li><p>Name：==log*==, Tmestamp field ==@timestamp==, <kbd>Create index pattern</kbd></p> <p>/  <strong>Analytics</strong>/ <kbd>Discover</kbd></p></li></ul> <blockquote><ol start="6"><li>创建测试容器</li></ol></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl run busybox <span class="token punctuation">\</span>
  --image<span class="token operator">=</span>busybox <span class="token punctuation">\</span>
  --image-pull-policy<span class="token operator">=</span>IfNotPresent <span class="token punctuation">\</span>
  -- <span class="token function">sh</span> -c <span class="token string">'while true; do echo &quot;This is a log message from container busybox!&quot;; sleep 5; done;'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
  kubectl get pod busybox -w
NAME      READY   STATUS              RESTARTS   AGE
<span class="token punctuation">..</span>.
busybox  <span class="token variable"><span class="token variable">`</span><span class="token number">1</span>/1<span class="token variable">`</span></span>    Running             <span class="token number">0</span>          29s
<span class="token operator">&lt;</span>Ctrl-C<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><ol start="7"><li>查看日志（稍等片刻）</li></ol></blockquote> <h1 id="_24-kubernetes监控方案"><a href="#_24-kubernetes监控方案" class="header-anchor">#</a> 24. Kubernetes监控方案</h1> <h2 id="_24-1-k8s常用监控方案"><a href="#_24-1-k8s常用监控方案" class="header-anchor">#</a> 24.1 k8s常用监控方案</h2> <h2 id="_24-2-prometheus概述"><a href="#_24-2-prometheus概述" class="header-anchor">#</a> 24.2 Prometheus概述</h2> <h3 id="lab68-kube-prometheus"><a href="#lab68-kube-prometheus" class="header-anchor">#</a> Lab68. <a href="https://github.com/prometheus-operator/kube-prometheus" target="_blank" rel="noopener noreferrer">Kube-prometheus<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <h4 id="_1-安装"><a href="#_1-安装" class="header-anchor">#</a> 1. 安装<img height="30" src="https://avatars.githubusercontent.com/u/66682517?s=200&amp;v=4"></h4> <p>https://github.com/prometheus-operator</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">apt</span> -y <span class="token function">install</span> <span class="token function">git</span>
$ <span class="token function">git</span> clone https://github.com/prometheus-operator/kube-prometheus.git
Cloning into <span class="token string">'kube-prometheus'</span><span class="token punctuation">..</span>.
remote: Enumerating objects: <span class="token number">16183</span>, done.
remote: Counting objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">104</span>/104<span class="token punctuation">)</span>, done.
remote: Compressing objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">60</span>/60<span class="token punctuation">)</span>, done.
remote: Total <span class="token number">16183</span> <span class="token punctuation">(</span>delta <span class="token number">57</span><span class="token punctuation">)</span>, reused <span class="token number">78</span> <span class="token punctuation">(</span>delta <span class="token number">39</span><span class="token punctuation">)</span>, pack-reused <span class="token number">16079</span>
Receiving objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">16183</span>/16183<span class="token punctuation">)</span>, <span class="token number">8.08</span> MiB <span class="token operator">|</span> <span class="token number">28.00</span> KiB/s, done.
Resolving deltas: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">10397</span>/10397<span class="token punctuation">)</span>, done.

$ <span class="token builtin class-name">cd</span> kube-prometheus
$ <span class="token function">git</span> checkout release-0.10

$ kubectl apply -f manifests/setup
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
namespace/monitoring created
The CustomResourceDefinition <span class="token string">&quot;prometheuses.monitoring.coreos.com&quot;</span> is <span class="token variable"><span class="token variable">`</span>invalid<span class="token variable">`</span></span><span class="token builtin class-name">:</span> metadata.annotations: Too long: must have at <span class="token function">most</span> <span class="token number">262144</span> bytes

$ kubectl create -f manifests/setup/prometheusCustomResourceDefinition.yaml

$ kubectl apply -f manifests
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><blockquote><p>国内有些镜像拉不下来，需要单独处理</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n monitoring get pods <span class="token operator">|</span> <span class="token function">grep</span> -v Running
NAME                                   READY   STATUS             RESTARTS         AGE
<span class="token variable"><span class="token variable">`</span>blackbox-exporter-6b79c4588b-m9255<span class="token variable">`</span></span>   <span class="token number">1</span>/3     ImagePullBackOff   <span class="token number">5</span> <span class="token punctuation">(</span>28s ago<span class="token punctuation">)</span>      11m
<span class="token variable"><span class="token variable">`</span>kube-state-metrics-55f67795cd-7644m<span class="token variable">`</span></span>  <span class="token number">0</span>/3     CrashLoopBackOff   <span class="token number">12</span> <span class="token punctuation">(</span>2m51s ago<span class="token punctuation">)</span>   11m
<span class="token variable"><span class="token variable">`</span>prometheus-adapter-85664b6b74-7vn4b<span class="token variable">`</span></span>  <span class="token number">0</span>/1     CrashLoopBackOff   <span class="token number">7</span> <span class="token punctuation">(</span>26s ago<span class="token punctuation">)</span>      11m
<span class="token variable"><span class="token variable">`</span>prometheus-operator-6dc9f66cb7-2qbf6<span class="token variable">`</span></span> <span class="token number">0</span>/2     CrashLoopBackOff   <span class="token number">12</span> <span class="token punctuation">(</span>102s ago<span class="token punctuation">)</span>    11m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>blackbox-exporter:v0.19.0</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n monitoring describe pod blackbox-exporter-6b79c4588b-m9255
  Normal   Pulling    8m51s <span class="token punctuation">(</span>x2 over 12m<span class="token punctuation">)</span>    kubelet            Pulling image <span class="token string">&quot;quay.io/prometheus/blackbox-exporter:v0.19.0&quot;</span>
  
$ <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-master k8s-worker1 k8s-worker2<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">ssh</span> <span class="token variable">$i</span> <span class="token string">&quot;
    sudo docker pull registry.cn-hangzhou.aliyuncs.com/k-cka/blackbox-exporter:v0.19.0
    sudo docker tag registry.cn-hangzhou.aliyuncs.com/k-cka/blackbox-exporter:v0.19.0 quay.io/prometheus/blackbox-exporter:v0.19.0
&quot;</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>kube-state-metrics:v2.3.0</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n monitoring describe pod kube-state-metrics-55f67795cd-7644m
  Normal   BackOff    39s <span class="token punctuation">(</span>x101 over 18m<span class="token punctuation">)</span>  kubelet            Back-off pulling image <span class="token string">&quot;k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.3.0&quot;</span>
  
$ <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-master k8s-worker1 k8s-worker2<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">ssh</span> <span class="token variable">$i</span> <span class="token string">&quot;
    sudo docker pull registry.cn-hangzhou.aliyuncs.com/k-cka/kube-state-metrics:v2.3.0
    sudo docker tag registry.cn-hangzhou.aliyuncs.com/k-cka/kube-state-metrics:v2.3.0 k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.3.0
&quot;</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>prometheus-adapter:v0.9.1</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n monitoring describe pod prometheus-adapter-85664b6b74-7vn4b
  Normal   Pulled     21m <span class="token punctuation">(</span>x5 over 23m<span class="token punctuation">)</span>     kubelet            Container image <span class="token string">&quot;k8s.gcr.io/prometheus-adapter/prometheus-adapter:v0.9.1&quot;</span> already present on machine
  
$ <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-master k8s-worker1 k8s-worker2<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">ssh</span> <span class="token variable">$i</span> <span class="token string">&quot;
    sudo docker pull registry.cn-hangzhou.aliyuncs.com/k-cka/prometheus-adapter:v0.9.1
   sudo docker tag registry.cn-hangzhou.aliyuncs.com/k-cka/prometheus-adapter:v0.9.1 k8s.gcr.io/prometheus-adapter/prometheus-adapter:v0.9.1
&quot;</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>prometheus-operator:v0.53.1</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n monitoring describe pod prometheus-operator-6dc9f66cb7-2qbf6
  Normal   Pulled     20m <span class="token punctuation">(</span>x2 over 21m<span class="token punctuation">)</span>     kubelet            Container image <span class="token string">&quot;quay.io/prometheus-operator/prometheus-operator:v0.53.1&quot;</span> already present on machine
  
$ <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-master k8s-worker1 k8s-worker2<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">ssh</span> <span class="token variable">$i</span> <span class="token string">&quot;
    sudo docker pull registry.cn-hangzhou.aliyuncs.com/k-cka/prometheus-operator:v0.53.1
    sudo docker tag registry.cn-hangzhou.aliyuncs.com/k-cka/prometheus-operator:v0.53.1 quay.io/prometheus-operator/prometheus-operator:v0.53.1
&quot;</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n monitoring  get pods
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl -n monitoring patch svc grafana -p <span class="token string">'{&quot;spec&quot;:{&quot;type&quot;:&quot;NodePort&quot;}}'</span> 
$ kubectl -n monitoring patch svc prometheus-k8s -p <span class="token string">'{&quot;spec&quot;:{&quot;type&quot;:&quot;NodePort&quot;}}'</span> 

$ kubectl -n monitoring get svc <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token string">'grafana|prometheus-k8s'</span>
grafana         NodePort  <span class="token number">10.104</span>.141.103  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>  <span class="token number">3000</span>:<span class="token variable"><span class="token variable">`</span><span class="token number">30214</span><span class="token variable">`</span></span>/TCP                 13m
prometheus-k8s  NodePort  <span class="token number">10.96</span>.106.1     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>  <span class="token number">9090</span>:<span class="token variable"><span class="token variable">`</span><span class="token number">31721</span><span class="token variable">`</span></span>/TCP,8080:32201/TCP  13m

$ kubectl -n monitoring get pod -owide <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token string">'grafana|prometheus-k8s'</span>
grafana-7fd69887fb-r6f4x  <span class="token number">1</span>/1  Running  <span class="token number">0</span>  13m  <span class="token number">172.16</span>.126.1     <span class="token variable"><span class="token variable">`</span>k8s-worker2<span class="token variable">`</span></span>  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
prometheus-k8s-0					<span class="token number">2</span>/2  Running  <span class="token number">0</span>  17m  <span class="token number">172.16</span>.194.70    <span class="token variable"><span class="token variable">`</span>k8s-worker1<span class="token variable">`</span></span>  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
prometheus-k8s-1					<span class="token number">2</span>/2  Running  <span class="token number">0</span>  17m  <span class="token number">172.16</span>.126.5     <span class="token variable"><span class="token variable">`</span>k8s-worker2<span class="token variable">`</span></span>  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_2-配置prometheus"><a href="#_2-配置prometheus" class="header-anchor">#</a> 2. 配置prometheus</h4> <ul><li><p>物理机 http://k8s-worker1:31721</p></li> <li><p>点击菜单 <kbd>Status</kbd> / <kbd>Targets</kbd> ，确认所有的 State 都是 ==UP==（能够正常获取监控数据）</p></li></ul> <h4 id="_3-配置grafana"><a href="#_3-配置grafana" class="header-anchor">#</a> 3. 配置grafana</h4> <ul><li>物理机http://k8s-worker2:30214</li></ul> <blockquote><p>Email or username ==admin==
Password ==admin==</p></blockquote> <h4 id="_4-配置数据源"><a href="#_4-配置数据源" class="header-anchor">#</a> 4. 配置数据源</h4> <blockquote><p>默认安装已经配置好了数据源</p></blockquote> <h4 id="_5-添加dashboard模版"><a href="#_5-添加dashboard模版" class="header-anchor">#</a> 5. 添加Dashboard模版</h4> <blockquote><p>https://grafana.com/grafana/dashboards</p></blockquote> <p><kbd>Filter</kbd>，Category: ==Docker==， Data Source：==Prometheus==</p> <ul><li><p>点击 ==1 Node Exporter for Prometheus Dashboard EN v20201010==</p></li> <li><p><kbd>Copy ID to Clipboard</kbd></p></li> <li><p>物理机 http://k8s-worker2:30214
<kbd>Create</kbd> / <kbd>Import</kbd></p></li> <li><p>Import via grafana.com ==11074==，<kbd>Load</kbd></p></li> <li><p>VictoriaMetrics 下拉菜单中选择 ==Prometheus==，<kbd>Import</kbd></p></li></ul> <h1 id="附录"><a href="#附录" class="header-anchor">#</a> 附录</h1> <h2 id="a1-学习方法"><a href="#a1-学习方法" class="header-anchor">#</a> A1. 学习方法</h2> <table><thead><tr><th style="text-align:center;">step</th> <th style="text-align:center;"></th> <th></th> <th>示例</th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td style="text-align:center;">word</td> <td>查单词，释义</td> <td>pull, 拉</td></tr> <tr><td style="text-align:center;">2</td> <td style="text-align:center;"><kbd>Tab</kbd></td> <td>一下补全，两下列出</td> <td># doc<kbd>Tab</kbd><br># docker <kbd>Tab</kbd>, <kbd>Tab</kbd><kbd>Tab</kbd></td></tr> <tr><td style="text-align:center;">3</td> <td style="text-align:center;">man, --help</td> <td>帮助</td> <td># man docker<br># docker --help</td></tr> <tr><td style="text-align:center;">4</td> <td style="text-align:center;">echo $?</td> <td>查看回显</td> <td>0 == 正确执行<br>非0 == 错误执行</td></tr></tbody></table> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># docker --help</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># man docker run</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><table><thead><tr><th style="text-align:center;">ID</th> <th style="text-align:center;"></th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td style="text-align:center;"><kbd>f</kbd></td> <td style="text-align:center;">For.. 前进</td></tr> <tr><td style="text-align:center;">2</td> <td style="text-align:center;"><kbd>b</kbd></td> <td style="text-align:center;">Back 后退</td></tr> <tr><td style="text-align:center;">3</td> <td style="text-align:center;">/-d</td> <td style="text-align:center;">搜索==-d==</td></tr> <tr><td style="text-align:center;">4</td> <td style="text-align:center;"><kbd>n</kbd> | <kbd>N</kbd></td> <td style="text-align:center;">Next 下一个 | 上一个</td></tr> <tr><td style="text-align:center;">5</td> <td style="text-align:center;"><kbd>q</kbd></td> <td style="text-align:center;">Quit 退出</td></tr></tbody></table> <h2 id="a2-培训相关软件"><a href="#a2-培训相关软件" class="header-anchor">#</a> A2. 培训相关软件</h2> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">NAME</th> <th style="text-align:center;">URL</th> <th style="text-align:center;">FUNC</th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td style="text-align:center;">欧路词典</td> <td style="text-align:center;">www.eudic.net</td> <td style="text-align:center;">翻译软件</td></tr> <tr><td style="text-align:center;">2</td> <td style="text-align:center;">Typora</td> <td style="text-align:center;">https://typoraio.cn</td> <td style="text-align:center;">MarkDown 格式文档</td></tr> <tr><td style="text-align:center;">3</td> <td style="text-align:center;">VMware</td> <td style="text-align:center;">https://www.vmware.com/cn</td> <td style="text-align:center;">虚拟化软件</td></tr> <tr><td style="text-align:center;">4</td> <td style="text-align:center;"><a href="https://mirrors.dgut.edu.cn/ubuntu-releases/20.04.4/ubuntu-20.04.4-desktop-amd64.iso" target="_blank" rel="noopener noreferrer">Ubuntu<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">https://ubuntu.com</td> <td style="text-align:center;">系统光盘 iso</td></tr></tbody></table> <h2 id="a3-terminal-shortcut"><a href="#a3-terminal-shortcut" class="header-anchor">#</a> A3. terminal-shortcut</h2> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;"></th> <th></th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td style="text-align:center;"><kbd>Ctrl</kbd>-<kbd>+</kbd> | <kbd>Ctrl</kbd>-<kbd>Shift</kbd>-<kbd>=</kbd></td> <td>放大字体</td></tr> <tr><td style="text-align:center;">2</td> <td style="text-align:center;"><kbd>Ctrl</kbd>-<kbd>Shift</kbd>-<kbd>T</kbd></td> <td>新建标签</td></tr> <tr><td style="text-align:center;">3</td> <td style="text-align:center;"><kbd>Alt</kbd>-<kbd>1</kbd> | <kbd>Alt</kbd>-<kbd>2</kbd></td> <td>终端1、2之间切换</td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;"></td> <td></td></tr></tbody></table> <h2 id="a4-vim"><a href="#a4-vim" class="header-anchor">#</a> A4. vim</h2> <table><thead><tr><th style="text-align:center;">mode</th> <th style="text-align:center;"></th> <th></th> <th>状态栏</th> <th></th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td style="text-align:center;"><strong>命令模式</strong></td> <td><kbd>i</kbd></td> <td></td> <td>默认工作模式</td></tr> <tr><td style="text-align:center;">2</td> <td style="text-align:center;">输入模式</td> <td><kbd>Esc</kbd></td> <td>-- INSERT --</td> <td>退出输入模式</td></tr> <tr><td style="text-align:center;">3</td> <td style="text-align:center;">末行模式</td> <td>:wq!</td> <td></td> <td>write quit 保存退出</td></tr></tbody></table> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>使用命令，未安装提示安装方法
$ <span class="token function">vim</span>

Command <span class="token string">'vim'</span> not found, but can be installed with:

<span class="token variable"><span class="token variable">`</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">vim</span><span class="token variable">`</span></span>       <span class="token comment"># version 2:8.1.2269-1ubuntu5.7, or</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> vim-tiny    <span class="token comment"># version 2:8.1.2269-1ubuntu5.7</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> neovim      <span class="token comment"># version 0.4.3-3</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> vim-athena  <span class="token comment"># version 2:8.1.2269-1ubuntu5.7</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> vim-gtk3    <span class="token comment"># version 2:8.1.2269-1ubuntu5.7</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> vim-nox     <span class="token comment"># version 2:8.1.2269-1ubuntu5.7</span>

按照提示安装
$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">vim</span>
<span class="token punctuation">[</span>sudo<span class="token punctuation">]</span> password <span class="token keyword">for</span> kiosk: <span class="token variable"><span class="token variable">`</span>ubuntu<span class="token variable">`</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">vim</span> my.txt
<span class="token operator">&lt;</span>i<span class="token operator">&gt;</span>
ni hao
<span class="token operator">&lt;</span>Esc<span class="token operator">&gt;</span>
:wq<span class="token operator">!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>~/.vimrc</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">set</span> number cuc
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>/word</p> <p><kbd>n</kbd>/ <kbd>N</kbd></p> <p><kbd>r</kbd>數字</p> <p><kbd>shift</kbd><kbd>z</kbd><kbd>z</kbd></p></blockquote> <h2 id="a5-ssh-server"><a href="#a5-ssh-server" class="header-anchor">#</a> A5. ssh-server</h2> <p><strong>[Server/虚拟机]</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>通过关键字，查找安装包名称
$ <span class="token function">apt</span> search <span class="token function">ssh</span> <span class="token operator">|</span> <span class="token function">grep</span> server

安装
$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openssh-server

确认服务器地址
$ <span class="token function">ip</span> a <span class="token operator">|</span> <span class="token function">grep</span> -w inet
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
    inet <span class="token variable"><span class="token variable">`</span><span class="token number">192.168</span>.73.137/24<span class="token variable">`</span></span> brd <span class="token number">192.168</span>.73.255 scope global dynamic noprefixroute ens33
    inet <span class="token number">172.17</span>.0.1/16 brd <span class="token number">172.17</span>.255.255 scope global docker0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>[Client/物理机]</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>% <span class="token function">ssh</span> kiosk@192.168.73.137
kiosk@192.168.73.137<span class="token punctuation">\</span>'s password: <span class="token variable"><span class="token variable">`</span>ubuntu<span class="token variable">`</span></span>
$ 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="a6-搭建培训环境"><a href="#a6-搭建培训环境" class="header-anchor">#</a> A6. 搭建培训环境</h2> <blockquote><p>手册：https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</p> <p>机器：</p> <div class="language- extra-class"><pre><code>  **虚拟机/VMware*3**

  物理机*3，公司

  云主机*3（阿里云、腾讯云、华为云）
</code></pre></div></blockquote> <blockquote><ul><li>centos
<ul><li>selinux</li> <li>firewalld</li> <li>NTP</li> <li>Kernel</li></ul></li></ul></blockquote> <h2 id="a7-培训环境转成练习环境"><a href="#a7-培训环境转成练习环境" class="header-anchor">#</a> A7. 培训环境转成练习环境</h2> <blockquote><p>接近考试环境，可以做练习题</p></blockquote> <table><thead><tr><th style="text-align:center;">ID</th> <th>k8s-master</th> <th>COMMENT</th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td>Insert CDROM==*.ISO==, 连接光驱</td> <td>使用光盘镜像</td></tr> <tr><td style="text-align:center;">2</td> <td>$ ==sudo mount -o uid=1000 /dev/sr0 /media/==</td> <td>挂载光驱</td></tr> <tr><td style="text-align:center;">3</td> <td>$ ==/media/cka-setup==</td> <td>切换到练习环境</td></tr></tbody></table> <ul><li>确认环境正常</li></ul> <blockquote><p>所有的 pod 全 Running</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ k get pods -A <span class="token operator">|</span> <span class="token function">grep</span> -v Running
NAMESPACE      NAME  READY   STATUS    RESTARTS       AGE
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>练习环境中，判分脚本</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ cka-grade
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="a8-apt"><a href="#a8-apt" class="header-anchor">#</a> A8. apt</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">ip</span> a

$ <span class="token function">ip</span> route

$ <span class="token function">sudo</span> <span class="token function">apt</span> search apt-file
$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> apt-file -y

$ <span class="token function">sudo</span> apt-file update
$ apt-file search bin/ping

$ <span class="token function">apt</span> show inetutils-ping
$ <span class="token function">apt</span> show iputils-ping

$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y inetutils-ping
$ <span class="token function">ping</span> <span class="token number">8.8</span>.8.8

$ apt-file search bin/host
$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y bind9-host
$ <span class="token function">host</span> www.163.com
$ <span class="token function">host</span> www.163.com <span class="token number">8.8</span>.8.8
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="a9-虚拟机"><a href="#a9-虚拟机" class="header-anchor">#</a> A9. 虚拟机</h2> <blockquote><p>快照</p></blockquote> <table><thead><tr><th style="text-align:center;">ID</th> <th>ITEM</th> <th></th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td>Hyper-V</td> <td>Windows 自带</td></tr> <tr><td style="text-align:center;">2</td> <td>KVM</td> <td>Linux 自带</td></tr> <tr><td style="text-align:center;">3</td> <td>==VMware==</td> <td>跨平台，player免费</td></tr> <tr><td style="text-align:center;">4</td> <td>Virtual-box</td> <td>跨平台，免费</td></tr></tbody></table> <h2 id="a10-云主机"><a href="#a10-云主机" class="header-anchor">#</a> A10. 云主机</h2> <blockquote><ul><li>阿里</li> <li>华为</li> <li>amazon</li> <li>Azure</li></ul></blockquote> <h2 id="a11-vmnet8"><a href="#a11-vmnet8" class="header-anchor">#</a> A11. VMnet8</h2> <blockquote><p>macOS系统 - VMware fusion</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>% <span class="token function">sudo</span> <span class="token function">vim</span> /Library/Preferences/VMware<span class="token punctuation">\</span> Fusion/networking
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-ini line-numbers-mode"><pre class="language-ini"><code>...
answer VNET_8_HOSTONLY_SUBNET 192.168.147.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>VMware关闭，重开生效</p> <h2 id="a12-vmware-网络"><a href="#a12-vmware-网络" class="header-anchor">#</a> A12. VMware 网络</h2> <blockquote><p>配置没问题还无法连网，建议重装 VMware</p></blockquote> <table><thead><tr><th style="text-align:center;">ID</th> <th style="text-align:center;">TYPE</th> <th style="text-align:center;">物理机</th> <th style="text-align:center;">虚拟机</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>1</code></td> <td style="text-align:center;">==nat==</td> <td style="text-align:center;">vmnet8<br>192.168.147.1</td> <td style="text-align:center;">ens33<br>192.168.147.130</td></tr> <tr><td style="text-align:center;"><code>2</code></td> <td style="text-align:center;">bridge</td> <td style="text-align:center;">物理网卡</td> <td style="text-align:center;">ens33</td></tr> <tr><td style="text-align:center;">3</td> <td style="text-align:center;">host-only</td> <td style="text-align:center;">vmnet1<br>172.25.</td> <td style="text-align:center;">ens33<br>172.25</td></tr></tbody></table> <h2 id="a13-国外的镜像如何访问"><a href="#a13-国外的镜像如何访问" class="header-anchor">#</a> A13. 国外的镜像如何访问</h2> <blockquote><ol><li><p>日本服务器</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># docker pull ...</span>
<span class="token comment"># docker save ...</span>
<span class="token comment"># scp ... my@china:</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># docker load ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol></blockquote> <blockquote><ol start="2"><li><p>阿里云海外构建</p> <p>github.com / ==Dockerfile==</p> <p>阿里云镜像，新建镜像，使用海外构建</p> <p>镜像生成在阿里云的镜像仓库里</p></li></ol></blockquote> <h2 id="a14-ifconfig-ip"><a href="#a14-ifconfig-ip" class="header-anchor">#</a> A14. ifconfig, ip</h2> <table><thead><tr><th style="text-align:center;">ID</th> <th style="text-align:center;">systemd</th> <th style="text-align:center;">net-tools</th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td style="text-align:center;">ip a</td> <td style="text-align:center;">ifconfig</td></tr> <tr><td style="text-align:center;">2</td> <td style="text-align:center;">ss</td> <td style="text-align:center;">netstat</td></tr> <tr><td style="text-align:center;">3</td> <td style="text-align:center;">ip route</td> <td style="text-align:center;">route</td></tr></tbody></table> <h2 id="a15-explain"><a href="#a15-explain" class="header-anchor">#</a> A15. explain</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kubectl explain deploy d1

$ kubectl edit deploy d1

$ kubectl get deploy d2 -o yaml <span class="token operator">&gt;</span> d2.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="a16-更新集群证书"><a href="#a16-更新集群证书" class="header-anchor">#</a> A16. <a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/" target="_blank" rel="noopener noreferrer">更新集群证书<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <ul><li><p><strong>特性状态：</strong> <code>Kubernetes v1.15 [stable]</code></p></li> <li><p>默认情况下，由 kubeadm 为集群生成的所有证书在 <code>1</code>年后到期</p></li> <li><p>更新（重新签发）集群证书需根据其部署方式而定</p> <ul><li>通过二进制部署的集群需手动更新集群证书</li> <li>通过 kubeadm 部署的集群可使用 kubeadm 更新证书，也可重新编译 kubeadm 生成自定义有效期的证书</li></ul></li> <li><p>集群证书更新方式，步骤如下：</p> <ul><li><p>检查集群证书有效期（通常于 <code>master</code> 节点执行）：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> kubeadm certs check-expiration

单独查看证书是否过期
$ openssl x509 -noout -in /etc/kubernetes/pki/apiserver.crt -dates
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>集群 master 节点上的 <code>/etc/kubernetes/pki/*</code> 的证书在更新之前，应继续保留在节点上不可删除，删除后将导致集群异常无法恢复</p></li> <li><p>kubeadm 更新集群 master 节点上的证书，
而 worker 节点上 <code>kubelet</code> 证书默认自动轮换更新，无需关心证书到期题。
<code>kube-apiserver</code> 访问 kubelet 时，并不校验 kubelet 服务端证书，kubeadm 也并不提供更新 kubelet 服务端证书的办法</p></li> <li><p>更新延期集群证书 1 年有效期：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>根据集群部署时使用的 kubeadm-conf.yml 配置文件更新所有集群证书
$ <span class="token function">sudo</span> kubeadm certs renew all <span class="token punctuation">\</span>
  --config /home/kiosk/kubeadm-config.yaml
<span class="token punctuation">..</span>.输出省略<span class="token punctuation">..</span>.
Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>查看更新后的所有集群证书
$ <span class="token function">sudo</span> <span class="token function">apt</span> -y <span class="token function">install</span> tree <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> tree -D /etc/kubernetes/pki
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>更新集群证书后，需更新集群 <code>kubeconfig</code> 配置文件：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>备份集群原始配置文件 kubeconfig
$ <span class="token function">sudo</span> <span class="token function">mv</span> /etc/kubernetes/*.conf ~

根据集群部署时使用的 kubeadm-conf.yml 配置文件重新生成集群 kubeconfig 配置文件
$ <span class="token function">sudo</span> kubeadm init phase kubeconfig all <span class="token punctuation">\</span>
  --config /home/kiosk/kubeadm-config.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>更新完成后检查集群所有证书有效期：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>集群所有证书有效期延期 <span class="token number">1</span> 年
$ <span class="token function">sudo</span> kubeadm certs check-expiration
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul></li> <li><p>新生成的集群 <code>/etc/kubernetes/admin.conf</code> 配置文件嵌套新的证书</p></li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">7/21/2025, 9:04:26 PM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:0;" data-v-cb1513f6></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/blog/assets/js/app.b575e7ef.js" defer></script><script src="/blog/assets/js/3.b8613113.js" defer></script><script src="/blog/assets/js/1.d3bdaf35.js" defer></script><script src="/blog/assets/js/41.f6100517.js" defer></script>
  </body>
</html>
